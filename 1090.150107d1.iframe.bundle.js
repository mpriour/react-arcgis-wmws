(self.webpackChunkreact_arcgis_wmws=self.webpackChunkreact_arcgis_wmws||[]).push([[1090],{62546:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Z:()=>I3SOnDemandController});var tslib_es6=__webpack_require__(56140),has=__webpack_require__(95830),maybe=__webpack_require__(59472),Logger=__webpack_require__(36544),property=(__webpack_require__(68055),__webpack_require__(79881)),subclass=__webpack_require__(87566),urlUtils=__webpack_require__(10923),PooledArray=(__webpack_require__(57002),__webpack_require__(86035),__webpack_require__(62698)),promiseUtils=__webpack_require__(39105),Accessor=__webpack_require__(82677),core_Promise=__webpack_require__(75044),Handles=__webpack_require__(59691),watchUtils=__webpack_require__(80621),aaBoundingRect=__webpack_require__(50897),projection=__webpack_require__(28449),PromiseQueue=__webpack_require__(97873),Scheduler=__webpack_require__(35430),aaBoundingBox=__webpack_require__(69996),layerViewUtils=__webpack_require__(69829),dehydratedFeatures=__webpack_require__(45201),extentUtils=__webpack_require__(19143),support=__webpack_require__(78947),arrayUtils=__webpack_require__(19677);class s{constructor(t){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(Scheduler.iQ.I3S_CONTROLLER,(t=>this.update(t)),(()=>this.needsUpdate()))}destroy(){this.handle&&(this.handle.remove(),this.handle=null)}needsUpdate(){for(const t of this.callbacks)if(t.needsUpdate())return!0;return!1}update(t){this.sort();const e=this.callbacks,s={numIndexLoading:0,numNodesLoading:0};for(let r=0;r<e.length&&!t.done;++r)e[r].priority=e[r].update(t,s),this.runIndex=r}sort(){const t=this.callbacks;let e=t.length;for(let s=this.runIndex;s>0;s--){const r=t[s-1];let n=s;for(;n<t.length&&r.priority<=t[n].priority&&(n!==e||r.priority<t[n].priority);)t[n-1]=t[n],n++;t[n-1]=r,e=n-1}this.runIndex=0}add(t){this.sort(),t.priority=1/0,this.callbacks.unshift(t)}remove(e){(0,arrayUtils.e$)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}const r=new Map;function n(t,e){let n=r.get(t);return null==n&&(n=new s(t),r.set(t,n)),n.add(e),{remove:()=>{null!=n&&(n.remove(e),n.callbacks.length>0||(r.delete(t),n.destroy()),n=null)}}}var I3SUtil=__webpack_require__(83057),vec3=__webpack_require__(17387),vec4f64=__webpack_require__(38256),orientedBoundingBox=__webpack_require__(75625);class I3SNode_t{constructor(t,i){this.id=t,this.mbs=i,this.renderMbs=(0,vec4f64.f)([0,0,0,-1]),this.imModificationImpact=4,this.filterImpact=2}}class I3SNode_i extends I3SNode_t{constructor(s,t,i,e,h,o,r,c,n,a){super(s,i),this.index=t,this.childCount=e,this.level=h,this.resources=o,this.version=r,this.lodMetric=c,this.maxError=n,this.numFeatures=a,this.failed=!1,this.hasModifications=!1,this.cacheState=0,this.vertexCount=0,this.memory=0}}class I3SNode_e{constructor(s,t,i,e){this.nodeHasLOD=s,this.isChosen=t,this.lodLevel=i,this.version=e}}class c{constructor(e,t,i,s,r){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=r,this.useAsHole=0}}class g{constructor(e,t,i,r,n,o,a,d,l,h,u,c,g,m){this.streamDataController=i,this.viewportQueries=r,this.logger=n,this.holeFilling=o,this._isLoaded=a,this._isReloading=d,this._isSelected=l,this._enable=h,this._needsUpdate=u,this._canRequest=c,this._computeVisibilityObb=g,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=e=>e,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=v(0),this._visibilityCacheVersion=v(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new PooledArray.Z({deallocator:null}),this._prefetch=new PooledArray.Z({deallocator:null}),this._updates=new f,this._imModificationUncategorized=new PooledArray.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(t)}init(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=M}this.addPage(N(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new I3SNode_t(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}loadPage(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,"json").then((t=>{this._loading.delete(e),this.addPage(e,t)})).catch((t=>{this._loading.delete(e),(0,promiseUtils.D_)(t)||(this._failedPages.add(e),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${e}`,t))}))}addPage(e,t){for(let n=this._nodePages.length;n<e;n++)this._nodePages[n]=null;const i=[],s=[],r=t.nodes.map(((t,r)=>{const d=i.length,h=t.children?t.children.length:0;s.push(-1);for(let e=0;e<h;e++)i.push(t.children[e]);const u=`${t.index}`,g=(0,orientedBoundingBox.d9)(t.obb),m=(0,vec4f64.f)([g.center[0],g.center[1],g.center[2],(0,vec3.l)(g.halfSize)]),f=t.mesh&&t.mesh.attribute,_=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!_,attributes:f&&null!=f.resource?`${f.resource}`:null,geometry:_&&null!=_.resource?`${_.resource}`:null,texture:v&&null!=v.resource?`${v.resource}`:null,geometryDefinition:_?_.definition:-1,materialDefinition:v?v.definition:-1},y=new I3SNode_i(u,e*this.nodesPerPage+r,m,h,0,p,this.lastUpdate,this.lodMetric,this.lodConversion(t.lodThreshold),_?_.featureCount:null);return y.serviceObb=g,y.visibilityObb=this._computeVisibilityObb(y),y.vertexCount=_?_.vertexCount:0,new c(d,h,b(this._visibilityCacheVersion),null,y)}));this._nodePages[e]={nodes:r,children:i,parents:s},this.nodeCount+=r.length,this.updateParentsAndLevel()}updateParentsAndLevel(){const t=new Array,i=(i,s,r)=>{const n=this.getPage(i);if((0,maybe.pC)(n)){const o=x(i,this.nodesPerPage);n.parents[o]=s;const a=n.nodes[o].node;(0,maybe.pC)(a)&&(a.level=r,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){const s=t.pop(),r=this.getNode(s);if((0,maybe.pC)(r))for(let e=0;e<r.childCount;e++)i(this.getChildIndex(r,e),s,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}getPage(e){return this._nodePages[N(e,this.nodesPerPage)]}getNodeInternal(e){const i=this.getPage(e);return(0,maybe.Wi)(i)?null:i.nodes[x(e,this.nodesPerPage)]}addNode(t,s){null!=t.children&&this.populateChildren(s,t.children);const r=this.getParent(s),n=(0,maybe.pC)(r)?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,t.children?n+1:n);const{lodMetric:d,maxError:h}=function w(e){if(e)for(let t=0;t<e.length;t++)for(const i of I)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:0,maxError:0}}(t.lodSelection),u=(0,maybe.Wg)(this.getNodeInternal(s));return u.node=new I3SNode_i(t.id,s,(0,vec4f64.f)(t.mbs),u.childCount,n,t.resources,t.version,d,h,t.numFeatures),t.obb&&(u.node.serviceObb=(0,orientedBoundingBox.d9)(t.obb)),u.node.visibilityObb=this._computeVisibilityObb(u.node),(0,maybe.pC)(u.ref)&&(null==u.ref.mbs&&(u.ref.mbs=t.mbs),u.node.renderMbs=u.ref.renderMbs,u.node.serviceObbInRenderSR=u.ref.serviceObbInRenderSR,u.ref.visibilityObb=u.node.visibilityObb),u.node}makeRefNode(t,i){const s=this._nodePages[0],r=s.nodes.length;return s.nodes.push(new c(0,0,b(this._visibilityCacheVersion),t,null)),this.nodeCount++,s.parents.push(i),t.renderMbs[3]=-1,(0,maybe.pC)(t.serviceObbInRenderSR)&&(t.serviceObbInRenderSR.halfSize[0]=-1),r}populateChildren(e,t){const s=(0,maybe.Wg)(this.getNodeInternal(e)),r=(0,maybe.Wg)(this.getPage(e));s.childOffset=r.children.length,s.childCount=t.length;for(let i=0;i<t.length;i++){const s=this.makeRefNode(t[i],e);r.children.push(s)}}getNode(t){const i=this.getNodeInternal(t);return(0,maybe.pC)(i)?i.node:null}getIndexById(t){let i;return this.forAllNodes(((s,r)=>{((0,maybe.pC)(s.node)&&s.node.id===t||(0,maybe.pC)(s.ref)&&s.ref.id===t)&&(i=r)})),i}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,i){const s=this.getPage(e.index);if((0,maybe.Wi)(s))return-1;const r=s.nodes[x(e.index,this.nodesPerPage)];return s.children[r.childOffset+i]}getParentIndex(t){const i=this.getPage(t);return(0,maybe.pC)(i)?i.parents[x(t,this.nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(t){const i=this.getNodeInternal(t);return(0,maybe.pC)(i)&&0===i.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}invalidateVisibilityCache(){this._visibilityCacheVersion=v(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(t){const i=this.getNodeInternal(t);(0,maybe.pC)(i)&&this.invalidateNodeVisibilityCacheInternal(i)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=b(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(t){const i=this.getNodeInternal(t);(0,maybe.pC)(i)&&(_(i),this.invalidateNodeVisibilityCacheInternal(i))}invalidateGeometryVisibility(t){const i=this.getNodeInternal(t);(0,maybe.pC)(i)&&(0,maybe.pC)(i.node)&&(i.node.geometryObb=null,i.node.renderMbs[3]=-1,(0,maybe.pC)(i.node.serviceObbInRenderSR)&&(i.node.serviceObbInRenderSR.halfSize[0]=-1))}invalidateVisibilityObbs(){(0,maybe.Wi)(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))}isNodeVisible(i){const s=this.getNodeInternal(i);if((0,maybe.Wi)(s)||(0,maybe.pC)(s.ref)&&!s.ref.mbs)return!0;if(!y(s.visibilityCache,this._visibilityCacheVersion)){const i=s.node,r=(0,maybe.pC)(i)&&((0,maybe.Wi)(s.ref)||(0,maybe.pC)(i.visibilityObb))?i:(0,maybe.pC)(s.ref)?s.ref:null;this._layerHasFilter&&this._computeNodeFiltering&&(0,maybe.pC)(i)&&2===i.filterImpact&&this._computeNodeFiltering(i);const n=(0,maybe.pC)(i)&&1===i.filterImpact,o=!((0,maybe.pC)(i)&&2===i.imModificationImpact)&&(!r||this.viewportQueries.isNodeVisible(r))&&!n;return s.visibilityCache=p(o,this._visibilityCacheVersion),o}return P(s.visibilityCache)}isGeometryVisible(t){if(!this.isNodeVisible(t))return!1;const i=this.getNodeInternal(t);return!((0,maybe.pC)(i)&&(0,maybe.pC)(i.node)&&(0,maybe.pC)(i.node.geometryObb)&&(!this.layerHasModifications||4!==i.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(s,r,n,o,a){const d=this.getPage(s);if((0,maybe.Wi)(d)||0===r.childCount)return;const l=r.childOffset+r.childCount,h=new Array;for(let t=r.childOffset;t<l;++t){const i=d.children[t],s=this.getNodeInternal(i);(0,maybe.pC)(s)&&(0,maybe.pC)(s.node)&&this.isGeometryVisible(i)&&h.push(s)}o/=h.length;for(const e of h){const t=(0,maybe.Wg)(e.node).index;this._isLoaded(t)||this._isReloading(t)?(a.delta=Math.max(a.delta,n),a.coverage+=o):this._traverseCoverage(t,e,n+1,o,a)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const i=this.getNodeInternal(e);if((0,maybe.Wi)(i))return!1;if("always"===this.holeFilling)return!0;if(y(i.useAsHole,this._version))return P(i.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,i,0,1,s);const r=s.delta*s.coverage<=.5;return i.useAsHole=p(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=v(this._version)}imModificationsChanged(t){this.layerHasModifications=t,this.forAllNodes((({node:t})=>{(0,maybe.pC)(t)&&(t.imModificationImpact=4,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}layerFilterChanged(t){this._layerHasFilter=t,this.forAllNodes((({node:t})=>{(0,maybe.pC)(t)&&(t.filterImpact=2,this.invalidateNodeVisibilityCache(t.index),t.visibilityObb=this._computeVisibilityObb(t),this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}update(s,r,n){if(!this._dirty)return;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(s,this._missing),m.clear();let o=!0;const a=new C,d=new C,l=this._imModificationUncategorized;l.clear();const h=new Set;this.traverseVisible(((u,c,g)=>{if((0,maybe.Wi)(c)){let e=this.entryPriority(u);e===1/0&&(e=this.entryPriority(g));const t=N(u,this.nodesPerPage);return m.set(t,Math.max(e,m.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=c.node;if(this._updateNodeFeatureEstimate(f,d),(0,maybe.Wi)(f)){const e=this.entryPriority(u);return this._loading.has(u)||this._failedNodes.has(u)||(this._missing.push(u),m.set(u,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const _=(0,maybe.Wg)(this.getPage(u));if(0===this._missing.length&&0===this.nodesPerPage)for(let t=0;t<c.childCount;t++){const i=_.children[c.childOffset+t],s=this.getNodeInternal(i);!(0,maybe.pC)(s)||s.node||this._loading.has(i)||this._failedNodes.has(i)||(m.set(i,this.entryPriority(i)),this._prefetch.push(i))}if(f.failed||!f.resources.hasFeatureData)return;if(h.add(f.id),this._isLoaded(u)){if(a.known+=f.memory,++a.knownNodes,this._isSelected(f)?c.childCount>0&&(o=!1):(a.unremoved+=f.memory,o=!1),this._needsUpdate(f)){const e=this.entryPriority(u);m.set(u,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(u)}return}if(f.memory&&(a.known+=f.memory,++a.knownNodes),!this._isSelected(f))return void(this._isReloading(u)&&this._updates.remove.push(u));if(c.childCount>0&&(o=!1),f.memory?(a.missing+=f.memory,a.known+=f.memory,++a.knownNodes):++a.missingNodes,s.indexOf(f.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(u)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==f.index)));if(!r.done&&this._enable(f))return void r.madeProgress();const b=this.entryPriority(u);m.set(u,b),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,b),this._updates.add.push(u),this.layerHasModifications&&n&&(0,maybe.pC)(f)&&4===f.imModificationImpact&&l.push(u)}));const c=this._updates.add;c.length>0&&this.layerHasModifications&&(l.length>0&&n(l),c.filterInPlace((e=>{const i=this.getNodeInternal(e),s=(0,maybe.Wi)(i)||(0,maybe.Wi)(i.node)||2!==i.node.imModificationImpact;return s||this.invalidateNodeVisibilityCache(e),s}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=o,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>m.get(e)-m.get(t))),this._missing.length>0?(this._maxUnloadedPrio=m.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(((e,t)=>m.get(e)-m.get(t))),this._updates.add.filterInPlace((e=>m.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>m.get(e)-m.get(t))),this._updates.update.sort(((e,t)=>m.get(e)-m.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,m.clear()}checkFeatureTarget(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let s=t,r=t,n=i,o=10;for(;o--;){const i=new C;if(this._updateFeatureEstimate(s,i),this._computeFeatureEstimate(i)<=e){if(s>=t||i.missingNodes>0||0===o)break;n=s,s=.5*(s+r)}else r=s,s=.5*(s+n)}return this._version=v(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)}_updateFeatureEstimate(t,i){this._version=v(this._version),this.viewportQueries.updateScreenSpaceErrorBias(t),this.traverseVisible(((t,s)=>this._updateNodeFeatureEstimate((0,maybe.pC)(s)&&s.node,i)))}_updateNodeFeatureEstimate(i,s){if(!((0,maybe.Wi)(i)||i.failed||(0,maybe.Wi)(i.numFeatures)))return this._isLoaded(i.index)?(s.known+=i.numFeatures,++s.knownNodes,void(this._isSelected(i)||(s.unremoved+=i.numFeatures))):void(this._isSelected(i)&&((0,maybe.pC)(i.numFeatures)?(s.missing+=i.numFeatures,s.known+=i.numFeatures,++s.knownNodes):++s.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(e){if((0,maybe.Wi)(e))return null;let i=this._nodeTraversalState.get(e.index);if(i&&y(i.version,this._version))return i;const s=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e);let n=!0;if(r){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);n=e&&s>e.lodLevel}else n=s>0}else n=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=n,i.version=p(!0,this._version),i):(i=new I3SNode_e(r,n,s,p(!0,this._version)),this._nodeTraversalState.set(e.index,i),i)}_loadNode(e){this._loading.add(e);const s=(0,maybe.Wg)(this.getNodeInternal(e)).ref;if((0,maybe.Wi)(s))return void this._failedNodes.add(e);const n=s.id,o=this.urlPrefix+n,a=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(o,"json").then((t=>{a();const i=this._validateNode(n,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const s=this.addNode(i,e);this.nodeTraversalState(s)}),(t=>{a(),(0,promiseUtils.D_)(t)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+o),this._failedNodes.add(e))}))}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,n=Array.isArray(t.children)?t.children.map((t=>{if(null==t)return null;const i=t=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${e}"`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=new I3SNode_t(`${t.id}`,t.mbs);return r.serviceObb=s,r.visibilityObb=this._computeVisibilityObb(r),r})).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:n,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:s}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((t=>{(0,maybe.pC)(t.node)&&(t.node.failed=!1)}))}entryPriority(i){const s=this.getNodeInternal(i),r=this.getParentIndex(i);if((0,maybe.Wi)(s)||r<0&&null==s.node)return r<0?1/0:this.entryPriority(r);let n=0;if(s.node&&r>=0){const e=this._nodeTraversalState.get(r);null!=e&&(n=e.lodLevel)}let o=this.progressiveLoadPenalty;for(let e=i;e>=0;e=this.getParentIndex(e))if(this._isLoaded(e)){o=0;break}const a=(0,maybe.pC)(s.ref)?this.viewportQueries.distToPOI(s.ref):(0,maybe.pC)(s.node)?this.viewportQueries.distToPOI(s.node):0;return-a-n*(a+this.progressiveLoadPenalty)+o}traverseVisible(e){const i=this.getNodeInternal(this.rootIndex);(0,maybe.Wi)(i)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,i,e)}_traverseVisible(t,s,r,n){if(r.node&&0===r.childCount)return void(this.isGeometryVisible(t)&&n(t,r,s));if(!this.isNodeVisible(t))return;if(n(t,r,s),null==r.node)return;const o=this.nodeTraversalState(r.node);if(o.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=(0,maybe.Wg)(this.getPage(t));for(let i=0;i<r.childCount;i++){const s=a.children[r.childOffset+i],o=this.getNodeInternal(s);(0,maybe.pC)(o)?this._traverseVisible(s,t,o,n):n(s,null,t)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(t,i){const s=t.index,r=this.getNodeInternal(s);(0,maybe.pC)(r)&&this._traverseChildren(s,r,i)}_traverseChildren(i,s,r){const n=this.getPage(i);if((0,maybe.Wi)(n))return;const o=s.childOffset+s.childCount;for(let t=s.childOffset;t<o;++t){const i=n.children[t],s=this.getNodeInternal(i);(0,maybe.pC)(s)&&(0,maybe.pC)(s.node)&&r(s.node)&&this._traverseChildren(i,s,r)}}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(e){this.forAllNodes(_),this.viewportQueries.updateElevationInfo(e)}forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const s=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],s+t)}}}get test(){return{addNode:(e,t)=>this.addNode(e,t)}}}const m=new Map;class f{constructor(){this.update=new PooledArray.Z({deallocator:null}),this.add=new PooledArray.Z({deallocator:null}),this.remove=new PooledArray.Z({deallocator:null}),this.cancel=[]}reset(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}function _(t){(0,maybe.pC)(t.node)&&(t.node.renderMbs[3]=-1,(0,maybe.pC)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1)),(0,maybe.pC)(t.ref)&&(t.ref.renderMbs[3]=-1,(0,maybe.pC)(t.ref.serviceObbInRenderSR)&&(t.ref.serviceObbInRenderSR.halfSize[0]=-1))}function b(e){return(0,I3SUtil.HV)(e,-2)}function v(e){return(0,I3SUtil.HV)(e,2)}function p(e,t){return t+(e?1:0)}function y(e,t){return(-2&e)===t}function P(e){return 1==(1&e)}function N(e,t){return 0===t?0:e/t|0}function x(e,t){return 0===t?e:e%t}const I=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];class C{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function M(e){return Math.sqrt(e*(4/Math.PI))}const t=new PooledArray.Z({deallocator:null}),I3SLodHandling=class I3SLodHandling_s{constructor(e){this.layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,i,o,s){this._maxLodLevel=s.maxLodLevel,this._index=o,this._isNodeInScaleBounds=e,this._removeNodes=i}shouldLoadNode(i){if((0,maybe.Wi)(i))return!1;const o=this._index.nodeTraversalState(i);return!!this.isChosenMaxLOD(o)||!!o.isChosen&&this._childrenRequireLoading(i)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,o=Math.max(0,Math.floor(10*(i-1)));t.clear(),this._lodGlobalHandling(this._index.rootNode,o,!1);const s=t.length;this._removeNodes(t,e);const d=t.length<s;return 0!==t.length&&(this._lodGlobalDirty=!0),t.clear(),d}_lodGlobalHandling(o,s,d){if((0,maybe.Wi)(o))return!1;const l=o.index,n=this._index,r=this.layerView,a=n.nodeTraversalState(o),h=this.isChosenMaxLOD(a),u=r.isNodeLoaded(l),c=r.nodeCrossfadingEnabled;if(c&&u&&h){const e=!d&&this.hasNoVisibleChildren(o);r.fadeNode(l,0,!e)}const x=u&&(!r.isNodeFullyFadedIn||r.isNodeFullyFadedIn(l));if(u&&(r.updateNodeState(l,h?1:0),h))return x&&this._removeChildrenRecursive(o),x;const _=o.childCount>0;let L=_;if(_)for(let e=0;e<o.childCount;e++){const t=n.getChildIndex(o,e),l=n.getNode(t);(0,maybe.pC)(l)?n.isGeometryVisible(t)&&!this._lodGlobalHandling(l,s,d||x)&&this._isNodeInScaleBounds(l)&&(L=!1):n.isNodeVisible(t)&&(L=!1)}const N=u&&!h&&(L||t.length<s);N&&t.push(l),!c||N||!u||d||L||r.fadeNode(l,0,!1);const b=!o.resources.hasFeatureData;return L||x&&!N||b}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&t.push(e.index),!0)))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index)||this.layerView.isNodeLoaded(e.index)&&(i=!1,1)))),i}_childrenRequireLoading(e){let i=!1,o=!0;return this._index.traverseChildren(e,(e=>{if(!o||!this._index.isNodeVisible(e.index))return!1;const s=this._index.nodeTraversalState(e);return this.isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(i=!0),!this.layerView.isNodeLoaded(e.index)||(o=!1,!1)})),o&&i}isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}};var lang=__webpack_require__(82550),asyncUtils=__webpack_require__(59351),I3SBinaryReader=__webpack_require__(34947),mathUtils=__webpack_require__(33655),AlphaDiscard_glsl=__webpack_require__(34658),PhysicallyBasedRenderingParameters_glsl=__webpack_require__(44624),Texture=__webpack_require__(43446);function I3SMaterialUtil_s(o,r){const t=new Map,s=(e,o)=>{if((0,maybe.Wi)(e))return-1;if(t.has(e.id)){const a=t.get(e.id);return a.usage|=o,a.id}const r=t.size;return t.set(e.id,{id:r,usage:o}),r},c=r.pbrMetallicRoughness,u=c&&c.baseColorFactor,d=r.emissiveFactor,m=null==r.normalTexture&&null==r.emissiveTexture&&null==r.occlusionTexture&&(!c||null==c.metallicRoughnessTexture&&1===c.roughnessFactor&&(1===c.metallicFactor||0===c.metallicFactor)),g=m?PhysicallyBasedRenderingParameters_glsl.F[0]:c?c.metallicFactor:1,p=m?PhysicallyBasedRenderingParameters_glsl.F[1]:c?c.roughnessFactor:1,h="mask"===r.alphaMode?33:1,f={baseColorFactor:u?[u[0],u[1],u[2],u[3]]:[1,1,1,1],baseColorTextureId:s(c&&c.baseColorTexture,h),metallicRoughnessTextureId:s(c&&c.metallicRoughnessTexture,2),metallicFactor:g,roughnessFactor:p},b={alphaMode:r.alphaMode,alphaCutoff:r.alphaCutoff,doubleSided:r.doubleSided,cullFace:"none"===r.cullFace?0:"back"===r.cullFace?2:"front"===r.cullFace?1:void 0,normalTextureId:s(r.normalTexture,4),emissiveTextureId:s(r.emissiveTexture,16),occlusionTextureId:s(r.occlusionTexture,8),emissiveFactor:d?[d[0],d[1],d[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:m},x=[];return t.forEach((({usage:a},r)=>{const l=(0,maybe.pC)(o)&&o[r]&&o[r].formats,t=l?i(l.map((({name:e,format:a})=>({name:e,encoding:I3SMaterialUtil_n[a]})))):[];x.push({id:r,usage:a,encodings:t})})),{material:b,textures:x}}function i(e){return e.sort(((e,a)=>e.encoding-a.encoding))}const I3SMaterialUtil_n={basis:1,dds:2,png:4,jpg:8,"ktx-etc2":16},I3SMaterialUtil_c={[Texture.x.BASIS_ENCODING]:1,[Texture.x.DDS_ENCODING]:2,"image/png":4,"image/jpg":8,"image/jpeg":8,"image/ktx":16};function u(e){const a=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,l=a&&e.materialDefinitions[a],t=r&&e.textureDefinitions[r],s=d();if(null!=l){const e=l.params;e.diffuse&&(s.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(s.doubleSided=e.doubleSided,s.cullFace=e.doubleSided?0:2),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(s.cullFace="none"===e.cullFace?0:"back"===e.cullFace?2:1),e.transparency&&(s.metallicRoughness.baseColorFactor[3]=(0,mathUtils.uZ)(1-e.transparency,0,1)),(e.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}const n=[];if(null!=t){const e=0;!t.wrap||"repeat"!==t.wrap[0]&&"repeat"!==t.wrap[1]||(s.wrapTextures=!0);let a=1;"rgba"===t.channels&&(s.alphaMode="blend",a|=32);const o=t.images.length-1,r=t.images[o],l=e=>e&&e.split("/").pop(),u=Array.isArray(t.encoding)?i(t.encoding.map(((e,a)=>({name:l(r.href[a]),encoding:I3SMaterialUtil_c[e]||0})))):[{name:l(r.href),encoding:I3SMaterialUtil_c[t.encoding]||0}];n.push({id:e,usage:a,encodings:u}),s.metallicRoughness.baseColorTextureId=e}return{material:s,textures:n}}const d=()=>({alphaMode:"opaque",alphaCutoff:AlphaDiscard_glsl.F,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});class h{constructor(e,t,r,i,o,n){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=o,this.options=n,this.logLayer=e,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const t=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((e=>I3SMaterialUtil_s(t,e)))}}load(e,t,r){return this.streamDataController.request(e,t,{signal:r})}loadAttribute(e,t,r){const i=`${this.layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`;return this.load(i,"binary",r).then((e=>(0,I3SBinaryReader.qM)(t,e)))}loadAttributes(e,t,r){return(0,promiseUtils.as)(t.map((t=>this.loadAttribute(e,t.attributeStorageInfo,r)))).then((r=>{const i={};for(let o=0;o<t.length;++o)if(r[o].value)i[t[o].name]=r[o].value;else{if((0,promiseUtils.D_)(r[o].error))throw r[o].error;this.logger.error("#loadAttributes",this.logLayer,`Failed to load attributeData for '${t[o].name}' on node '${e.id}'`,r[o].error)}return i}))}async loadNodeData(e,t){const o=null!=this.requiredAttributes&&e.resources.attributes?(0,asyncUtils.q6)(this.loadAttributes(e,this.requiredAttributes,t)):null,{bufferDefinition:n,bufferIndex:s}=function I3SNodeLoader_x(t,r){const i={bufferDefinition:null,bufferIndex:0};if(null==t||r.resources.geometryDefinition<0)return i;const o=r.resources.geometryDefinition>=0?t[r.resources.geometryDefinition].geometryBuffers:null;if(null==o)return i;for(let n=0;n<o.length;n++){const t=o[n];if(null==t.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=o[n];else if("draco"===t.compressedAttributes.encoding&&!(0,has.Z)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=t,i}return i}(this.geometryDefinitions,e),l=!!e.resources.geometry,d=l?(0,asyncUtils.q6)(this.loadGeometry(e.resources.geometry,s,t)):null,c=e.resources.hasSharedResource?await this.loadShared(e,t):null,h=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=c?u(c):null,p=h&&h.material,A=h&&h.textures,$=`${e.id}`,j=!l&&this.options.loadFeatureData,T=j?await this.loadFeatureData($,t):null,w=j?function I3SNodeLoader_y(e){for(const t of e.featureData){const e=t.geometries;if(null!=e)for(const r of e)return{featureIds:[t.id],featureDataPosition:t.position,geometries:[r]}}return null}(T):function I3SNodeLoader_g(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(p),I=(0,maybe.Wi)(w)&&function I3SNodeLoader_b(e){const t=new Array;for(const r of e.featureData)null!=r.position&&t.push({featureIds:[r.id],featureDataPosition:r.position,geometries:null});return t}(T),U=null!=A&&A.length>0?(0,asyncUtils.q6)(this.loadTextures(e,A,t)):null;let S=null,q=null;if(d){S=(0,asyncUtils.w6)(await d);const e=function D(e,r){if(!e||!r||!r.materialDefinitions)return e;const i=Object.keys(r.materialDefinitions)[0];return!r.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,lang.d9)(e)).vertexAttributes.region,e}(this.defaultGeometrySchema,c);q=(0,I3SBinaryReader.Es)(n,e)}const v=U?(0,asyncUtils.w6)(await U):null,P=o?(0,asyncUtils.w6)(await o):{},k=P?{attributeData:P,loadedAttributes:this.requiredAttributes}:null;return(0,maybe.pC)(w)?{geometryData:w,attributeDataInfo:k,geometryBuffer:S,geometryDescriptor:q,requiredTextures:A,textureData:v}:(0,maybe.pC)(I)?{pointData:I,attributeDataInfo:k,geometryBuffer:S,geometryDescriptor:q,requiredTextures:A,textureData:v}:Promise.reject()}static addAbsoluteHrefTexture(e,t){const r=e.textureDefinitions;if(null!=r)for(const i of Object.keys(r))for(const e of r[i].images)Array.isArray(e.href)?e.hrefConcat=e.href.map((e=>(0,urlUtils.hF)(e,t))):e.hrefConcat=(0,urlUtils.hF)(e.href,t)}static fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const r in t){const e=t[r];if(Array.isArray(e.encoding))for(let t=0;t<e.encoding.length;t++){const r=e.encoding[t];"data:"===r.substring(0,5)&&(e.encoding[t]=r.substring(5))}else{const t=e.encoding;"data:"===t.substring(0,5)&&(e.encoding=t.substring(5))}}}loadShared(e,t){const r=`${this.layerUrl}/nodes/${e.resources.geometry}/shared`;return this.load(r,"json",t).then((e=>(h.fixTextureEncodings(e),h.addAbsoluteHrefTexture(e,r),e)))}loadTexture(e,t,r,i,o,n){return 2===o||1===o?this.load(e,"binary",n).then((e=>({id:t,usage:r,data:e,encoding:o}))):this.load(e,"image",n).then((e=>{let n=e;if(i&&e.width*e.height>=4096){const t=Math.ceil(e.width/2),r=Math.ceil(e.height/2),i=document.createElement("canvas");i.width=t,i.height=r,i.getContext("2d").drawImage(e,0,0,t,r),n=i}return{id:t,usage:r,data:n,encoding:o}}))}loadTextures(e,t,r){const i=this.options.uncompressedTextureDownsamplingEnabled,o=this.options.textureUsageMask;return Promise.all(t.map((t=>{if(0==(t.usage&o))return null;const n=(0,I3SUtil.nn)(t.encodings,this.options.textureEncodings);if(null==n)return this.logger.error("#loadTextures",this.logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject();const s=e.resources.texture||e.id,a=`${this.layerUrl}/nodes/${s}/textures/${n.name}`;return this.loadTexture(a,t.id,t.usage,i,n.encoding,r)})))}loadFeatureData(e,t){const r=`${this.layerUrl}/nodes/${e}/features/0`;return this.load(r,"json",t)}loadGeometry(e,t,r){const i=`${this.layerUrl}/nodes/${e}/geometries/${t}`;return this.load(i,"binary",r)}}const I3SNodeLoader=h;class I3SStreamDataController_s{constructor(e){this.requester=e,this.activeRequests=new Set}get busy(){return this.requester.busy}request(s,l,o){const a=(0,promiseUtils.yi)(),n=(0,promiseUtils.$F)(o,(()=>a.abort()));o={...o,signal:a.signal};const u=this.requester.request(s,l,o),i={response:u,abortController:a,abortHandle:n};return this.activeRequests.add(i),(0,promiseUtils.Bx)(u,(()=>{var e;i.abortController=null,null==(e=i.abortHandle)||e.remove(),i.abortHandle=null,this.activeRequests.delete(i)})),u}cancelAll(){this.activeRequests.forEach((e=>{var t,r;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(r=e.abortHandle)||r.remove()})),this.activeRequests.clear()}}var vec3f64=__webpack_require__(77625),projectionEllipsoid=__webpack_require__(89333),vec4=__webpack_require__(34353),geometryUtils=__webpack_require__(94483),elevationAlignmentUtils=__webpack_require__(81718),featureExpressionInfoUtils=__webpack_require__(29087),ElevationContext=__webpack_require__(19974);const R=1e5;const I3SViewportQueries=class S{constructor(t,e,i,r,n,a,o,h,c={}){this.indexSR=t,this._renderCoordsHelper=e,this.extent=a,this.elevationProvider=o,this.options=c,this._frustum=geometryUtils.oy.create(),this._fixedCOI=!1,this._poi=(0,vec3f64.c)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=(0,vec3f64.c)(),this._tmp2=(0,vec3f64.c)(),this._tmp3=(0,vec3f64.c)(),this._tmp0=(0,vec3f64.c)(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i,r,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(h),this.tmpPoint=(0,dehydratedFeatures.Tx)(0,0,0,t)}updateElevationInfo(t){null!=t?(this._elevationContext=ElevationContext.o.fromElevationInfo(t),this._elevationContext.updateFeatureExpressionInfoContext((0,featureExpressionInfoUtils.bw)((0,featureExpressionInfoUtils.WI)(t,!1)))):this._elevationContext=null}updateCamera(t,e,s){this._fixedCOI=s,s||geometryUtils.oy.fromMatrix(t.viewMatrix,t.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(t){this._poi=t}updateScreenSpaceErrorBias(t){const e=this.screenspaceErrorBias;return this.screenspaceErrorBias=t,e}updateExtent(t){this.extent=t}getRenderMbs(t){const e=t.renderMbs;return e[3]<0&&((0,vec4.c)(e,t.mbs),this._elevationContext&&e[3]<R&&(this.tmpPoint.x=e[0],this.tmpPoint.y=e[1],this.tmpPoint.z=e[2],e[2]=(0,elevationAlignmentUtils.w7)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,projection.st)(e,this.indexSR,e,this.engineSR)),e}getVisibilityObb(s){if((0,maybe.pC)(s.visibilityObb))return s.visibilityObb;const i=s.serviceObb;return(0,maybe.Wi)(i)||i.halfSize[0]<0?void 0:(s.serviceObbInRenderSR=this._computeRenderObb(i,s.serviceObbInRenderSR,s.mbs[3]),s.serviceObbInRenderSR)}_computeRenderObb(t,s,i){if((0,maybe.Wi)(s)&&(s=(0,orientedBoundingBox.Ue)()),s.halfSize[0]<0){let e=0;this._elevationContext&&i<R&&(this.tmpPoint.x=t.center[0],this.tmpPoint.y=t.center[1],this.tmpPoint.z=t.center[2],e=(0,elevationAlignmentUtils.w7)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),(0,I3SUtil.jv)(t,this.indexSR,s,this.engineSR,e)}return s}isNodeVisible(e){const s=this.getRenderMbs(e);if(!this.isMBSinExtent(s))return!1;if(this._fixedCOI)return!0;const i=this.getVisibilityObb(e);return(0,maybe.pC)(i)?(0,orientedBoundingBox.pn)(i,this._frustum):geometryUtils.oy.intersectsSphere(this._frustum,geometryUtils.Dv.wrap(s))}isGeometryVisible(e){if(this._fixedCOI)return!0;const s=e.geometryObb;return(0,maybe.pC)(s)?(0,orientedBoundingBox.pn)(s,this._frustum):this.isNodeVisible(e)}isMBSinExtent(t){return!this.extent||0!==(0,I3SUtil.lj)(this.extent,t)}screenSpaceDiameterMbs(t,e){const s=this.getRenderMbs(t),r=Math.sqrt((0,vec3.h)(s,this._camPos)),n=r-s[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:e/n*this._screenSizeFactor}calcCameraDistance(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]}calcCameraDistanceToCenter(t){const e=this.getRenderMbs(t),s=(0,vec3.k)(e,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(t){const e=this.getRenderMbs(t),s=e[3],i=(Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/(0,vec3.l)(e)+s)/(0,vec3.k)(e,this._camPos);return Math.min(1,i)}hasLOD(t){return 0!==t.lodMetric}getDistancePlanarMode(t,e){const s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=s*s+i*i,a=e[3];if(n<=a*a)return Math.abs(r);const o=Math.sqrt(n)-a;return Math.sqrt(r*r+o*o)}getDistanceGlobeMode(t,e){const s=(0,vec3.l)(e),p=(0,vec3.l)(t)-s;(0,vec3.a)(this._tmp0,t,(0,vec3.d)(t,e)/(0,vec3.o)(t));const d=(0,vec3.h)(e,this._tmp0),u=e[3];if(d<=u*u)return Math.abs(p);{const i=(0,vec3.a)(this._tmp0,e,1/s),h=s,d=u*u/2/h,l=(0,vec3.a)(this._tmp1,i,h-d),_=t,x=(0,vec3.f)(this._tmp2,_,l),b=(0,vec3.f)(this._tmp2,x,(0,vec3.a)(this._tmp3,i,(0,vec3.d)(i,x))),f=(0,vec3.b)(this._tmp2,l,(0,vec3.a)(this._tmp2,b,u/(0,vec3.l)(b)));let M=(0,vec3.k)(_,f);if(p>=2e5){const t=(0,vec3.f)(this._tmp1,_,f);let e=(0,vec3.d)(t,i)/(0,vec3.l)(t);e<.08&&(e=1e-4),M/=e}return M}}getDistance(t,e){return this.engineSR===(0,projectionEllipsoid.rS)(this.engineSR)?this.getDistanceGlobeMode(t,e):this.getDistancePlanarMode(t,e)}_updateMinMaxDistance(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))}getLodLevel(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(!this._fixedCOI&&this.progressiveLoadFactor<1){const e=this.progressiveLoadFactor*this.screenspaceErrorBias,s=this.screenspaceErrorBias;return this.evaluateLODmetric(t,e)?this.evaluateLODmetric(t,s)?2:1:0}return this.evaluateLODmetric(t,this.screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(t,e){switch(t.lodMetric){case 2:{const s=this.getRenderMbs(t),i=this.getDistance(this._camPos,s),r=2*i/this._screenSizeFactor,n=i+s[3];return this._updateMinMaxDistance(n),t.maxError*e<=r}case 1:{let s=this.screenSpaceDiameterMbs(t,t.mbs[3]*e);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(t)),s<t.maxError}case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*e<10;case 4:return this.calcCameraDistance(t)>t.maxError*e}return!1}distToPOI(t){const e=this.getRenderMbs(t);return(0,vec3.k)(e,this._poi)-e[3]}distCameraToPOI(){return(0,vec3.k)(this._camPos,this._poi)}},O=Logger.Z.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),G=1e-4;let E=class extends((0,core_Promise.v)(Accessor.Z)){constructor(e){super(e),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new PooledArray.Z({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new PooledArray.Z,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new Handles.Z,this._idleQueue=new PromiseQueue.Z,this._elevationUpdateNodes=new PooledArray.Z({deallocator:null}),this._errorCount=0}get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}get isGraphics3D(){return"points"===this.layer.profile}get indexStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(2);return new I3SStreamDataController_s(e)}get dataStreamController(){const e=this.layerView.view.resourceController.createStreamDataRequester(3);return new I3SStreamDataController_s(e)}get crsVertex(){return(0,I3SUtil.T2)(this.layer)}get crsIndex(){return(0,I3SUtil.tp)(this.layer)}get rootNodeVisible(){if((0,maybe.pC)(this._index)){const e=this._index.rootNode;if((0,maybe.pC)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}initialize(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new I3SLodHandling(this.layerView);const e=this.layerView.i3slayer;this.layer=e,this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=(0,has.Z)("disable-feature:idb-cache"),"fields"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((([t])=>{if(this.destroyed||!this.layerView||this.layerView.destroyed)return;const s=this.layerView.view;this._setClippingArea(s.clippingArea);const a=this.layerView.view.resourceController;this._handles.add([(0,watchUtils.S1)(s,"pointsOfInterest.focus.renderLocation",(e=>this._pointOfInterestChanged(e))),a.memoryController.events.on("quality-changed",(()=>this._setCameraDirty())),(0,watchUtils.S1)(this.layerView,"suspended",(e=>{const t=e?()=>this._updateViewData():()=>this._updateIdleState(!0),i=e?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(e&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=t,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=a.scheduler.registerIdleStateCallbacks(t,i)})),n(this.layerView.view.resourceController.scheduler,{update:(e,t)=>this._frame(e,t),needsUpdate:()=>this.updating}),this.watch("uncompressedTextureDownsamplingEnabled",(()=>this.restartNodeLoading())),this.watch(["featureTarget","fixedFeatureTarget"],(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),s.state.watch("camera",(()=>this._setCameraDirty())),s.state.watch("contentCamera",(()=>this._setCameraDirty())),this.layer.watch("elevationInfo",(()=>this._elevationInfoChanged())),this.layer.watch(["minScale","maxScale"],(()=>this._scaleBoundsChanged())),this.layerView.watch("lodFactor",(()=>this._setCameraDirty())),this.layerView.watch("availableFields?",(()=>this._requiredFieldsChange())),this.layerView.watch("holeFilling",(e=>(0,maybe.pC)(this._index)&&(this._index.holeFilling=e)))]),this._updateScaleHandles(),this._viewportQueries=new I3SViewportQueries(this.crsIndex,s.renderCoordsHelper,s.state.camera,s.state.contentCamera,s.state.fixedContentCamera,this._clippingArea,s.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:this.lod<.5}),this._index=new g(e,t,this.indexStreamController,this._viewportQueries,O,this.layerView.holeFilling,(e=>this.layerView.isNodeLoaded(e)),(e=>this.layerView.isNodeReloading(e)),(e=>this._shouldLoadNode(e)),(e=>this._enableFromGPUCache(e,1)),(e=>this._needsUpdate(e)),(()=>!this.indexStreamController.busy),(e=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(e):null),(e=>this.layerView.computeNodeFiltering(e)));const r=(0,maybe.pC)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(r),this._startNodeLoading()}))),this._tmpPoint=(0,dehydratedFeatures.Tx)(0,0,0,this.crsIndex)}updateNodeModificationStatus(e){const t=this._index,s=this.layerView;(0,maybe.pC)(t)&&s&&s.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((e=>{const s=t.getNode(e);(0,maybe.pC)(s)&&this._modificationsNodeFilteringArray.push(s)})),s.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,H.prune(),(0,maybe.pC)(k)&&(k.remove(),k=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const s=z(e,i),a=z(t,i);return s>=0&&a>=0?{index:s,name:t[a].name,field:t[a],attributeStorageInfo:e[s]}:null})).filter((e=>null!=e&&e.name!==i))}_requiredFieldsChange(){const e=this._getRequiredAttributes();I3SOnDemandController_R(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(e){const t=(0,aaBoundingBox.Ue)();(0,extentUtils.O)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}_pointOfInterestChanged(e){(0,maybe.pC)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),(0,maybe.pC)(this._index)&&(this._index.progressiveLoadPenalty=$.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(e){this._setClippingArea(e),(0,maybe.pC)(this._viewportQueries)&&(0,maybe.pC)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(e,t){const i=this._index;if((0,maybe.Wi)(i))return;const a=i.rootNode;if((0,maybe.Wi)(a))return;const r=this._elevationUpdateNodes;r.clear(),(0,I3SUtil.tS)(e,t,a,this.crsIndex,i,(e=>r.push(e.index))),r.forAll((e=>{i.invalidateBoundingVolumeCache(e),e===a.index&&this.notifyChange("rootNodeVisible")})),r.length&&this.restartNodeLoading()}getParentIndex(e){return(0,maybe.pC)(this._index)&&this._index.getParentIndex(e)}_elevationInfoChanged(){(0,maybe.pC)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}_updateScaleHandles(){const e="scale-bounds";this._handles.remove(e),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),e)}_scaleBoundsChanged(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(e,t,a){const r=this._index;if((0,maybe.Wi)(r))return;const d=r.rootNode;!(0,maybe.Wi)(d)&&(0,projection.dH)(t,a,J,this.crsIndex)&&this._loadedNodeScales.forEach(((t,s)=>{const a=r.getNode(s);(0,maybe.pC)(a)&&(0,aaBoundingRect.BD)(J,a.mbs)&&this._loadedNodeScales.set(s,e)}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(e,t){return this._idleQueue.push(e,t)}reschedule(e,t){return this._idleQueue.unshift(e,t)}get isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get areScaleBoundsActive(){const{minScale:e,maxScale:t}=(0,layerViewUtils.lu)(this.layer);return this.scaleVisibilityEnabled&&(e>0||t>0)}get unloadedMemoryEstimate(){return(0,maybe.Wi)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}get indexDepth(){return(0,maybe.pC)(this._index)?this._index.maxLevel:0}set disableMemCache(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}_frame(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,maybe.Wi)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}_processLogError(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?O.error("Error during processing: "+i):50===this._errorCount&&O.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(e,t){if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!(0,maybe.Wi)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((()=>this._processIndex(e))),this._updateFeatureLOD(),e.run((()=>this._processCache(e))),this.isIntegratedMesh&&(e.enabled=!0),e.run((()=>this._processNodes(e,t)));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((()=>this._prefetchIndex())),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((()=>this._lodHandling.lodGlobalHandling(e))),this._evaluateUpdating()}}_processIndex(e){if((0,maybe.Wi)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],e,(e=>this.updateNodeModificationStatus(e))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const t=this._index.featureEstimate.leavesReached;this._index.isLoading()||t===this._get("leavesReached")||this._set("leavesReached",t)}return this._index.load()}_prefetchIndex(){return!((0,maybe.Wi)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.isGraphics3D||(0,maybe.Wi)(this._index)||(0,maybe.Wi)(this._viewportQueries))return;const e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=G)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const e=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=e;const s=this.lod,a=this._index.checkFeatureTarget(t,s);a!==s&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=G)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(G,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}_processCache(e){const t=this._index;if((0,maybe.Wi)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;){const s=this._newLoadingNodes.pop();for(let a=t.getParent(s);(0,maybe.pC)(a)&&!this.layerView.isNodeLoaded(a.index)&&this._isNodeInScaleBounds(a);a=t.getParent(a.index))if(this._enableFromGPUCache(a,0)){e.madeProgress();break}}return e.hasProgressed}_processNodes(e,t){if((0,maybe.Wi)(this._index))return!1;let a=(this._isIdle?100:2)-this._loadingNodes.size;const r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){const t=this._index.getNode(r.update.pop());(0,maybe.pC)(t)&&(this._updateLoadedNode(t),e.madeProgress())}for(;r.add.length>0&&!e.done&&a>0;){--a;const i=this._index.getNode(r.add.back());if((0,maybe.Wi)(i)||2!==i.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(i),e.madeProgress()}return e.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((e=>e.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((e=>e.abort())),this._updatingNodes.clear()}_cancelNode(e){const t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}_hasNodeLoadToken(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<support.N&&!this.dataStreamController.busy}_evaluateUpdating(){let e=!1,t=0;if(this.layerView.suspended)e=this._cameraDirty,t=e?.5:1;else{const s=((0,maybe.pC)(this._index)?this._index.getIndexMissing():0)+3*((0,maybe.pC)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(s>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===s&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(s,this._progressMaxNumNodes),t=1-s/this._progressMaxNumNodes}e!==this.updating&&this._set("updating",e),t!==this.updatingProgress&&this._set("updatingProgress",t)}_updateViewData(){if(!this._cameraDirty||(0,maybe.Wi)(this._index)||(0,maybe.Wi)(this._viewportQueries))return;const e=this.layerView.view,{camera:t,contentCamera:i,fixedContentCamera:a}=e.state;this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._viewportQueries.updateCamera(t,i,a),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=$.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get lod(){return this._featureLOD*this.baseLOD}get baseLOD(){const e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}get lodDropFactor(){if(this.fixedFeatureTarget)return 1;const e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}isGeometryVisible(e){return(0,maybe.pC)(this._index)&&this._index.isGeometryVisible(e.index)}updateVisibility(e){(0,maybe.pC)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}updateBoundingVolume(e){(0,maybe.pC)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}invalidateGeometryVisibility(e){(0,maybe.pC)(this._index)&&this._index.invalidateGeometryVisibility(e)}invalidateVisibilityObbs(){(0,maybe.pC)(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){if((0,maybe.pC)(this._index)){const e=(0,maybe.pC)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}_shouldLoadNode(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!(0,maybe.pC)(this._index)&&this._index.isGeometryVisible(e.index)}_shouldDropNode(e){if((0,maybe.Wi)(this._viewportQueries))return!1;const t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}_startNodeLoading(){this._restartNodeLoading=!1;const e=this._index;if(this._updatesDisabled||(0,maybe.Wi)(e)||(0,maybe.Wi)(this._viewportQueries))return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const t={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new I3SNodeLoader(this.layer,this.dataStreamController,O,this._defaultGeometrySchema,this._requiredAttributes,t),e.requestUpdate(),this._lodHandling.startNodeLoading((e=>this._isNodeInScaleBounds(e)),((e,t)=>this._removeNodes(e,t,1)),e,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(e){const t=this._index;if((0,maybe.Wi)(t)||(0,maybe.Wi)(this._viewportQueries))return!1;H.clear(),this.layerView.getLoadedNodeIndices(H);const i=0===this._viewportQueries.maxDistance,a=i?()=>!1:e=>this._shouldDropNode(e);return H.filterInPlace((e=>{const i=t.getNode(e);return(0,maybe.Wi)(i)||!t.isGeometryVisible(e)||a(i)||!this._isNodeInScaleBounds(i)})),H.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(H,e,0),!(i&&this.lodDropFactor<1||0!==H.length&&(H.clear(),1))}markNodeToRemove(e){H.push(e)}removeMarkedNodes(){this._removeNodes(H,Scheduler.G5,0)}_removeNodes(e,t,s){const a=e.length;if(0!==a&&!t.done){for((0,maybe.pC)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){const a=e.pop(),r=this._index;1===s&&this.layerView.nodeFadeoutEnabled&&(0,maybe.pC)(r)&&r.isGeometryVisible(a)?this.layerView.fadeNode(a,1,!0):this.layerView.removeNode(a),t.madeProgress()}if(this._loadedNodeScales.size>0)for(let t=e.length;t<a;t++){const i=e.data[t];this._loadedNodeScales.delete(i)}}}_needsUpdate(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;const t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}_updateLoadedNode(e){const t=(0,promiseUtils.yi)();this._updatingNodes.set(e.index,t),(I3SOnDemandController_R(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,t.signal)).then((i=>this.schedule((()=>this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:i},t.signal)),t.signal))).catch((i=>{if(!(0,promiseUtils.D_)(i))return this.layerView.updateAttributes(e.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},t.signal)})).catch((()=>{})).then((()=>{this._updatingNodes.delete(e.index),this._evaluateUpdating()})),this._evaluateUpdating()}_loadNode(e){if(this._loadingNodes.has(e.index))return void O.error("already loading node "+e.index);const t=(0,promiseUtils.yi)();this._loadingNodes.set(e.index,t);const i=()=>{this._loadingNodes.get(e.index)===t&&this._loadingNodes.delete(e.index),this._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,t.signal).then(i).catch((e=>{if(i(),!(0,promiseUtils.D_)(e))throw e}))}_loadAndAddNode(e,t){return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((t=>{t||(e.cacheState=1,(0,maybe.pC)(this._index)&&this._index.updates.add.push(e.index))})).catch((t=>{if(!(0,promiseUtils.D_)(t))throw e.cacheState=1,t}))}_enableFromGPUCache(e,t){if(this._disableMemCache||(0,maybe.Wi)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;const i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}_loadCachedGPUData(e){const t=this.layerView.loadCachedGPUData(e);return(0,maybe.pC)(t)&&(0,maybe.pC)(t.attributeInfo)&&I3SOnDemandController_R(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}_nodeAdded(){(0,maybe.pC)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_loadCached(e,t){if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);const i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((()=>i.loadCachedNodeData(e,t,((t,i)=>this._nodeLoader.loadTextures(e,t,i)))),t).then((a=>{if((0,maybe.Wi)(a))return!1;const r=this._requiredAttributes;return this.reschedule((()=>this._nodeLoader.loadAttributes(e,r,t)),t).then((s=>this.reschedule((()=>i.addCachedNodeData(e,a,{loadedAttributes:r,attributeData:s},t)),t))).then((()=>(this._nodeAdded(),!0)))})):Promise.resolve(!1)}_loadUncached(e,t){return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((e=>{throw this._downloadingCount--,e})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(e,i,t)),t)))).then((()=>{this._nodeAdded(),e.cacheState=2})).catch((t=>{if(!(0,promiseUtils.D_)(t))throw O.error("#loadNodeData()",this.layer,`Failed to load node '${e.id}'`,t),e.failed=!0,(0,maybe.pC)(this._index)&&this._index.requestUpdate(),t}))}_updateIdleState(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&(0,maybe.pC)(this._index)&&this._index.resetFailedNodes())}_getScale(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];const t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}_isNodeInScaleBounds(e){if(!this.areScaleBoundsActive)return!0;const t=this._getScale(e),{minScale:i,maxScale:s}=(0,layerViewUtils.lu)(this.layer);return(0,layerViewUtils.rs)(t,i,s)}updateStats(e){e.index=(0,maybe.pC)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),(0,maybe.pC)(this._index)&&this._index.updateStats(e)}get test(){const e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){(0,maybe.pC)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:t=>e._shouldLoadNode(t)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,maybe.pC)(this._index)&&this._index.requestUpdate()}geometryFilterChanged(e){const t=this._index;(0,maybe.pC)(t)&&t.layerFilterChanged(e),this.requestUpdate()}};(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"isMeshPyramid",null),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"isGraphics3D",null),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"indexStreamController",null),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"dataStreamController",null),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"crsVertex",null),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"crsIndex",null),(0,tslib_es6._)([(0,property.Cb)()],E.prototype,"screenSizeFactor",void 0),(0,tslib_es6._)([(0,property.Cb)()],E.prototype,"featureTarget",void 0),(0,tslib_es6._)([(0,property.Cb)()],E.prototype,"fixedFeatureTarget",void 0),(0,tslib_es6._)([(0,property.Cb)()],E.prototype,"layerView",void 0),(0,tslib_es6._)([(0,property.Cb)()],E.prototype,"layer",void 0),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"updating",void 0),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"updatingProgress",void 0),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0})],E.prototype,"leavesReached",void 0),(0,tslib_es6._)([(0,property.Cb)({constructOnly:!0})],E.prototype,"scaleVisibilityEnabled",void 0),(0,tslib_es6._)([(0,property.Cb)({readOnly:!0,dependsOn:[]})],E.prototype,"rootNodeVisible",null),E=(0,tslib_es6._)([(0,subclass.j)("esri.layers.graphics.controllers.I3SOnDemandController")],E);const H=new PooledArray.Z({deallocator:null});let k;function I3SOnDemandController_R(e,t){return(0,maybe.pC)(e)&&e.length===t.length&&e.every((e=>z(t,e.name)>=0))}function z(e,t){const i=t.toLowerCase();for(let s=0;s<e.length;s++)if(e[s].name.toLowerCase()===i)return s;return-1}const $={factorIM:.2,factor3dObject:.05,distancePenalty:10},J=(0,aaBoundingRect.Ue)();const I3SOnDemandController=E},82483:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{l:()=>y});var maybe=__webpack_require__(59472),Logger=__webpack_require__(36544),arrayUtils=__webpack_require__(19677),promiseUtils=__webpack_require__(39105),number=__webpack_require__(17427),request=__webpack_require__(36654),asyncUtils=__webpack_require__(59351),byteSizeEstimations=__webpack_require__(86667),Query=__webpack_require__(31518);async function featureQueryAll_t(r,t,o){t=t.clone(),r.capabilities.query.supportsMaxRecordCountFactor&&(t.maxRecordCountFactor=u(r));const i=a(r),n=r.capabilities.query.supportsPagination;t.start=0,t.num=i;let s=null;for(;;){const a=await r.source.queryFeaturesJSON(t,o);if((0,maybe.Wi)(s)?s=a:s.features=s.features.concat(a.features),s.exceededTransferLimit=a.exceededTransferLimit,!n||!a.exceededTransferLimit)break;t.start+=i}return s}function a(e){return u(e)*function o(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function u(e){return e.capabilities.query.supportsMaxRecordCountFactor?Query.Z.MAX_MAX_RECORD_COUNT_FACTOR:1}const f=Logger.Z.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");class y{constructor(e,t){this.layer=e,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=(0,promiseUtils.yi)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=v,this.memCache=t.getMemCache(`${e.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}destroy(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}createInteractiveEditSession(t){this.changedObjectIds.add(t),(0,maybe.Wi)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const s=this.interactiveEditingSessions,i=new O(t,{rollback:()=>{(0,arrayUtils.Od)(s,i),0===s.length&&(this.interactiveEditingSessions=null)},commit:e=>{for(const[s,i]of e)this.updateValue(t,s,i)}});return s.unshift(i),i}async apply(t,s,i){if((0,maybe.Wi)(s))return;const{loadedAttributes:r,attributeData:a}=s;if((0,maybe.Wi)(r)||0===r.length||(0,maybe.Wi)(a))return;if(await(0,promiseUtils.Hl)(this.pendingFetchChangedObjectIds,i),0===this.changedObjectIds.size)return;const n={loadedAttributes:r,attributeData:a},o=this.getOverridesFromCache(t,n,this.changedObjectIds),{objectIds:d,fieldNames:h}=o,l=await this.queryOverridesFromAssociatedLayer(d,h,i);(0,maybe.Wi)(l)||this.processOverridesFromAssociatedLayer(t,l,h,n)}updateValue(e,t,s){this.changedObjectIds.add(e),this.cacheValue(e,t,s)}cacheValue(e,t,s){this.memCache.put(this.getCacheKey(e,t),s,this.memCacheValueSize(s))}getOverridesFromCache(e,{loadedAttributes:t,attributeData:s},i){const r=new Set,a=new Array;for(const o of t)a[o.index]=s[o.name];const n=new Set;for(let o=0;o<e.length;o++){const s=e[o];if(i.has(s))for(const e of t){const t=this.fromCache(s,e.index);void 0===t?(r.add(s),n.add(e.name)):a[e.index][o]=t}}return{objectIds:Array.from(r),fieldNames:Array.from(n)}}fromCache(e,t){const s=this.fromInteractiveEditingSession(e,t);if(void 0!==s)return s;const i=this.getCacheKey(e,t);return this.memCache.get(i)}fromInteractiveEditingSession(t,s){if(!(0,maybe.Wi)(this.interactiveEditingSessions))for(const e of this.interactiveEditingSessions){if(e.objectId!==t)continue;const i=e.get(s);if(void 0!==i)return i}}getCacheKey(e,t){return`${e}-${t}`}async queryOverridesFromAssociatedLayer(e,s,i){if(0===e.length||0===s.length)return null;e=e.sort(((e,t)=>e-t)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const r=(0,maybe.Wg)(this.layer.associatedLayer),n=r.createQuery();n.where="1=1",n.returnGeometry=!1,n.outFields=[r.objectIdField,...s],n.cacheHint=!0,n.objectIds=e;const o=a(r),c=e.length>o?(0,arrayUtils.vr)(e,o).map((e=>{const t=n.clone();return t.objectIds=e,(0,asyncUtils.mt)(featureQueryAll_t(r,t,{signal:i}))})):[(0,asyncUtils.mt)(featureQueryAll_t(r,n,{signal:i}))];return(await Promise.all(c)).reduce(((e,t)=>e.concat(t.ok?t.value.features:[])),[])}logMaximumObjectsExceededWarning(){let e=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,number.uf)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const t=this.layer.portalItem;t&&t.loaded?e+=` (${t.portal.url}/home/item.html?id=${t.id}#settings)`:e+=` (${this.layer.parsedUrl.path})`,f.warn(`("${this.layer.title}"):`,`${e}.`)}processOverridesFromAssociatedLayer(e,s,i,{loadedAttributes:r,attributeData:a}){const n=(0,maybe.Wg)(this.layer.associatedLayer).objectIdField,o=i.map((e=>a[e])),c=new Map(r.map((e=>[e.name,e.index]))),d=i.map((e=>c.get(e))),h=new Map(Array.from(e,((e,t)=>[e,t])));for(const t of s){const e=t.attributes[n];for(let s=0;s<i.length;s++){const r=d[s],a=h.get(e),n=t.attributes[i[s]];o[s][a]=n,this.cacheValue(e,r,n)}}}memCacheValueSize(e){return"string"==typeof e?(0,byteSizeEstimations.hH)(e):(0,byteSizeEstimations.G3)()}async fetchChangedObjectIds(t){var r,a,n;const o=this.layer;if(await o.load({signal:t}),this.changedObjectIds.clear(),(0,maybe.Wi)(o.associatedLayer)||null==(r=o.associatedLayer.capabilities)||null==(a=r.operations)||!a.supportsChangeTracking)return;const c=this.getFetchChangedObjectIdsServerGen();if((0,maybe.Wi)(c))return null;const d=o.associatedLayer.layerId,l=await(0,asyncUtils.q6)((0,request.default)(`${o.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${d}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:d,serverGen:c}])},timeout:j,signal:t})),u=l.ok&&null!=(n=l.value.data)&&n.edits?(0,maybe.U2)(l.value.data.edits[0],"objectIds","updates"):null;if((0,maybe.pC)(u)){const e=Math.min(this._maximumNumberOfEditOVerrides,u.length);e<u.length&&(this.warnMaximumChangedObjectsExceeded=!0);const t=u.sort(((e,t)=>e-t));for(let s=0;s<e;s++)this.changedObjectIds.add(t[s])}}getFetchChangedObjectIdsServerGen(){const e=this.layer;if((0,maybe.pC)(e.serviceUpdateTimeStamp)&&(0,maybe.pC)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;const t=e.associatedLayer;return(0,maybe.pC)(t)&&(0,maybe.pC)(t.serverGens)&&(0,maybe.pC)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}get test(){const e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,s=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return s._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){s._maximumNumberOfEditOVerrides=e}}}}class O{constructor(e,t){this.objectId=e,this.options=t,this.updates=new Map,this.state=0}get(e){return this.updates.get(e)}set(e,t){this.isActive&&this.updates.set(e,t)}rollback(){this.isActive&&(this.state=2,this.options.rollback())}commit(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}get isActive(){return 0===this.state}}const j=1e4,v=5e4},30269:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{f:()=>s});var _core_Evented_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(35470),_core_MapUtils_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(77293);class s extends _core_Evented_js__WEBPACK_IMPORTED_MODULE_0__.Z{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}get length(){return this._map.size}get(e){return this._map.get(e)}addMany(e){if(0===e.length)return;const t=new Set;for(let r=0;r<e.length;r++){const s=e[r],o=s.objectId,n=this._map.get(o);n?(t.add(o),s!==n&&(e[r]=n),++n.refCount):(s.refCount=1,this._map.set(o,s))}const s=t.size>0?e.filter((e=>!t.has(e.objectId))):e;s.length>0&&this.emit("change",{added:s,removed:[]})}removeMany(e){const t=[];for(const s of e){const e=s.objectId,r=this._map.get(e);null!=r&&--r.refCount<=0&&(this._map.delete(e),t.push(s))}t.length>0&&this.emit("change",{added:[],removed:t})}removeManyByObjectId(e){const t=[];for(const s of e){const e=this._map.get(s);null!=e&&--e.refCount<=0&&(this._map.delete(s),t.push(e))}t.length>0&&this.emit("change",{added:[],removed:t})}toArray(){return[...this._map.values()]}find(e){let s;return(0,_core_MapUtils_js__WEBPACK_IMPORTED_MODULE_1__.o)(this._map,(t=>!!e(t)&&(s=t,!0))),s}forEach(e){this._map.forEach((t=>e(t)))}}}}]);
//# sourceMappingURL=1090.150107d1.iframe.bundle.js.map