{"version":3,"file":"TileLayerView2D.f1864392.js","sources":["../../node_modules/@arcgis/core/views/2d/layers/TileLayerView2D.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/Error.js\";import i from\"../../../core/Logger.js\";import{isNone as r}from\"../../../core/maybe.js\";import{isAbortError as s}from\"../../../core/promiseUtils.js\";import{property as a}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../core/accessorSupport/decorators/subclass.js\";import{BitmapTileLayerView2D as o}from\"./BitmapTileLayerView2D.js\";import{LayerView2DMixin as h}from\"./LayerView2D.js\";import n from\"../tiling/TileInfoView.js\";import c from\"../tiling/TileKey.js\";import u from\"../tiling/TileQueue.js\";import m from\"../tiling/TileStrategy.js\";import p from\"../../layers/LayerView.js\";import{RefreshableLayerView as f}from\"../../layers/RefreshableLayerView.js\";import{TileLayerView as g}from\"../../layers/TileLayerView.js\";import{createQueryGeometry as y}from\"../../support/drapedUtils.js\";const w=i.getLogger(\"esri.views.2d.layers.TileLayerView2D\"),d=[0,0];let _=class extends(g(f(o(h(p))))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}initialize(){const e=this.layer.tileInfo,i=e&&e.spatialReference;let r;i||(r=new t(\"layerview:tiling-information-missing\",\"The layer doesn't provide tiling information\",{layer:this.layer})),i.equals(this.view.spatialReference)||(r=new t(\"layerview:spatial-reference-incompatible\",\"The spatial reference of this layer does not meet the requirements of the view\",{layer:this.layer})),this.watch(\"resampling\",(()=>{this.doRefresh()})),r&&this.addResolvingPromise(Promise.reject(r))}get resampling(){return!(\"resampling\"in this.layer)||!1!==this.layer.resampling}hitTest(){return null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume(),this.notifyChange(\"updating\")}attach(){const e=\"tileServers\"in this.layer?this.layer.tileServers:null;this._tileInfoView=new n(this.layer.tileInfo,this.layer.fullExtent),this._fetchQueue=new u({tileInfoView:this._tileInfoView,concurrency:e&&10*e.length||10,process:(e,t)=>this.fetchTile(e,t)}),this._tileStrategy=new m({cachePolicy:\"keep\",resampling:this.resampling,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView}),this.requestUpdate(),this.container.requestRender(),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQueryGeometry(e,t){return y(e,t,this.view)}async doRefresh(){this.updateRequested||this.suspended||(this._fetchQueue.reset(),this._tileStrategy.tiles.forEach((e=>this._enqueueTileFetch(e))),this.notifyChange(\"updating\"))}isUpdating(){var e;return(null==(e=this._fetchQueue)?void 0:e.length)>0}acquireTile(e){const t=this._bitmapView.createTile(e),i=t.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(d,t.key),i.resolution=this._tileInfoView.getTileResolution(t.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(t),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once(\"detach\",(()=>e.destroy())),this.requestUpdate()}async fetchTile(e,t){const i=\"tilemapCache\"in this.layer?this.layer.tilemapCache:null,a=!r(t)&&t.signal;if(!i)try{return await this._fetchImage(e,a)}catch(m){if(!s(m)&&!this.resampling)return this._createBlankImage();throw m}const l=new c(0,0,0,0);let o;try{if(await i.fetchAvailabilityUpsample(e.level,e.row,e.col,l,{signal:a}),l.level!==e.level&&!this.resampling)return this._createBlankImage();o=await this._fetchImage(l,a)}catch(m){if(s(m))throw m;o=await this._fetchImage(e,a)}const{level:h,row:n,col:u}=l;return this.resampling&&h!==e.level?this._resampleImage(o,h,n,u,e.level,e.row,e.col):o}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{const t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once(\"attach\",(()=>this.requestUpdate()))}catch(t){s(t)||w.error(t)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchTile(e.level,e.row,e.col,{signal:t})}_resampleImage(e,t,i,r,s,a,l){const o=this._tileInfoView.tileInfo.size,h=this._tileInfoView.getTileResolution(t),n=this._tileInfoView.getTileResolution(s);let c=this._tileInfoView.getLODInfoAt(s);const u=c.getXForColumn(l),m=c.getYForRow(a);c=this._tileInfoView.getLODInfoAt(t);const p=c.getXForColumn(r),f=c.getYForRow(i),g=Math.round((u-p)/h),y=Math.round(-(m-f)/h),w=Math.round(o[0]*(n/h)),d=Math.round(o[1]*(n/h)),_=this._createBlankImage();return _.getContext(\"2d\").drawImage(e,g,y,w,d,0,0,o[0],o[1]),_}_createBlankImage(){const e=this._tileInfoView.tileInfo.size,t=document.createElement(\"canvas\");return[t.width,t.height]=e,t}};e([a()],_.prototype,\"resampling\",null),_=e([l(\"esri.views.2d.layers.TileLayerView2D\")],_);var I=_;export{I as default};\n"],"names":["w","i","getLogger","d","_","g","f","o","h","p","constructor","arguments","this","_tileStrategy","_fetchQueue","layer","initialize","e2","tileInfo","i2","spatialReference","r2","t","equals","view","watch","doRefresh","addResolvingPromise","Promise","reject","resampling","hitTest","update","pause","state","resume","notifyChange","attach","tileServers","_tileInfoView","n","fullExtent","u","tileInfoView","concurrency","length","process","e3","t2","fetchTile","m","cachePolicy","acquireTile","releaseTile","requestUpdate","container","requestRender","super","detach","destroy","clear","removeAllChildren","moveStart","viewChange","moveEnd","createFetchPopupFeaturesQueryGeometry","y","updateRequested","suspended","reset","tiles","forEach","_enqueueTileFetch","isUpdating","_bitmapView","createTile","bitmap","x","getTileCoords","key","resolution","getTileResolution","width","height","size","addChild","abort","id","removeChild","once","e","tilemapCache","a2","r","signal","_fetchImage","s","_createBlankImage","l2","c","fetchAvailabilityUpsample","level","row","col","h2","n2","u2","_resampleImage","has","push","source","error","s2","getLODInfoAt","getXForColumn","getYForRow","p2","g2","Math","round","y2","w2","d2","_2","getContext","drawImage","document","createElement","a","prototype","l","I"],"mappings":"wzBAIq+B,MAAMA,EAAEC,EAAEC,UAAU,wCAAwCC,EAAE,CAAC,EAAE,GAAG,IAAIC,EAAE,cAAcC,EAAEC,EAAEC,EAAEC,EAAEC,OAAOC,uBAAuBC,WAAWC,KAAKC,cAAc,KAAKD,KAAKE,YAAY,KAAKF,KAAKG,MAAM,KAAKC,mBAAmBC,EAAEL,KAAKG,MAAMG,SAASC,EAAEF,GAAGA,EAAEG,qBAAqBC,QAAQ,IAAIC,EAAE,uCAAuC,+CAA+C,CAACP,MAAMH,KAAKG,SAASI,EAAEI,OAAOX,KAAKY,KAAKJ,sBAAsB,IAAIE,EAAE,2CAA2C,iFAAiF,CAACP,MAAMH,KAAKG,SAASH,KAAKa,MAAM,cAAc,UAAUC,eAAeL,GAAGT,KAAKe,oBAAoBC,QAAQC,OAAOR,4CAA4CT,KAAKG,SAAQ,IAAAH,KAAUG,MAAMe,WAAWC,iBAAiB,KAAKC,OAAOf,QAAQH,YAAYmB,QAAQrB,KAAKE,YAAYoB,MAAMjB,EAAEiB,MAAMtB,KAAKC,cAAcmB,OAAOf,GAAGL,KAAKE,YAAYqB,SAASvB,KAAKwB,aAAa,YAAYC,eAAepB,EAAE,gBAAgBL,KAAKG,MAAMH,KAAKG,MAAMuB,YAAY,UAAUC,cAAc,IAAIC,EAAE5B,KAAKG,MAAMG,SAASN,KAAKG,MAAM0B,YAAY7B,KAAKE,YAAY,IAAI4B,EAAE,CAACC,aAAa/B,KAAK2B,cAAcK,YAAY3B,GAAG,GAAGA,EAAE4B,QAAQ,GAAGC,QAAQ,CAACC,EAAEC,IAAIpC,KAAKqC,UAAUF,EAAEC,KAAKpC,KAAKC,cAAc,IAAIqC,EAAE,CAACC,YAAY,OAAOrB,WAAWlB,KAAKkB,WAAWsB,eAAexC,KAAKwC,YAAYL,GAAGM,eAAezC,KAAKyC,YAAYN,GAAGJ,aAAa/B,KAAK2B,gBAAgB3B,KAAK0C,gBAAgB1C,KAAK2C,UAAUC,gBAAgBC,MAAMpB,SAASqB,eAAeA,SAAS9C,KAAKC,cAAc8C,UAAU/C,KAAKE,YAAY8C,QAAQhD,KAAK2C,UAAUM,oBAAoBjD,KAAKE,YAAYF,KAAKC,cAAcD,KAAK2B,cAAc,KAAKuB,iBAAiBR,gBAAgBS,kBAAkBT,gBAAgBU,eAAeV,gBAAgBW,sCAAsChD,EAAE+B,UAAUkB,EAAEjD,EAAE+B,EAAEpC,KAAKY,6BAA6B2C,iBAAiBvD,KAAKwD,iBAAiBtD,YAAYuD,QAAQzD,KAAKC,cAAcyD,MAAMC,YAAY3D,KAAK4D,kBAAkBvD,KAAKL,KAAKwB,aAAa,aAAaqC,iBAAiBxD,SAAS,SAASL,KAAKE,kBAAa,EAAOG,EAAE4B,QAAQ,EAAEO,YAAYnC,SAAS+B,EAAEpC,KAAK8D,YAAYC,WAAW1D,GAAGE,EAAE6B,EAAE4B,cAAczD,EAAE0D,EAAE1D,EAAE+C,GAAGtD,KAAK2B,cAAcuC,cAAc3E,EAAE6C,EAAE+B,KAAK5D,EAAE6D,WAAWpE,KAAK2B,cAAc0C,kBAAkBjC,EAAE+B,MAAM5D,EAAE+D,MAAM/D,EAAEgE,QAAQvE,KAAK2B,cAAcrB,SAASkE,KAAKxE,KAAK4D,kBAAkBxB,GAAGpC,KAAK8D,YAAYW,SAASrC,GAAGpC,KAAK0C,gBAAgBN,EAAEK,YAAYpC,QAAQH,YAAYwE,MAAMrE,EAAE8D,IAAIQ,IAAI3E,KAAK8D,YAAYc,YAAYvE,GAAGA,EAAEwE,KAAK,UAAU,IAAIxE,EAAE0C,YAAY/C,KAAK0C,gCAAgCoC,EAAEpE,SAASH,EAAE,iBAAiBP,KAAKG,MAAMH,KAAKG,MAAM4E,aAAa,KAAKC,GAAGC,EAAEvE,IAAIA,EAAEwE,WAAW3E,mBAAmBP,KAAKmF,YAAYL,EAAEE,SAAS1C,OAAO8C,EAAE9C,KAAKtC,KAAKkB,kBAAkBlB,KAAKqF,0BAA0B/C,QAAQgD,EAAE,IAAIC,EAAE,EAAE,EAAE,EAAE,OAAO5F,eAAeY,EAAEiF,0BAA0BV,EAAEW,MAAMX,EAAEY,IAAIZ,EAAEa,IAAIL,EAAE,CAACJ,OAAOF,IAAIM,EAAEG,QAAQX,EAAEW,QAAQzF,KAAKkB,kBAAkBlB,KAAKqF,4BAA4BrF,KAAKmF,YAAYG,EAAEN,SAAS1C,MAAM8C,EAAE9C,SAASA,UAAUtC,KAAKmF,YAAYL,EAAEE,SAASS,MAAMG,EAAEF,IAAIG,EAAEF,IAAIG,GAAGR,SAAStF,KAAKkB,YAAY0E,IAAId,EAAEW,MAAMzF,KAAK+F,eAAepG,EAAEiG,EAAEC,EAAEC,EAAEhB,EAAEW,MAAMX,EAAEY,IAAIZ,EAAEa,KAAKhG,0BAA0BU,OAAOL,KAAKE,YAAY8F,IAAI3F,EAAE8D,IAAIQ,IAAI,WAAWvC,QAAQpC,KAAKE,YAAY+F,KAAK5F,EAAE8D,OAAOH,OAAOkC,OAAO9D,EAAE/B,EAAE2D,OAAOM,MAAMtE,KAAK2B,cAAcrB,SAASkE,KAAK,GAAGnE,EAAE2D,OAAOO,OAAOvE,KAAK2B,cAAcrB,SAASkE,KAAK,GAAGnE,EAAEwE,KAAK,UAAU,IAAI7E,KAAK0C,wBAAwBN,KAAKA,IAAIhD,EAAE+G,MAAM/D,QAAQM,mCAAmCrC,EAAE+B,UAAUpC,KAAKG,MAAMkC,UAAUhC,EAAEoF,MAAMpF,EAAEqF,IAAIrF,EAAEsF,IAAI,CAACT,OAAO9C,IAAI2D,eAAe1F,EAAE+B,EAAE7B,EAAEE,EAAE2F,EAAEpB,EAAEM,SAAS3F,EAAEK,KAAK2B,cAAcrB,SAASkE,KAAKoB,EAAE5F,KAAK2B,cAAc0C,kBAAkBjC,GAAGyD,EAAE7F,KAAK2B,cAAc0C,kBAAkB+B,OAAOb,EAAEvF,KAAK2B,cAAc0E,aAAaD,SAASN,EAAEP,EAAEe,cAAchB,GAAGhD,EAAEiD,EAAEgB,WAAWvB,KAAKhF,KAAK2B,cAAc0E,aAAajE,SAASoE,EAAEjB,EAAEe,cAAc7F,GAAGf,EAAE6F,EAAEgB,WAAWhG,GAAGkG,EAAEC,KAAKC,SAASH,GAAGZ,GAAGgB,EAAEF,KAAKC,UAAUjH,GAAGkG,GAAGiB,EAAEH,KAAKC,MAAMhH,EAAE,MAAMiG,IAAIkB,EAAEJ,KAAKC,MAAMhH,EAAE,MAAMiG,IAAImB,EAAE/G,KAAKqF,2BAA2B0B,EAAEC,WAAW,MAAMC,UAAU5G,EAAEoG,EAAEG,EAAEC,EAAEC,EAAE,EAAE,EAAEnH,EAAE,GAAGA,EAAE,IAAIoH,EAAE1B,0BAA0BhF,EAAEL,KAAK2B,cAAcrB,SAASkE,KAAKpC,EAAE8E,SAASC,cAAc,iBAAiB/E,EAAEkC,MAAMlC,EAAEmC,QAAQlE,EAAE+B,IAAI0C,EAAE,CAACsC,KAAK5H,EAAE6H,UAAU,aAAa,MAAM7H,EAAEsF,EAAE,CAACwC,EAAE,yCAAyC9H,GAAM,IAAC+H,EAAE/H"}