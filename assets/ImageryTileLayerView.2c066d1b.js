import{F as e,G as t,H as r,z as i,B as a,D as n}from"./vendor.7103ff48.js";import{d as l,b as s}from"./rasterProjectionHelper.d2fb66f4.js";import{d as o}from"./popupUtils.99eeb504.js";const u=u=>{let f=class extends u{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(e,t){const{layer:r}=this;if(!e)return Promise.reject(new i("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r}));const{popupEnabled:l}=r,s=o(r,t);if(!l||!a(s))throw new i("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:l,popupTemplate:s});const u=[],{value:f,magdirValue:p}=await r.identify(e);let m="";if(f&&f.length){var d,h;m="imagery-tile"===r.type&&r.hasStandardTime()&&null!=f[0]?f.map((e=>r.getStandardTimeValue(e))).join(", "):f.join(", ");const e={ObjectId:0},t="Raster.ServicePixelValue";e[t]=this._formatAttributeValue(m,t);const i=null==(d=r.rasterInfo)||null==(h=d.attributeTable)?void 0:h.features;if(i&&i.length>0){const t=i.filter((e=>{const t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===m}));if(t.length>0){const r=t[0];if(r)for(const t in r.attributes)if(r.attributes.hasOwnProperty(t)){const i=this._rasterFieldPrefix+t;e[i]=this._formatAttributeValue(r.attributes[t],i)}}}const a=r.rasterInfo.dataType;"vector-magdir"!==a&&"vector-uv"!==a||(e["Raster.Magnitude"]=null==p?void 0:p[0],e["Raster.Direction"]=null==p?void 0:p[1]);const l=new n(this.fullExtent.clone(),null,e);l.layer=r,l.sourceLayer=l.layer,u.push(l)}return u}updateFullExtent(){const e=this.layer.tileInfo;let t;e&&e.spatialReference||(t=new i("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));const r=l(this.layer.fullExtent,this.view.spatialReference,!1),a=s(this.layer.fullExtent,this.view.spatialReference,r);return null==a&&(t=new i("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})),this._set("fullExtent",a),this.datumTransformation||(this.datumTransformation=l(this.layer.fullExtent,this.view.spatialReference,!0)),t?Promise.reject(t):Promise.resolve()}_formatAttributeValue(e,t){if("string"==typeof e){const r=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,i=this._getFieldInfo(r,t),a=i&&i.format;if(a){let t,r;return e.trim().indexOf(",")>-1?(t=",",r=t+" ",this._formatDelimitedString(e,t,r,a)):e.trim().indexOf(" ")>-1?(t=r=" ",this._formatDelimitedString(e,t,r,a)):this._formatNumberFromString(e,a)}}return e}_getFieldInfo(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let i;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r&&e.fieldName.toLowerCase()!==r.replace(/ /g,"_")||(i=e,0)))),i}_formatDelimitedString(e,t,r,i){return e&&t&&r&&i?e.trim().split(t).map((e=>this._formatNumberFromString(e,i))).join(r):e}_formatNumberFromString(e,t){if(!e||!t)return e;const r=Number(e);return isNaN(r)?e:t.format(r)}};return e([t()],f.prototype,"layer",void 0),e([t()],f.prototype,"view",void 0),e([t()],f.prototype,"fullExtent",void 0),e([t()],f.prototype,"tileInfo",void 0),e([t({readOnly:!0})],f.prototype,"hasTilingEffects",null),f=e([r("esri.views.layers.ImageryTileLayerView")],f),f};export{u};
//# sourceMappingURL=ImageryTileLayerView.2c066d1b.js.map
