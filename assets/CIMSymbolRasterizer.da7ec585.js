import{bL as e,bx as t,bj as i,dK as a,N as r,da as s,o9 as n,et as o,oa as l,ob as h,cO as c,cP as m}from"./vendor.7103ff48.js";import{k as g,D as f}from"./cimAnalyzer.07de9cca.js";import{o as d}from"./Rasterizer.12b7ee42.js";import"./CIMSymbolHelper.da5834c9.js";class u{constructor(){}rasterizeText(e,t){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const i=this._textRasterizationCanvas,a=i.getContext("2d");this.setFontProperties(a,t),this.parameters=t,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const r=this.computeTextWidth(a,t),s=this.lineHeight*this.textLines.length;i.width=r,i.height=s,this.renderedLineHeight=Math.round(this.lineHeight*t.pixelRatio),this.renderedHaloSize=t.halo.size*t.pixelRatio,this.renderedWidth=r*t.pixelRatio,this.renderedHeight=s*t.pixelRatio,this.fillStyle=function(e){return`rgba(${e.slice(0,3).toString()},${e[3]})`}(t.color),this.haloStyle=function(e){return`rgb(${e.slice(0,3).toString()})`}(t.halo.color);const n=this.renderedLineHeight,o=this.renderedHaloSize;this.setFontProperties(a,t);const l=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(a.textAlign,this.renderedWidth)+o,h=o;let c=0,m=0;o>0&&this.renderHalo(a,l,h,c,m,t),m+=h,c+=l;for(const d of this.textLines)a.globalCompositeOperation="destination-out",a.fillStyle="rgb(0, 0, 0)",a.fillText(d,c,m),a.globalCompositeOperation="source-over",a.fillStyle=this.fillStyle,a.fillText(d,c,m),m+=n;const g=a.getImageData(0,0,this.renderedWidth,this.renderedHeight),f=new Uint8Array(g.data);if(t.premultiplyColors){let e;for(let t=0;t<f.length;t+=4)e=f[t+3]/255,f[t]=f[t]*e,f[t+1]=f[t+1]*e,f[t+2]=f[t+2]*e}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(f.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(e,t,i,a,r,s){const n=this.renderedWidth,o=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=n,this._haloRasterizationCanvas.height=o;const l=this._haloRasterizationCanvas,h=l.getContext("2d");h.clearRect(0,0,n,o),this.setFontProperties(h,s),h.fillStyle=this.haloStyle,h.strokeStyle=this.haloStyle;const c=this.renderedHaloSize<3;h.lineJoin=c?"miter":"round",c?this.renderHaloEmulated(h,t,i):this.renderHaloNative(h,t,i),e.globalAlpha=this.parameters.halo.color[3],e.drawImage(l,0,0,n,o,a,r,n,o),e.globalAlpha=1}renderHaloEmulated(e,t,i){const a=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){for(const[a,n]of y)e.fillText(s,t+r*a,i+r*n);i+=a}}renderHaloNative(e,t,i){const a=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){const n=2*r,o=5,l=.1;for(let a=0;a<o;a++){const r=1-(o-1)*l+a*l;e.lineWidth=r*n,e.strokeText(s,t,i)}i+=a}}setFontProperties(t,i){const a=i.font,r=`${a.style} ${a.weight} ${e(i.size*i.pixelRatio)}px ${a.family}, sans-serif`;let s;switch(t.font=r,t.textBaseline="top",i.horizontalAlignment){case"left":s="left";break;case"right":s="right";break;case"center":s="center";break;default:s="left"}t.textAlign=s}computeTextWidth(e,t){let i=0;for(const r of this.textLines)i=Math.max(i,e.measureText(r).width);const a=t.font;return("italic"===a.style||"oblique"===a.style||"string"==typeof a.weight&&("bold"===a.weight||"bolder"===a.weight)||"number"==typeof a.weight&&a.weight>600)&&(i+=.3*e.measureText("A").width),i+=2*this.parameters.halo.size,Math.round(i)}computeLineHeight(){const e=1.275*this.parameters.size;return Math.round(e+2*this.parameters.halo.size)}}const y=[];{const e=16;for(let t=0;t<360;t+=360/e)y.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var p,M;(M=p||(p={})).Legend="legend",M.Preview="preview";const x=(t,i,a)=>{if(t&&t.targetSize){let r;if(a){const i=Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin);r=t.targetSize/e(i)}else r=t.targetSize/i.referenceSize;return r}return t&&t.scaleFactor?t.scaleFactor:1},C={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class z{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new d,this._textRasterizer=new u,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(e,i,a,r,s,n,o,l){r=r||(i?null!=i.centroid?"esriGeometryPolygon":t(i.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const h=await this.analyzeCIMSymbol(e,i?function(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(i.attributes):null,a,r,l);return this.rasterizeCIMSymbol(h,i,r,s,n,o)}async analyzeCIMSymbol(e,t,r,s,n){const o=[],l=t?{geometryType:s,spatialReference:this._spatialReference,fields:t}:null;let h;await g(e.data,l,o,this._avoidSDF),i(n);for(const i of o)"CIMPictureMarker"!==i.cim.type&&"CIMPictureFill"!==i.cim.type&&"CIMPictureStroke"!==i.cim.type||(h||(h=[]),h.push(this.fetchPictureMarkerResource(i,n))),r&&"text"===i.type&&"string"==typeof i.text&&i.text.indexOf("[")>-1&&(i.text=a(r,i.text,i.cim.textCase));return h&&await Promise.all(h),o}async fetchPictureMarkerResource(e,t){const i=e.materialHash;if(!this._pictureMarkerCache.get(i)){const a=(await r(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(i,a)}}rasterizeCIMSymbol(e,t,i,a,r,n){const o=[];for(const l of e){a&&"function"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,r,n));const e=this._getRasterizedResource(l,t,i,a,r,n);if(!e)continue;let h=0,c=e.anchorX||0,m=e.anchorY||0,g=!1,f=0,d=0;if("esriGeometryPoint"===i){const e=x(a,l,null);if(f=s(l.offsetX,t,r,n)*e||0,d=s(l.offsetY,t,r,n)*e||0,"marker"===l.type)h=s(l.rotation,t,r,n)||0,g=!!l.rotateClockwise&&l.rotateClockwise;else if("text"===l.type){if(h=s(l.angle,t,r,n)||0,void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&o.push({angle:h,rotateClockWise:g,anchorX:c,anchorY:m,offsetX:f,offsetY:d,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(t){const i=document.createElement("canvas"),a=i.getContext("2d");let r=0,s=0,o=0,l=0;const h=[];for(let n=0;n<t.length;n++){const i=t[n],c=i.rasterizedResource;if(!c)continue;const m=c.size,g=i.offsetX,f=i.offsetY,d=i.anchorX,u=i.anchorY,y=i.rotateClockWise||!1;let p=i.angle,M=e(g)-m[0]*(.5+d),x=e(f)-m[1]*(.5+u),C=M+m[0],z=x+m[1];if(p){y&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),i=M*t-x*e,a=M*e+x*t,r=M*t-z*e,s=M*e+z*t,n=C*t-z*e,o=C*e+z*t,l=C*t-x*e,h=C*e+x*t;M=Math.min(i,r,n,l),x=Math.min(a,s,o,h),C=Math.max(i,r,n,l),z=Math.max(a,s,o,h)}r=M<r?M:r,s=x<s?x:s,o=C>o?C:o,l=z>l?z:l;const I=a.createImageData(c.size[0],c.size[1]);I.data.set(new Uint8ClampedArray(c.image.buffer));const w={offsetX:g,offsetY:f,rotateClockwise:y,angle:p,rasterizedImage:I,anchorX:d,anchorY:u};h.push(w)}i.width=o-r,i.height=l-s;const c=-r,m=l;for(let n=0;n<h.length;n++){const t=h[n],i=this._imageDataToCanvas(t.rasterizedImage),r=t.rasterizedImage.width,s=t.rasterizedImage.height,o=c-r*(.5+t.anchorX),l=m-s*(.5-t.anchorY);if(t.angle){const r=(360-t.angle)*Math.PI/180;a.save(),a.translate(e(t.offsetX),-e(t.offsetY)),a.translate(c,m),a.rotate(r),a.translate(-c,-m),a.drawImage(i,o,l),a.restore()}else a.drawImage(i,o+e(t.offsetX),l-e(t.offsetY))}const g=new n({x:c/i.width-.5,y:m/i.height-.5});return{imageData:0!==i.width&&0!==i.height?a.getImageData(0,0,i.width,i.height):a.createImageData(1,1),anchorPosition:g}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.putImageData(e,0,0),t}_imageTo32Array(e,t,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,r=a.getContext("2d");return a.width=t,a.height=i,r.drawImage(e,0,0,t,i),new Uint32Array(r.getImageData(0,0,t,i).data.buffer)}_getRasterizedResource(e,t,i,a,r,n){let h,c,m,g;if("esriGeometryPolyline"===i||"esriGeometryPolygon"===i){const l=a&&a.style?a.style:p.Legend,g="esriGeometryPolyline"===i?C.stroke[l]:C.fill[l];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const i=s(e.width,t,r,n),{image:a,width:o,height:l}=this._getPictureResource(e,i);return this._rasterizePictureResource(e,a,o,l,g,i)}return null}({analyzedCIM:h,hash:m}=I(e,t,r,n)),c=this._embedCIMLayerInVectorMarker(h,g)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=s(e.offsetX,t,r,n),e.cim.offsetY=s(e.offsetY,t,r,n),e.cim.rotation=s(e.rotation,t,r,n),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:h}=I(e,t,r,n)),m=o(JSON.stringify(h)).toString(),c=this._embedCIMLayerInVectorMarker(h,g)}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const i=e.cim.size||e.cim.height;let a,s,o;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:a,width:s,height:o}=this._getPictureResource(e,i));else{({analyzedCIM:h,hash:m}=I(e,t,r,n));const i=this._rasterizer.rasterizeJSONResource(h,1,this._avoidSDF);a=i.image,s=i.size[0],o=i.size[1]}return this._rasterizePictureResource(e,a,s,o,g,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:h,hash:m}=I(e,t,r,n)),c=this._embedCIMLayerInVectorMarker(h,g)}}}else{if("text"===e.type)return g=this._rasterizeTextResource(e,t,a,r,n),g;({analyzedCIM:h,hash:m}=I(e,t,r,n));const i=x(a,e,null);if("CIMPictureMarker"===e.cim.type){const a=s(e.size,t,r,n)*i,{image:o,width:l,height:h}=this._getPictureResource(e,a);return g={image:o,size:[l,h],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},g}l(h,i,{preserveOutlineWidth:!1}),c=h}m+=i,a&&(m+=JSON.stringify(a));const f=this._resourceCache;return f.has(m)?f.get(m):(g=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),f.set(m,g),g)}_rasterizeTextResource(e,t,i,a,r){const n=x(i,e,null),o=s(e.text,t,a,r);if(!o||0===o.length)return null;const l=s(e.fontName,t,a,r),c=s(e.style,t,a,r),m=s(e.weight,t,a,r),g=s(e.decoration,t,a,r),f=s(e.size,t,a,r)*n,d=s(e.horizontalAlignment,t,a,r),u=s(e.verticalAlignment,t,a,r),y=h(s(e.color,t,a,r)),p=h(s(e.outlineColor,t,a,r)),M={color:y,size:f,horizontalAlignment:d,verticalAlignment:u,font:{family:l,style:c,weight:m,decoration:g},halo:{size:s(e.outlineSize,t,a,r)||0,color:p,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(t,i,a,r,s,n){const o=document.createElement("canvas"),l=o.getContext("2d");o.height=e(Math.max(Math.abs(s.frame.ymax-s.frame.ymin),n)),o.width=e(Math.abs(s.frame.xmax-s.frame.xmin));const h=l.createImageData(a,r);h.data.set(new Uint8ClampedArray(i.buffer));const g=this._imageDataToCanvas(h),f=l.createPattern(g,"repeat"),d=Math.cos((-t.cim.rotation||0)*Math.PI/180),u=Math.sin((-t.cim.rotation||0)*Math.PI/180);f.setTransform({m11:d,m12:u,m21:-u,m22:d,m41:e(t.cim.offsetX)||0,m42:e(t.cim.offsetY)||0});const y=s.canvasPaths;let p,M,x;c(y)?(p=y.rings,l.fillStyle=f,M=l.fill,x=["evenodd"]):m(y)&&(p=y.paths,l.strokeStyle=f,l.lineWidth=n,M=l.stroke,p[0][0][1]=o.height/2,p[0][1][1]=o.height/2),l.beginPath();for(const c of p){const t=c?c.length:0;if(t>1){let i=c[0];l.moveTo(e(i[0]),e(i[1]));for(let a=1;a<t;++a)i=c[a],l.lineTo(e(i[0]),e(i[1]));l.closePath()}}M.apply(l,x);const C=l.getImageData(0,0,o.width,o.height),z=new Uint8Array(C.data);return{size:[o.width,o.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(t,i){const a=this._pictureMarkerCache.get(t.materialHash);if(!a)return null;const r=a.height/a.width,s=i?r>1?e(i):e(i)/r:a.width,n=i?r>1?e(i)*r:e(i):a.height;return{image:this._imageTo32Array(a,s,n),width:s,height:n}}_embedCIMLayerInVectorMarker(e,t){const i=c(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:i,symbolLayers:[e]}}]}}}function I(e,t,i,a){let r,s;return"function"==typeof e.materialHash?(r=(0,e.materialHash)(t,i,a),s=f(e.cim,e.materialOverrides)):(r=e.materialHash,s=e.cim),{analyzedCIM:s,hash:r}}export{z as CIMSymbolRasterizer,p as GeometryStyle};
//# sourceMappingURL=CIMSymbolRasterizer.da7ec585.js.map
