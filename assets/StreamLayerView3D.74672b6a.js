var e,t=Object.defineProperty,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(e,r,i)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i;import{F as a,G as n,H as c,cj as l,j2 as p,bq as d,i8 as h,B as u,D as y,ig as m,ih as f,z as g,eQ as v}from"./vendor.7103ff48.js";import{t as b,h as j}from"./createConnection.eda2f8f2.js";import{s as w,E as _}from"./EventedSet.38a06dc3.js";import{y as I}from"./FeatureFilter.92b7d1aa.js";import"./CircularArray.2b56c9c7.js";import"./Graphics3DFeatureLikeLayerView.8fc59a5c.js";import"./Graphics3DScaleVisibility.1e789161.js";import"./optimizedFeatureQueryEngineAdapter.7a815640.js";import"./centroid.f07ef5b9.js";import"./PooledRBush.78e40fd7.js";import"./Graphics3DObjectStates.87f704de.js";import"./QueryEngine.e60e2d2b.js";import"./WhereClause.fd3015dd.js";import"./projectionSupport.c5c55ada.js";import"./json.62026198.js";import"./QueryEngineCapabilities.47963c2d.js";import"./utils.eaa56ffd.js";import"./spatialQuerySupport.21a81819.js";import"./Graphics3DFrustumVisibility.283af435.js";import"./attributeUtils.808b8273.js";import"./projectExtentUtils.e211dec5.js";let O=e=class extends y{getObjectId(){return this.objectId}clone(){return new e(((e,t)=>{for(var a in t||(t={}))i.call(t,a)&&s(e,a,t[a]);if(r)for(var a of r(t))o.call(t,a)&&s(e,a,t[a]);return e})({objectId:this.objectId},this.cloneProperties()))}};a([n({type:Number,json:{read:!0}})],O.prototype,"objectId",void 0),O=e=a([c("esri.layers.graphics.controllers.StreamGraphic")],O);class S{constructor(e){this.onUpdate=e,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(e){this._idToGraphic.set(e.objectId,e)}get(e){return this._idToGraphic.get(e)}forEach(e){this._idToGraphic.forEach(e)}removeById(e){const t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=null,this._idToGraphic.delete(e),t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._idToGraphic.size}}let E=class extends(l(p(d))){constructor(){super(...arguments),this._updateInfo={websocket:0,client:0},this.graphics=new w}initialize(){this.addResolvingPromise(this.layer.when((()=>this._startup())))}destroy(){this.clear()}clear(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0),this.connection&&(this.connection.destroy(),this.connection=null),this.store&&(this.store.destroy(),this.store=null),this.graphics.clear(),this.handles.removeAll()}get updating(){return!this.connection||"connected"===this.connection.connectionStatus}_startup(){const{parsedUrl:e,spatialReference:t,definitionExpression:r,geometryDefinition:i,objectIdField:o,timeInfo:s,purgeOptions:a,maxReconnectionAttempts:n,maxReconnectionInterval:c,updateInterval:l}=this.layer,p=h.toJSON(this.layer.geometryType),d=t,u=this.layerView.view.spatialReference,y={geometry:i,where:r};this.clear(),this._set("connection",b(e,d,u,p,y,n,c)),this._outSpatialReference=u.toJSON(),this.store=new S(this._onUpdate.bind(this)),this.featuresManager=new j(this.store,o,s.toJSON(),a),this.handles.add([this.connection.on("feature",(e=>this._onFeature(e))),this.layer.watch("definitionExpression",(()=>this._startup())),this.layer.watch("geometryDefinition",(()=>this._startup())),this.layer.watch("purgeOptions",(()=>this._startup()))]);let m=performance.now();this._updateIntervalId=setInterval((()=>{const e=performance.now(),t=e-m;if(t>2500){m=e;const r=Math.round(this._updateInfo.client/(t/1e3)),i=Math.round(this._updateInfo.websocket/(t/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:r,websocket:i})}this.featuresManager.checkForUpdates()}),l)}_onFeature(e){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{u(e.geometry)&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._outSpatialReference);const t=O.fromJSON(e);t.sourceLayer=t.layer=this.layer,this.featuresManager.add(t)}catch{}}_onUpdate(e,t){u(t)&&this.graphics.removeMany(t),u(e)&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}};a([n()],E.prototype,"connection",void 0),a([n()],E.prototype,"layer",void 0),a([n()],E.prototype,"layerView",void 0),a([n({readOnly:!0})],E.prototype,"updating",null),E=a([c("esri.layers.graphics.controllers.StreamController")],E);var G=E;const x=e=>{let t=class extends e{constructor(...e){super(...e),this.connectionError=null,this.connectionStatus="disconnected",this.filter=null}};return a([n({readOnly:!0})],t.prototype,"connectionError",void 0),a([n({aliasOf:"controller.connection.connectionStatus",readOnly:!0})],t.prototype,"connectionStatus",void 0),a([n({type:I})],t.prototype,"filter",void 0),t=a([c("esri.layers.mixins.StreamLayerView")],t),t};let F=class extends(x(_(m(f)))){constructor(){super(...arguments),this.type="stream-3d",this.updatePolicy=0,this.hasZ=!0,this.hasM=!1}get connectionError(){const e=this.get("controller.connection.errorString");if(e)return new g("stream-controller",e)}createQuery(){return new v({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(e,t){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),null==t?void 0:t.signal)}createController(){return new G({layer:this.layer,layerView:this})}beforeSetController(){}};a([n({readOnly:!0})],F.prototype,"updatePolicy",void 0),a([n({readOnly:!0})],F.prototype,"connectionError",null),a([n()],F.prototype,"controller",void 0),a([n({readOnly:!0})],F.prototype,"hasZ",void 0),a([n({readOnly:!0})],F.prototype,"hasM",void 0),F=a([c("esri.views.3d.layers.StreamLayerView3D")],F);var R=F;export{R as default};
//# sourceMappingURL=StreamLayerView3D.74672b6a.js.map
