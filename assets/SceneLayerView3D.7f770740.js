import{bb as e,ig as t,B as r,M as i,bI as s,eO as n,eQ as a,fu as l,D as o,F as d,G as u,j9 as h,H as p}from"./vendor.7103ff48.js";import{WhereClause as c}from"./WhereClause.fd3015dd.js";import{z as y,u as f}from"./I3SMeshView3D.281bef64.js";import{o as g,c as v,s as F,i as m,a as b}from"./SceneLayerView.8746491d.js";import{O as w,d as _,h as S,n as j}from"./I3SQueryFeatureStore.8e7d7921.js";import{y as E}from"./I3SUtil.fa3bb0fc.js";import{p as I}from"./DefinitionExpressionSceneLayerView.53860fcb.js";import{c as C}from"./PopupSceneLayerView.abc65404.js";import{y as x}from"./FeatureFilter.92b7d1aa.js";import"./I3SAttributeOverrides.2845d552.js";import"./I3SBinaryReader.da331753.js";import"./SceneModification.76e9eced.js";import"./persistable.2e27d0f9.js";import"./Graphics3DScaleVisibility.1e789161.js";import"./optimizedFeatureQueryEngineAdapter.7a815640.js";import"./centroid.f07ef5b9.js";import"./PooledRBush.78e40fd7.js";import"./SceneLayerWorker.3656b416.js";import"./attributeUtils.808b8273.js";import"./QueryEngine.e60e2d2b.js";import"./projectionSupport.c5c55ada.js";import"./json.62026198.js";import"./QueryEngineCapabilities.47963c2d.js";import"./utils.eaa56ffd.js";import"./spatialQuerySupport.21a81819.js";import"./popupUtils.99eeb504.js";const Q=e.getLogger("esri.views.3d.layers.SceneLayerView3D"),q=b();let D=class extends(y(I(C(t(g))))){constructor(){super(...arguments),this.type="scene-layer-3d",this.lodFactor=1,this.progressiveLoadFactor=1,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._interactiveEditingSessions=new Map,this._queryEngine=null}get filter(){return r(this.viewFilter)?this.viewFilter.filter:null}set filter(e){!i(e)&&w.checkSupport(e)?r(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new w({filter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this.viewFilter=null}get requiredFields(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}get floorFilterClause(){const e=s(this);return r(e)?c.create(e,this.layer.fieldsIndex):null}get lodCrossfadeinDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeinDuration)?e:0}get lodCrossfadeoutDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeoutDuration)?e:0}get lodCrossfadeUncoveredDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService["3dObject"].lodCrossfadeUncoveredDuration)?e:0}initialize(){this.fieldsHelper=new v({layerView:this}),this.updatingHandles.add(this.layer,"rangeInfos",(e=>this._rangeInfosChanged(e)),2),this.updatingHandles.add(this.layer,"renderer",(e=>this.updatingHandles.addPromise(this._rendererChange(e))),2);for(const e of["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds","floorFilterClause"])this.updatingHandles.add(this,e,(()=>this._filterChange()));for(const e of["filter","viewFilter.parsedGeometry"])this.updatingHandles.add(this,e,(()=>this._geometryFilterChange()));this.handles.add(this.layer.on("apply-edits",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on("edits",(e=>this._handleEdits(e))))}destroy(){this.fieldsHelper=n(this.fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&Q.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return r(this.filter)?this.filter.createQuery(e):new a(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(null==e||!e.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=f(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new _({layerView:this,priority:l.FEATURE_QUERY_ENGINE,spatialIndex:new S({featureAdapter:new j({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,2),getFeatureExtent:e,sourceSpatialReference:E(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e){const t=this._highlights;if(e instanceof a){const{set:r,handle:i}=t.acquireSet();return this.queryObjectIds(e).then((e=>t.setFeatureIds(r,e))),i}return super.highlight(e)}createInteractiveEditSession(e){return F(this.attributeEditingContext,e)}_createLayerGraphic(e){const t=new o(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}getFilters(){const e=super.getFilters();return this.floorFilterClause&&this.addSqlFilter(e,this.floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),r(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}_ensureQuery(e){return this._addDefinitionExpressionToQuery(i(e)?this.createQuery():a.from(e))}get attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:e=>this._forAllNodes((t=>r(t)?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}_handleEdits(e){m(this.attributeEditingContext,e)}get hasGeometryFilter(){const e=this.viewFilter;return r(e)&&r(e.parsedGeometry)}computeNodeFiltering(e){const t=this.viewFilter;return i(t)||t.isMBSGeoemtryVisible(e,this.view.spatialReference,this._controller.crsIndex)?0:1}};d([u({aliasOf:"layer"})],D.prototype,"i3slayer",void 0),d([u()],D.prototype,"suspended",void 0),d([u(h)],D.prototype,"updatingProgress",void 0),d([u({type:x})],D.prototype,"filter",null),d([u()],D.prototype,"viewFilter",void 0),d([u(q.requiredFields)],D.prototype,"requiredFields",null),d([u(q.availableFields)],D.prototype,"availableFields",void 0),d([u()],D.prototype,"fieldsHelper",void 0),d([u()],D.prototype,"floorFilterClause",null),d([u({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],D.prototype,"lodFactor",void 0),d([u({readOnly:!0,aliasOf:"_controller.updatingProgress"})],D.prototype,"updatingProgressValue",void 0),D=d([p("esri.views.3d.layers.SceneLayerView3D")],D);var O=D;export{O as default};
//# sourceMappingURL=SceneLayerView3D.7f770740.js.map
