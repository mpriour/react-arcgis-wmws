var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i,o=(e,t)=>{for(var n in t||(t={}))a.call(t,n)&&s(e,n,t[n]);if(i)for(var n of i(t))r.call(t,n)&&s(e,n,t[n]);return e},l=(e,i)=>t(e,n(i));import{bb as c,M as d,z as u,N as f,hl as p,e6 as m,X as g,b4 as y,hR as b,b1 as w,B as h,aW as I,dE as F,hS as j,g6 as T,hT as k}from"./vendor.7103ff48.js";import{I as v,T as O,k as S}from"./geojson.80421290.js";import{u as x}from"./clientSideDefaults.35618b45.js";const N=c.getLogger("esri.layers.graphics.sources.ogcfeature");async function P(e,t,n={},i=5){const{links:a}=e,r=E(a,"items","application/geo+json")||E(a,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(d(r))throw new u("ogc-feature-layer:missing-items-page","Missing items url");const{data:s}=await f(r.href,{signal:n.signal,query:l(o({limit:i},n.customParameters),{token:n.apiKey}),headers:{accept:"application/geo+json"}});await v(s);const c=O(s,{geometryType:t.geometryType}),g=t.fields||c.fields||[],y=null!=t.hasZ?t.hasZ:c.hasZ,b=c.geometryType,w=t.objectIdField||c.objectIdFieldName||"OBJECTID";let h=t.timeInfo;const I=g.find((e=>e.name===w));if(I)I.type="esriFieldTypeOID",I.editable=!1,I.nullable=!1;else{if(!c.objectIdFieldType)throw new u("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");g.unshift({name:w,alias:w,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(w!==c.objectIdFieldName){const e=g.find((e=>e.name===c.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}g===c.fields&&c.unknownFields.length>0&&N.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:c.unknownFields}});for(const o of g){if(null==o.name&&(o.name=o.alias),null==o.alias&&(o.alias=o.name),"esriFieldTypeOID"!==o.type&&"esriFieldTypeGlobalID"!==o.type&&(o.editable=null==o.editable||!!o.editable,o.nullable=null==o.nullable||!!o.nullable),!o.name)throw new u("ogc-feature-layer:invalid-field-name","field name is missing",{field:o});if(-1===p.jsonValues.indexOf(o.type))throw new u("ogc-feature-layer:invalid-field-type",`invalid type for field "${o.name}"`,{field:o})}if(h){const e=new m(g);if(h.startTimeField){const t=e.get(h.startTimeField);t?(h.startTimeField=t.name,t.type="esriFieldTypeDate"):h.startTimeField=null}if(h.endTimeField){const t=e.get(h.endTimeField);t?(h.endTimeField=t.name,t.type="esriFieldTypeDate"):h.endTimeField=null}if(h.trackIdField){const t=e.get(h.trackIdField);t?h.trackIdField=t.name:(h.trackIdField=null,N.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:h}}))}h.startTimeField||h.endTimeField||(N.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:h}}),h=null)}return{drawingInfo:b?x(b):null,geometryType:b,fields:g,hasZ:!!y,objectIdField:w,timeInfo:h}}async function M(e,t={}){const{links:n}=e,i=E(n,"data","application/json")||E(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(d(i))throw new u("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:a,customParameters:r,signal:s}=t,{data:c}=await f(i.href,{signal:s,headers:{accept:"application/json"},query:l(o({},r),{token:a})});return c}async function q(e,t={}){const{links:n}=e,i=E(n,"conformance","application/json")||E(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(d(i))throw new u("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:a,customParameters:r,signal:s}=t,{data:c}=await f(i.href,{signal:s,headers:{accept:"application/json"},query:l(o({},r),{token:a})});return c}async function D(e,t={}){const{apiKey:n,customParameters:i,signal:a}=t,{data:r}=await f(e,{signal:a,headers:{accept:"application/json"},query:l(o({},i),{token:n})});return r}async function W(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",i=E(e.links,"service-desc",n);if(d(i))return N.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:a,customParameters:r,signal:s}=t,{data:c}=await f(i.href,{signal:s,headers:{accept:n},query:l(o({},r),{token:a})});return c}function R(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=null==t?void 0:t.groups;if(!n)return null;const{authority:i,code:a}=n;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return g.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return g.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function C(e,t,n){const i=await G(e,t,n);return y.fromJSON(i)}async function G(e,t,n){const i=await $(e,t,n);return b(i)}async function $(e,t,n){const{capabilities:{query:{maxRecordCount:i}},collection:a,layerDefinition:r,queryParameters:{apiKey:s,customParameters:c},spatialReference:p,supportedCrs:m}=e,{links:y}=a,b=E(y,"items","application/geo+json")||E(y,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(d(b))throw new u("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:v,num:O,start:x,timeExtent:N,where:P}=t;if(t.objectIds)throw new u("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const M=g.fromJSON(p),q=w(t.outSpatialReference,M),D=q.isWGS84?null:Z(q,m),W=function(e,t){if(!function(e){return h(e)&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:K(e)};const i=Z(n,t);return i?{bbox:K(e),"bbox-crs":i}:n.isWebMercator?{bbox:K(j(e,g.WGS84))}:null}(v,m),R=function(e){if(d(e))return null;const{start:t,end:n}=e;return`${h(t)?t.toISOString():".."}/${h(n)?n.toISOString():".."}`}(N),C=d(J=P)||!J||"1=1"===J?null:J,G=null!=O?O:null!=x&&void 0!==x?10:i,{data:$}=await f(b.href,l(o({},n),{query:l(o(o({},c),W),{crs:D,datetime:R,query:C,limit:G,startindex:x,token:s}),headers:{accept:"application/geo+json"}}));var J;let L=!1;if($.links){L=!!$.links.find((e=>"next"===e.rel))}!L&&Number.isInteger($.numberMatched)&&Number.isInteger($.numberReturned)&&(L=$.numberReturned<$.numberMatched);const{fields:A,globalIdField:B,hasM:_,hasZ:z,objectIdField:Q}=r,V=r.geometryType,X=S($,{geometryType:V,hasZ:z,objectIdField:Q});if(!D&&q.isWebMercator)for(const o of X)if(h(o.geometry)){const e=I(o.geometry,V,z,!1);e.spatialReference=g.WGS84,o.geometry=F(j(e,q))}for(const o of X)o.objectId=o.attributes[Q];const H=D||!D&&q.isWebMercator?q.toJSON():T,U=new k;return U.exceededTransferLimit=L,U.features=X,U.fields=A,U.geometryType=V,U.globalIdFieldName=B,U.hasM=_,U.hasZ=z,U.objectIdFieldName=Q,U.spatialReference=H,U}function Z(e,t){var n;const{isWebMercator:i,wkid:a}=e;return a?i?null!=(r=null!=(s=null!=(o=null!=(l=t[3857])?l:t[102100])?o:t[102113])?s:t[900913])?r:null:null!=(n=t[e.wkid])?n:null:null;var r,s,o,l}function K(e){if(d(e))return"";const{xmin:t,ymin:n,xmax:i,ymax:a}=e;return`${t},${n},${i},${a}`}function E(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{P as F,M as I,G as N,W as S,q as T,D as k,$ as q,C as v,R as x};
//# sourceMappingURL=ogcFeatureUtils.33065a26.js.map
