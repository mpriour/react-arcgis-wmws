var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,n=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,o=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&n(e,i,t[i]);if(s)for(var i of s(t))r.call(t,i)&&n(e,i,t[i]);return e},l=(e,s)=>t(e,i(s));import{F as d,G as h,H as c,bq as u,br as p,cn as g,fC as _,eO as m,gY as v,fN as y,l9 as w,M as b,b1 as f,la as L,lb as O,kl as P,aP as z,gI as M,lc as C,gv as S,ld as E,le as V,gx as D,lf as A,iA as x,iC as G,iI as R,iK as T,iL as j,iM as q,iN as U,iO as H,iQ as k,iS as W,lg as Q,iT as F,iW as I,iY as B,j1 as N,lh as Y,ik as Z,li as K,ir as $,fD as J,lj as X,ko as ee,lk as te,gF as ie,gE as se,ll as ae,lm as re,ii as ne,B as oe,jr as le,e8 as de,kf as he,fd as ce,ln as ue,lo as pe,fF as ge,lp as _e,gC as me,gA as ve,ij as ye,lq as we,lr as be,ls as fe,cq as Le,lt as Oe,lu as Pe,gZ as ze,lv as Me,dS as Ce,lw as Se,lx as Ee,ly as Ve,ig as De,ih as Ae}from"./vendor.7103ff48.js";import{t as xe,e as Ge,m as Re,M as Te,R as je,v as qe,f as Ue,_ as He,l as ke,g as We,h as Qe,b as Fe,a as Ie,s as Be,k as Ne,c as Ye,d as Ze}from"./viewUtils.819cf53c.js";import{geodesicLength as Ke}from"./geometryEngine.2f06c96c.js";import{c as $e,m as Je}from"./LineVisualElement.a7c721d3.js";let Xe=class extends u{constructor(e){super(e),this._unitNormalizer=new xe,this._handles=new p,this._tempStartPosition=g(),this._tempEndPosition=g(),this._tempCornerPosition=g()}initialize(){this._handles.add(_(this.view,"ready",(()=>this._initialize()),!0))}destroy(){this._handles=m(this._handles)}_initialize(){const e=this.view.spatialReference,t=v(e),i=t===E?V:t;this._sphericalPCPF=i;const s=y(e,i);this._unitNormalizer.spatialReference=s?i:e,this._handles.add([w((()=>({viewData:this.viewData,startPoint:this.layer.startPoint})),(({viewData:e,startPoint:t})=>{e.elevationAlignedStartPoint=this._applyElevationAlignment(t)})),w((()=>({viewData:this.viewData,endPoint:this.layer.endPoint})),(({viewData:e,endPoint:t})=>{e.elevationAlignedEndPoint=this._applyElevationAlignment(t)})),w((()=>({result:this._computedResult,viewData:this.viewData})),(({result:e,viewData:t})=>{t.result=e}))])}_applyElevationAlignment(e){if(b(e)||e.hasZ)return e;const t=e.clone();return t.z=f(L(this.view.elevationProvider,t),0),t}get _computedResult(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.viewData;if(b(e)||b(t))return null;const i=this._euclideanDistances(e,t),s=this._exactGeodesicDistanceAndAngle(e,t,i.horizontal.value);return{directDistance:i.direct,horizontalDistance:i.horizontal,verticalDistance:i.vertical,geodesicDistance:s.distance,geodesicAngle:s.angle}}_euclideanDistances(e,t){const i=e.clone();i.z=t.z;const s=this._tempStartPosition,a=this._tempEndPosition,r=this._tempCornerPosition,n=this.view.spatialReference,o=this._sphericalPCPF,l=y(n,o)?o:n;O(e,s,l),O(t,a,l),O(i,r,l);const d=P(s,a),h=P(r,a),c=Math.abs(t.z-e.z),u=e=>this._unitNormalizer.normalizeDistance(e),p=u(d),g=u(h),_=u(c);return{direct:new Ge(p,"meters"),horizontal:new Ge(g,"meters"),vertical:new Ge(_,"meters")}}_exactGeodesicDistanceAndAngle(e,t,i){const s=e.spatialReference,a=new z({spatialReference:s});a.addPath([e,t]);const r=s.isGeographic&&Re(s)?Te([a],"meters")[0]:s.isWebMercator?Ke(a,"meters"):void 0,{distance:n,angle:o}=r?{distance:r,angle:this._fallbackGeodesicAngle(r,s)}:this._fallbackGeodesicDistance(e,t,i);return{distance:new Ge(n,"meters"),angle:new Ge(o,"degrees")}}_fallbackGeodesicAngle(e,t){return e/M(t).metersPerDegree}_fallbackGeodesicDistance(e,t,i){if(C(e,et)){C(t,tt);const e=S(et[0]),i=S(et[1]),s=S(tt[0]),a=S(tt[1]),r=Math.abs(s-e),n=A(Math.sin(i)*Math.sin(a)+Math.cos(i)*Math.cos(a)*Math.cos(r)),o=D(n),l={distance:0};return je(l,[et[0],et[1]],[tt[0],tt[1]]),{distance:l.distance,angle:o}}const s=e.spatialReference,a=i;return{distance:a,angle:this._fallbackGeodesicAngle(a,s)}}};d([h()],Xe.prototype,"view",void 0),d([h()],Xe.prototype,"layer",void 0),d([h()],Xe.prototype,"viewData",void 0),d([h()],Xe.prototype,"_computedResult",null),Xe=d([c("esri.views.3d.layers.analysis.DirectLineMeasurement/DirectLineMeasurementController")],Xe);const et=g(),tt=g();function it(){const e=new x;e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("width","float"),e.attributes.add("position","vec3"),e.attributes.add("normal","vec3"),e.attributes.add("uv0","vec2"),e.attributes.add("auxpos1","float"),e.varyings.add("vtc","vec2"),e.varyings.add("vlength","float"),e.varyings.add("vradius","float"),e.vertex.code.add(G`void main(void) {
vec3 bitangent = normal;
vtc = uv0;
vlength = auxpos1;
vradius = 0.5 * width;
vec4 pos = view * vec4(position + vradius * bitangent * uv0.y, 1.0);
gl_Position = proj * pos;
}`),e.fragment.uniforms.add("outlineSize","float").add("outlineColor","vec4").add("stripeLength","float").add("stripeEvenColor","vec4").add("stripeOddColor","vec4");const t=1/Math.sqrt(2);return e.fragment.code.add(G`
    const float INV_SQRT2 = ${G.float(t)};

    vec4 arrowColor(vec2 tc, float len) {
      float d = INV_SQRT2 * (tc.x - abs(tc.y));
      d = min(d, INV_SQRT2 * (len - tc.x - abs(tc.y)));
      d = min(d, 1.0 - abs(tc.y));

      if (d < 0.0) {
        return vec4(0.0);
      } else if (d < outlineSize) {
        return outlineColor;
      } else {
        return fract(0.5 / stripeLength * tc.x * vradius) >= 0.5 ? stripeOddColor : stripeEvenColor;
      }
    }

    void main(void) {
      vec2 ntc = vec2(vtc.x / vradius, vtc.y);
      vec4 color = arrowColor(ntc, vlength / vradius);
      if (color.a == 0.0) {
        discard;
      }
      gl_FragColor = color;
    }
  `),e}var st=Object.freeze({__proto__:null,build:it});class at extends j{constructor(e,t,i){super(e,t,i)}initializeProgram(e){const t=at.shader.get().build();return new q(e.rctx,t,U)}bindPass(e,t){H(this.program,t.camera.projectionMatrix),this.program.setUniform1f("width",e.width),this.program.setUniform1f("outlineSize",e.outlineSize),this.program.setUniform4fv("outlineColor",e.outlineColor),this.program.setUniform1f("stripeLength",e.stripeLength),this.program.setUniform4fv("stripeEvenColor",e.stripeEvenColor),this.program.setUniform4fv("stripeOddColor",e.stripeOddColor)}bindDraw(e){k(this.program,e),this.program.rebindTextures()}setPipelineState(e){const t=3===e,i=this.configuration;return W({blending:i.transparent?t?Q:F(e):null,polygonOffset:this.configuration.polygonOffsetEnabled&&{factor:0,units:-4},depthTest:{func:513},depthWrite:I,colorWrite:B})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 5}}at.shader=new R(st,(()=>import("./MeasurementArrow.glsl.c6c3bc3f.js")));class rt extends N{constructor(){super(...arguments),this.polygonOffsetEnabled=!1,this.transparent=!1,this.transparencyPassType=3}}d([T()],rt.prototype,"polygonOffsetEnabled",void 0),d([T()],rt.prototype,"transparent",void 0),d([T({count:4})],rt.prototype,"transparencyPassType",void 0);class nt extends Z{constructor(e){super(e,lt),this.techniqueConfig=new rt}getTechniqueConfig(e){return this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset,this.techniqueConfig.transparent=this.params.stripeEvenColor[3]<1||this.params.stripeOddColor[3]<1||this.params.outlineColor[3]<1,this.techniqueConfig.transparencyPassType=e?e.transparencyPassType:3,this.techniqueConfig}dispose(){}getPassParameters(){return this.params}intersect(){}createBufferWriter(){return new _t}getGLMaterial(e){return 0===e.output?new ot(e):void 0}}class ot extends K{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(at,this._material.getTechniqueConfig(e),this._technique)}beginSlot(e){return 3===e}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}}const lt=o({width:32,outlineSize:.2,outlineColor:[1,.5,0,1],stripeLength:1,stripeEvenColor:[1,1,1,1],stripeOddColor:[1,.5,0,1],polygonOffset:!1},$),dt=Y().vec3f("position").vec3f("normal").vec2f("uv0").f32("auxpos1"),ht=g(),ct=g(),ut=g(),pt=g(),gt=g();class _t{constructor(){this.vertexBufferLayout=dt}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 2*(e.indices.get("position").length/2+1)}write(e,t,i,s){const a=t.vertexAttributes.get("position").data,r=t.vertexAttributes.get("normal").data,n=a.length/3,o=t&&t.indices&&t.indices.get("position");o&&o.length!==2*(n-1)&&console.warn("MeasurementArrowMaterial does not support indices");const l=ht,d=ct,h=ut,c=pt,u=gt,p=e.transformation,g=e.invTranspTransformation,_=i.position,m=i.normal,v=i.uv0;let y=0;for(let b=0;b<n;++b){const e=3*b;if(J(l,a[e],a[e+1],a[e+2]),b<n-1){const e=3*(b+1);J(d,a[e],a[e+1],a[e+2]),J(u,r[e],r[e+1],r[e+2]),X(u,u),ee(h,d,l),X(h,h),te(c,u,h),X(c,c)}const t=P(l,d);p&&g&&(ie(l,l,p),ie(d,d,p),ie(c,c,g));const i=s+2*b,o=i+1;_.setVec(i,l),_.setVec(o,l),m.setVec(i,c),m.setVec(o,c),v.set(i,0,y),v.set(i,1,-1),v.set(o,0,y),v.set(o,1,1),b<n-1&&(y+=t)}const w=i.auxpos1;for(let b=0;b<2*n;++b)w.set(s+b,y)}}class mt extends $e{constructor(e){super(e),this._parameters=vt,this._handles=null,this._origin=g(),this._originTransform=se(),this._arrowCenter=g(),this._renderOccluded=4,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._opacity=1,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameterValues({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameterValues({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:i}=this._parameters,s=ae(yt,this._stripesEnabled?t:i,e);this._arrowMaterial.setParameterValues({stripeEvenColor:s})}}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}createExternalResources(){const{arrowStripeEvenColor:e,arrowStripeOddColor:t,arrowOutlineColor:i}=this._parameters,s=this._stripesEnabled?e:t;this._arrowMaterial=new nt({outlineColor:i,stripeEvenColor:s,stripeOddColor:t,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new p,this._handles.add(this.view.state.watch("camera",(()=>{this.viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(b(this._geometry)||b(this._geometry.startRenderSpace)||b(this._geometry.endRenderSpace))return;const t=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(t,this._arrowMaterial,this._originTransform),this.viewChanged()}_createArrowGeometry(e,t,i,s){const a=this.view.renderCoordsHelper,r=[],n=[],o=(e,t)=>{const s=re.get();ee(s,e,i),r.push(s),n.push(t)};if("euclidean"===s.type){s.eval(.5,this._arrowCenter);const i=re.get();a.worldUpAtPosition(this._arrowCenter,i),o(e,i),o(t,i)}else{s.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let t=0;t<e;++t){const i=t/(e-1),r=re.get(),n=re.get();s.eval(i,r),a.worldUpAtPosition(r,n),o(r,n)}}return ne.createPolylineGeometry(r,n)}geometryChanged(){this.recreateGeometry()}viewChanged(){if(this.view.ready&&this.attached&&oe(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameterValues({width:this._parameters.arrowWidth*e})}}_updateArrowOpacity(){const e=this.opacity,{arrowStripeEvenColor:t,arrowStripeOddColor:i,arrowOutlineColor:s}=this._parameters,a=ae(yt,this._stripesEnabled?t:i,e),r=ae(wt,s,e),n=ae(bt,i,e);this._arrowMaterial.setParameterValues({stripeEvenColor:a,outlineColor:r,stripeOddColor:n})}}const vt={arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128},yt=le(),wt=le(),bt=le();class ft extends $e{constructor(e){super(e),this._handles=new p,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=g(),this._up=g(),this._right=g(),this._renderOccluded=4,this._color=de(1,0,0,1),this._outlineColor=de(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=16,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){he(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){he(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=0===this._outlineSize!=(0===e);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:i}){this._maxSize=Math.min(P(t,e),P(t,i))/3,X(this._up,ee(this._up,e,t)),X(this._right,ee(this._right,i,t)),ce(this._position,t),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new ue(this.quadMaterialParameters),this._outlineMaterial=new pe(this.outlineMaterialParameters),this._handles.add(this.view.state.watch("camera",(()=>this._updateTransform())))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const t=this._quadGeometryData(this._up,this._right);e.addGeometry(t,this._quadMaterial)}_createOutlineGeometry(e){if(0===this._outlineSize)return;const t=ge(re.get(),this._up,this._right),i=ne.createPolylineGeometry([this._up,t,this._right]);e.addGeometry(i,this._outlineMaterial)}_updateTransform(e=this.object){const t=this.view.state.camera,i=this._size*t.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,i);_e(Lt),me(Lt,Lt,this._position),ve(Lt,Lt,[s,s,s]),oe(e)&&(e.transformation=Lt)}_quadGeometryData(e,t){const i=ge(re.get(),e,t);return new ye([["position",{size:3,data:[0,0,0,...t,...e,...i],exclusive:!0}]],[["position",new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameterValues(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameterValues(this.outlineMaterialParameters)}}const Lt=se();let Ot=class extends u{constructor(e){super(e),this._params=o({},zt),this._handles=new p,this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=g(),this._endPosition=g(),this._cornerPosition=g(),this._startPositionAtSeaLevel=g(),this._endPositionAtSeaLevel=g(),this._state=0,this._segmentLabelDisplayedMeasurement=1,this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.viewMode=0,this.visualizedMeasurement=0,this.actualVisualizedMeasurement=1,this.visualElementOrientation=0,this.triangleCollapseRatioThreshold=.03}get _geodesicDistanceExceeded(){var e;const t=this.layerView.result;return oe(t)&&(null==(e=t.horizontalDistance)?void 0:e.value)>this.layer.geodesicDistanceThreshold}get ready(){return 1===this._state}get visible(){return this.layerView.visible&&!this.layerView.suspended}get allowVisualElementsOrientationChange(){return b(this._triangleOrientationOverride)}set allowVisualElementsOrientationChange(e){b(this._triangleOrientationOverride)!==e&&(b(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._getActualVisualElementsOrientation():this._triangleOrientationOverride=null)}get labels(){const e=2===this.actualVisualizedMeasurement;return{direct:this._segmentLabel,horizontal:e?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}get testData(){var e;return{labels:this.labels,stripeLength:null==(e=this._segmentVisualElement)?void 0:e.stripeLength}}initialize(){this._handles.add(_(this.view,"ready",(()=>this._initialize()),!0))}_initialize(){switch(this._state){case 1:throw new Error("invalid state");case 2:return}const e=this._params,t={attached:!0,view:this.view};this._segmentVisualElement=new mt(l(o({},t),{geometry:null,renderOccluded:4})),this._triangleVisualElement=new Je(l(o({},t),{width:e.triangleLineWidth,color:e.triangleColor,renderOccluded:4})),this._rightAngleQuad=new ft(l(o({},t),{color:Pt,renderOccluded:4}));const i=l(o({},t),{polygonOffset:!0,stippleIntegerRepeats:!1,renderOccluded:4});this._projectedGeodesicLine=new Je(l(o({},i),{width:e.geodesicProjectionLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:we(e.guideStippleLengthPixels)})),this._geodesicStartHint=new Je(l(o({},i),{width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:we(e.guideStippleLengthPixels)})),this._geodesicEndHint=new Je(l(o({},i),{width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:we(e.guideStippleLengthPixels)})),this._segmentLabel=new qe(l(o({},t),{fontSize:e.direcLabelFontSize})),this._verticalLabel=new qe(l(o({},t),{fontSize:e.verticalLabelFontSize})),this._horizontalLabel=new qe(l(o({},t),{fontSize:e.horizontalLabelFontSize})),this._handles.add([be((()=>this._updateGeometryAndViewMode())),be((()=>this._updateVisualElementVisibility())),w((()=>this.layerView.fullOpacity),(()=>this._updateVisualElementsOpacity())),be((()=>this._updateLabelText())),be((()=>this._updateLabelVisibility())),be((()=>this._updateSegmentStripeLength())),fe((async()=>this._updateMessageBundle()))]),this._state=1,this._updateMessageBundle()}destroy(){2!==this._state&&(this._handles=m(this._handles),this._segmentVisualElement=m(this._segmentVisualElement),this._triangleVisualElement=m(this._triangleVisualElement),this._rightAngleQuad=m(this._rightAngleQuad),this._projectedGeodesicLine=m(this._projectedGeodesicLine),this._geodesicStartHint=m(this._geodesicStartHint),this._geodesicEndHint=m(this._geodesicEndHint),this._segmentLabel=m(this._segmentLabel),this._verticalLabel=m(this._verticalLabel),this._horizontalLabel=m(this._horizontalLabel),this.set("view",null),this._state=2)}async whenReady(){await _(this,"ready")}_updateVisualElementVisibility(){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,this.visible)switch(this.viewMode){case 0:break;case 1:this._segmentVisualElement.visible=!0;break;case 2:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case 3:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode(){const e=this.view.renderCoordsHelper,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=this.layerView;if(b(t)||b(i)||t.equals(i)){this.viewMode=0;const e=this.visualizedMeasurement,t=0===e;return void(this.actualVisualizedMeasurement=t?1:e)}e.toRenderCoords(t,this._startPosition),e.toRenderCoords(i,this._endPosition);const s=this._getActualVisualElementsOrientation(),a=this._updateActualVisualizedMeasurement();this.viewMode=this._computeViewMode(a);let r=this._startPosition,n=this._endPosition;const o=1===s?1:-1,l=o*(e.getAltitude(n)-e.getAltitude(r));l<0&&(r=this._endPosition,n=this._startPosition);const d=2===a?new Ue(this._startPosition,this._endPosition,e.spatialReference):new He(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=d,this._updateSegmentStripeLength(),this._segmentLabelDisplayedMeasurement=a,this.viewMode){case 1:this._updateSegment(d,s);break;case 2:this._updateSegmentAndTriangle(d,s,r,n,o,l);break;case 3:this._updateSegmentAndProjection(s)}}_updateSegment(e,t){this._segmentLabel.anchor=1===t?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}}_updateSegmentAndTriangle(e,t,i,s,a,r){const n=this.view,o=n.renderCoordsHelper,l=n.state.camera,d=this._cornerPosition;o.worldUpAtPosition(i,d),Le(d,d,a*Math.abs(r)),ge(d,d,i),this._triangleVisualElement.geometry=[[[i[0],i[1],i[2]],[d[0],d[1],d[2]],[s[0],s[1],s[2]]]],this._rightAngleQuad.geometry={previous:i,center:d,next:s};const h=new He(i,d),c=new He(d,s),u=function(e,t,i,s,a){const r=St,n=Et;a.projectToRenderScreen(i,r),a.projectToRenderScreen(t,n);const o={segment:"bottom",horizontal:"top",vertical:r[0]<n[0]?"left":"right"};{const s=Vt,r=Dt;if(Ne(e,i,s,a),Ne(e,t,r,a),Ce(s,r)>=Mt){const e=Se(s[1])===Se(r[1]);o.segment=e?Ye(o.vertical):o.vertical}else{const e=At;Ne(i,t,e,a),Ce(e,r)>=Mt&&(o.segment=Se(e[0])===Se(r[0])?Ye(o.horizontal):o.horizontal)}}if(2===s){const e=e=>"top"===e?"bottom":"top";o.segment=e(o.segment),o.horizontal=e(o.horizontal),o.vertical=e(o.vertical)}return o}(i,s,d,t,l);this._segmentLabel.anchor=u.segment,this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:h,sampleLocation:"center"},this._verticalLabel.anchor=u.vertical,this._horizontalLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._horizontalLabel.anchor=u.horizontal}_updateSegmentAndProjection(e){const t=this.view.renderCoordsHelper;t.setAltitude(this._startPositionAtSeaLevel,0,this._startPosition),t.setAltitude(this._endPositionAtSeaLevel,0,this._endPosition);const i=new Ue(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(i),this._geodesicStartHint.setGeometryFromSegment(new He(this._startPositionAtSeaLevel,this._startPosition)),this._geodesicEndHint.setGeometryFromSegment(new He(this._endPositionAtSeaLevel,this._endPosition)),this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._segmentLabel.anchor=1===e?"top":"bottom"}_updateLabelText(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,i=this._verticalLabel,s=this.messages,a=this.layerView.result;if(b(a)||b(s))return e.text=null,t.text=null,void(i.text=null);const r=this._getLabelsText(s,a),n=1===this._segmentLabelDisplayedMeasurement;e.text=n?r.euclideanDistance:r.geodesicDistance,t.text=r.horizontalDistance,i.text=r.verticalDistance,this.notifyChange("labels")}_updateLabelVisibility(){if(1!==this._state)return;const e=this._segmentLabel,t=this._horizontalLabel,i=this._verticalLabel;if(e.visible=!1,t.visible=!1,i.visible=!1,this.visible)switch(this.viewMode){case 1:e.visible=!0;break;case 2:e.visible=!0,t.visible=!0,i.visible=!0;break;case 3:e.visible=!0}}_getLabelsText(e,{directDistance:t,horizontalDistance:i,verticalDistance:s,geodesicDistance:a,geodesicAngle:r}){const n=this.layerView.unit,l=e=>o({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:""},e);switch(n){case"metric":return l({euclideanDistance:t&&Ie(e,t),geodesicDistance:a&&Ie(e,a),horizontalDistance:i&&Ie(e,i),verticalDistance:s&&Be(e,s)});case"imperial":return l({euclideanDistance:t&&Qe(e,t),geodesicDistance:a&&Qe(e,a),horizontalDistance:i&&Qe(e,i),verticalDistance:s&&Fe(e,s)});case"degrees":{const t=r&&ke(e,r,"degrees");return l({euclideanDistance:t,geodesicDistance:t,horizontalDistance:t})}case"degrees-minutes-seconds":return l({horizontalDistance:r&&We(r)});default:return l({euclideanDistance:t&&ke(e,t,n),geodesicDistance:a&&ke(e,a,n),horizontalDistance:i&&ke(e,i,n),verticalDistance:s&&ke(e,s,n)})}}_updateSegmentStripeLength(){const e=this._measurementArrowStripeLength,t=this._segmentVisualElement;oe(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1}_computeViewMode(e){if(2===e){if(!this._geodesicDistanceExceeded)return 1;if(this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition))return 3}const t=this.layerView.result;if(b(t))return 1;const{verticalDistance:i,horizontalDistance:s}=t,a=i.value,r=s.value;return Math.min(a/r,r/a)<this.triangleCollapseRatioThreshold?1:2}_getActualVisualElementsOrientation(){if(oe(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return 0===e?this.view.state.camera.aboveGround?1:2:e}_updateActualVisualizedMeasurement(){if(0===this.visualizedMeasurement){this.actualVisualizedMeasurement=1;const e=this.layerView.unit;"degrees"!==e&&"degrees-minutes-seconds"!==e||(this.actualVisualizedMeasurement=2),this._geodesicDistanceExceeded&&(this.actualVisualizedMeasurement=2)}else this.actualVisualizedMeasurement=this.visualizedMeasurement;return this.actualVisualizedMeasurement}_requiresGeodesicGuideAt(e){const t=this.view;if(!t.state)return!1;const i=t.state.camera,s=t.renderCoordsHelper,a=i.computeScreenPixelSizeAt(e);return s.getAltitude(e)/a>=10}get _measurementArrowStripeLength(){const e=this.view,{result:t,unit:i}=this.layerView;let s=null;if(oe(t)){const e=t.directDistance;switch(i){case"metric":s=e&&e.toUnit("meters");break;case"imperial":s=e&&e.toUnit(Oe(e.value,e.unit));break;case"degrees":case"degrees-minutes-seconds":{const e=t.geodesicAngle;s=e&&e.toUnit("degrees");break}default:s=e&&e.toUnit(i)}}if(s){let t=1;return t=Pe(s.value/30),t*="degrees"===s.unit?M(e.spatialReference).metersPerDegree:ze(1,s.unit,"meters"),t}return null}_updateMessageBundle(){this.loadingMessages=!0,Me("esri/core/t9n/Units").then((e=>{this.messages=e,this.view&&this._updateLabelText()})).finally((()=>{this.loadingMessages=!1}))}_updateVisualElementsOpacity(){const e=this.layerView.fullOpacity,t=this._params,{triangleColor:i,geodesicProjectionLineColor:s}=t;this._triangleVisualElement.color=ae(Ct,i,e),this._rightAngleQuad.color=ae(Ct,Pt,e),ae(Ct,s,e),this._projectedGeodesicLine.color=Ct,this._geodesicStartHint.color=Ct,this._geodesicEndHint.color=Ct,this._segmentVisualElement.opacity=e}};d([h()],Ot.prototype,"_state",void 0),d([h()],Ot.prototype,"_segmentLabelDisplayedMeasurement",void 0),d([h()],Ot.prototype,"_triangleOrientationOverride",void 0),d([h()],Ot.prototype,"_geodesicDistanceExceeded",null),d([h()],Ot.prototype,"messages",void 0),d([h()],Ot.prototype,"view",void 0),d([h()],Ot.prototype,"layer",void 0),d([h()],Ot.prototype,"layerView",void 0),d([h({readOnly:!0})],Ot.prototype,"ready",null),d([h()],Ot.prototype,"loadingMessages",void 0),d([h({readOnly:!0})],Ot.prototype,"visible",null),d([h()],Ot.prototype,"viewMode",void 0),d([h()],Ot.prototype,"visualizedMeasurement",void 0),d([h()],Ot.prototype,"actualVisualizedMeasurement",void 0),d([h()],Ot.prototype,"visualElementOrientation",void 0),d([h()],Ot.prototype,"triangleCollapseRatioThreshold",void 0),d([h()],Ot.prototype,"allowVisualElementsOrientationChange",null),d([h()],Ot.prototype,"labels",null),d([h()],Ot.prototype,"testData",null),d([h()],Ot.prototype,"_measurementArrowStripeLength",null),Ot=d([c("esri.views.3d.layers.DirectLineMeasurement.DirectLineMeasurementView")],Ot);const Pt=de(1,.5,0,.75),zt={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:Pt,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:Pt,guideLineWidth:2,guideLineColor:Pt,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},Mt=Math.cos(S(12)),Ct=le(),St=Ee(),Et=Ee(),Vt=Ve(),Dt=Ve(),At=Ve();let xt=class extends(De(Ae)){constructor(e){super(e),this._userUnit=null,this.type="direct-line-measurement-3d",this.result=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}set unit(e){this._userUnit=e}get unit(){return f(this._userUnit,this._defaultUnit)}get viewMode(){return this._analysisView.viewMode}get visualizedMeasurement(){return this._analysisView.visualizedMeasurement}set visualizedMeasurement(e){this._analysisView.visualizedMeasurement=e}get actualVisualizedMeasurement(){return this._analysisView.actualVisualizedMeasurement}get visualElementOrientation(){return this._analysisView.visualElementOrientation}set visualElementOrientation(e){this._analysisView.visualElementOrientation=e}get allowVisualElementsOrientationChange(){return this._analysisView.allowVisualElementsOrientationChange}set allowVisualElementsOrientationChange(e){this._analysisView.allowVisualElementsOrientationChange=e}get triangleCollapseRatioThreshold(){return this._analysisView.triangleCollapseRatioThreshold}set triangleCollapseRatioThreshold(e){this._analysisView.triangleCollapseRatioThreshold=e}get directLabelText(){return this._analysisView.labels.direct.text}get horizontalLabelText(){return this._analysisView.labels.horizontal.text}get verticalLabelText(){return this._analysisView.labels.vertical.text}get testData(){var e;return this.destroyed?{labels:null,stripeLength:null,view:null,controller:null}:l(o({},null==(e=this._analysisView)?void 0:e.testData),{view:this._analysisView,controller:this._analysisController})}initialize(){const e=this.view,t=this.layer;this._analysisView=new Ot({view:e,layer:t,layerView:this}),this._analysisController=new Xe({view:e,layer:t,viewData:this})}destroy(){m(this._analysisController),m(this._analysisView)}whenReady(){return this._analysisView.whenReady()}isUpdating(){var e;return!(null==(e=this._analysisView)||!e.loadingMessages)}};d([h(Ze)],xt.prototype,"_defaultUnit",void 0),d([h()],xt.prototype,"_userUnit",void 0),d([h()],xt.prototype,"_analysisView",void 0),d([h()],xt.prototype,"_analysisController",void 0),d([h()],xt.prototype,"type",void 0),d([h()],xt.prototype,"unit",null),d([h()],xt.prototype,"layer",void 0),d([h()],xt.prototype,"result",void 0),d([h()],xt.prototype,"elevationAlignedStartPoint",void 0),d([h()],xt.prototype,"elevationAlignedEndPoint",void 0),d([h({readOnly:!0})],xt.prototype,"viewMode",null),d([h()],xt.prototype,"visualizedMeasurement",null),d([h({readOnly:!0})],xt.prototype,"actualVisualizedMeasurement",null),d([h()],xt.prototype,"visualElementOrientation",null),d([h()],xt.prototype,"allowVisualElementsOrientationChange",null),d([h()],xt.prototype,"triangleCollapseRatioThreshold",null),d([h({readOnly:!0})],xt.prototype,"directLabelText",null),d([h({readOnly:!0})],xt.prototype,"horizontalLabelText",null),d([h({readOnly:!0})],xt.prototype,"verticalLabelText",null),d([h()],xt.prototype,"testData",null),xt=d([c("esri.views.3d.layers.DirectLineMeasurementLayerView3D")],xt);var Gt=xt,Rt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Gt});export{Rt as D,it as o};
//# sourceMappingURL=DirectLineMeasurementLayerView3D.15ed5930.js.map
