import{bo as t,cI as e,fZ as s,ft as i,f_ as a,f$ as r,g0 as h,g1 as n,F as o,G as c,H as d,bq as l,br as p,ab as g,fu as y,B as m,a8 as S}from"./vendor.7103ff48.js";class u{constructor(){this._extents=new t({allocator:t=>t||e()}),this._tmpExtent=e(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(t){this.contains(t)||(this.removeContained(t),s(this._extents.pushNew(),t),this._dirty=!0)}pop(){return this._dirty&&this.mergeTight(),this._extents.pop()}merge(t){return this.mergeTight(t),t.hasProgressed}mergeTight(t=i){const e=this._extents,h=new Set;let n=0;for(;n!==e.length;){e.sort(((t,e)=>t[0]-e[0])),n=e.length,h.clear();for(let i=0;i<e.length;++i){if(t.done)return;const n=e.getItemAt(i);for(let t=i+1;t<e.length;++t){const s=e.getItemAt(t);if(s[0]>=n[2])break;h.add(s)}h.forEach((i=>{if(n===i)return;if(i[2]<=n[0])return void h.delete(i);const o=a(n),c=a(i),d=this._tmpExtent;r(n,i,d);const l=o+c;(a(d)-l)/l<.05&&(s(n,d),h.delete(i),e.remove(i),t.madeProgress())})),h.add(n)}}this._dirty=!1}contains(t){return this._extents.some((e=>h(e,t)))}removeContained(t){this._extents.filterInPlace((e=>!h(t,e)))}get test(){const t=this;return{containsPoint:e=>t._extents.some((t=>n(t,e)))}}}let v=class extends l{constructor(){super(...arguments),this.dirtyExtents=new u,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new p,this.updateElevation=!1,this.layerView=null,this.graphicsCore=null,this.events=new g}setup(t,e,s,i){this.layerView=t,this.queryGraphicUIDsInExtent=e,this.graphicsCore=s,this.elevationProvider=i;const a=this.layerView.view.resourceController.scheduler;this.handles.add([i.on("elevation-change",(t=>this._elevationChanged(t))),this.layerView.watch("suspended",(()=>this.suspendedChange())),a.registerTask(y.ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}suspendedChange(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(t){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,t.madeProgress()),t.run((()=>this.dirtyExtents.merge(t)));this.running&&!t.done;)this._updateDirtyGraphics(t),this._updateDirtyExtents(t);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(t){const e=this.layerView.view.renderCoordsHelper,s=0===this.graphicsCore.effectiveUpdatePolicy;for(const i of this.dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(i);if(this.dirtyGraphicsSet.delete(i),m(a)&&(a.alignWithElevation(this.elevationProvider,e,s),t.madeProgress()),t.done)return}}_updateDirtyExtents(t){for(;!this.dirtyExtents.empty&&!t.done;){const e=this.dirtyExtents.pop(),s=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:e,spatialReference:s});const i=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(e,s,(t=>{const e=this.graphicsCore.getGraphics3DGraphicById(t);m(e)&&e.needsElevationUpdates()&&this.dirtyGraphicsSet.add(t)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-i)+.9*this.averageExtentUpdateSize,t.madeProgress()}}markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((t,e)=>this.dirtyGraphicsSet.add(e)))}_elevationChanged(t){if("scene"===t.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:e,spatialReference:s}=t;if(this.layerView.suspended){if(!this.updateElevation){const t=this.graphicsCore.computedExtent;t&&e[2]>t.xmin&&e[0]<t.xmax&&e[3]>t.ymin&&e[1]<t.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:e,spatialReference:s})}else e[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(e),this.notifyChange("updating")}};o([c({readOnly:!0})],v.prototype,"updating",null),o([c({readOnly:!0})],v.prototype,"updatingRemaining",null),v=o([d("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],v);var b=v;class f{constructor(){this.items=[]}addObject(t,e){this.items.push({type:0,objectStateId:e,object:t})}addRenderGeometry(t,e,s){this.items.push({type:1,objectStateId:e,renderGeometry:t,owner:s})}addExternal(t,e){this.items.push({type:2,objectStateId:e,remove:t})}remove(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];s.objectStateId===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeObject(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];0===s.type&&s.object===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeRenderGeometry(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];1===s.type&&s.renderGeometry===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeAll(){this.items.forEach((t=>{this._removeObjectStateItem(t)})),this.items=[]}_removeObjectStateItem(t){switch(t.type){case 0:0===t.objectStateId.channel?t.object.removeHighlight(t.objectStateId):1===t.objectStateId.channel&&t.object.removeOcclude(t.objectStateId);break;case 1:t.owner.removeRenderGeometryObjectState(t.renderGeometry,t.objectStateId);break;case 2:t.remove(t.objectStateId)}}}class _{constructor(t,e){this.stateType=t,this.objectIdField=e,this.objectStateSet=new f,this.ids=new Set,this.paused=!1}hasGraphic(t){if(this.objectIdField){const e=t.graphic.attributes[this.objectIdField];return this.ids.has(e)}return this.ids.has(t.graphic.uid)}}class E{constructor(t){this._graphicsCore=t,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll())),this._stateSets=null}acquireSet(t,e){const s=new _(t,e);this._stateSets.push(s);const i=S((()=>this.releaseSet(s)));return{set:s,handle:i}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;-1!==e&&this._stateSets.splice(e,1)}_addObjectStateSet(t,e){t.addObjectStateSet(e.stateType,e.objectStateSet)}_removeObjectStateSet(t,e){t.removeObjectState(e.objectStateSet)}setUid(t,e){t.ids.add(e);const s=this._graphicsCore.graphics3DGraphics.get(e);s&&this._addObjectStateSet(s,t)}setUids(t,e){e.forEach((e=>this.setUid(t,e)))}setObjectIds(t,e){e.forEach((e=>t.ids.add(e))),this.initializeSet(t)}addGraphic(t){this._stateSets.forEach((e=>{!e.paused&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)}))}removeGraphic(t){this._stateSets.forEach((e=>{e.hasGraphic(t)&&this._removeObjectStateSet(t,e)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll()))}initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach((e=>{e&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)})):t.ids.forEach((s=>{const i=e.get(s);i&&this._addObjectStateSet(i,t)}))}get test(){return{states:this._stateSets}}}export{b as d,E as s};
//# sourceMappingURL=Graphics3DObjectStates.87f704de.js.map
