{"version":3,"file":"WFSSourceWorker.d70fa492.js","sources":["../../node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Error.js\";import t from\"../../../core/Logger.js\";import{isSome as r,unwrap as s}from\"../../../core/maybe.js\";import{throwIfAborted as a,createTask as i,isAbortError as n}from\"../../../core/promiseUtils.js\";import{equals as o,WGS84 as u}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as p,convertToGeometry as h}from\"../featureConversionUtils.js\";import y from\"../data/FeatureStore.js\";import{project as l,checkProjectionSupport as m}from\"../data/projectionSupport.js\";import c from\"../data/QueryEngine.js\";import{validateGeoJSON as g,createOptimizedFeatures as _}from\"./geojson/geojson.js\";import{mixAttributes as f}from\"./support/sourceUtils.js\";import{getFeature as d}from\"../../ogc/wfsUtils.js\";import w from\"../../support/FieldsIndex.js\";class E{constructor(){this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=async e=>{const{objectIdField:t}=this._queryEngine,s=await d(this._getFeatureUrl,this._featureType.typeName,this._getFeatureOutputFormat,{customParameters:this._customParameters,dateFields:this._queryEngine.fieldsIndex.dateFields.map((e=>e.name)),signal:e});await g(s),a(e);const i=_(s,{geometryType:this._queryEngine.geometryType,hasZ:!1,objectIdField:t});if(!o(this._queryEngine.spatialReference,u))for(const a of i)r(a.geometry)&&(a.geometry=p(l(h(a.geometry,this._queryEngine.geometryType,!1,!1),u,this._queryEngine.spatialReference)));let n=1;for(const r of i){const e={};f(this._fieldsIndex,e,r.attributes,null,!0),r.attributes=e,null==r.attributes[t]&&(r.objectId=r.attributes[t]=n++)}return i}}destroy(){var e;null==(e=this._queryEngine)||e.destroy(),this._queryEngine=null}async load(e,t){const{getFeatureUrl:r,getFeatureOutputFormat:i,spatialReference:n,fields:o,geometryType:u,featureType:p,objectIdField:h,customParameters:l}=e;this._featureType=p,this._customParameters=l,this._getFeatureUrl=r,this._getFeatureOutputFormat=i,this._fieldsIndex=new w(o),await this._checkProjection(n),a(t),this._queryEngine=new c({fields:o,geometryType:u,hasM:!1,hasZ:!1,objectIdField:h,spatialReference:n,timeInfo:null,featureStore:new y({geometryType:u,hasM:!1,hasZ:!1})});const m=await this._snapshotFeatures(s(t.signal));return this._queryEngine.featureStore.addMany(m),{extent:this._queryEngine.fullExtent}}async applyEdits(){throw new e(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}setCustomParameters(e){this._customParameters=e}async refresh(){var r;return null==(r=this._snapshotTask)||r.abort(),this._snapshotTask=i(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(r=>{this._queryEngine.featureStore.clear(),n(r)||t.getLogger(\"esri.layers.WFSLayer\").error(new e(\"wfs-layer:getfeature-error\",\"An error occurred during the GetFeature request\",{error:r}))})),await this._waitSnapshotComplete(),{extent:this._queryEngine.fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _checkProjection(t){try{await m(u,t)}catch{throw new e(\"unsupported-projection\",\"Projection not supported\",{spatialReference:t})}}}export{E as default};\n"],"names":["constructor","_queryEngine","this","_customParameters","_snapshotFeatures","async","e2","objectIdField","t","s2","d","_getFeatureUrl","_featureType","typeName","_getFeatureOutputFormat","customParameters","dateFields","fieldsIndex","map","e3","name","signal","g","a","i","_","geometryType","hasZ","o","spatialReference","u","a2","geometry","p","l","h","n","r2","_fieldsIndex","attributes","objectId","destroy","e","getFeatureUrl","getFeatureOutputFormat","fields","featureType","w","_checkProjection","c","hasM","timeInfo","featureStore","y","m","s","addMany","extent","fullExtent","_waitSnapshotComplete","executeQuery","executeQueryForCount","executeQueryForIds","executeQueryForExtent","executeQueryForSnapping","setCustomParameters","_snapshotTask","abort","promise","then","clear","r3","getLogger","error","finished"],"mappings":"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"}