import{na as e,nb as t,dB as s,B as i,bj as r,cI as a,nc as l,nd as n,ne as o,cF as h,ie as c,ig as d,ih as p,kY as u,ag as g,aj as y,eO as m,F as _,G as f,H as b}from"./vendor.7103ff48.js";import{s as C}from"./SchemaHelper.efcb70dd.js";import{r as T,i as v,a as w,f as R}from"./SymbolRepository.47a0aef4.js";import{j as H}from"./brushes.b64b90a9.js";import{c as M}from"./VTLMaterialManager.09713720.js";import{g as S}from"./StyleRepository.d0853bab.js";import"./Rect.db562a93.js";import"./CIMSymbolHelper.da5834c9.js";import"./TileIndex.3ffc9499.js";import"./TilemapCache.59c5ee62.js";import"./definitions.e5e12ce7.js";import"./Utils.8f00ae04.js";import"./ShaderCompiler.6905b522.js";import"./GeometryUtils.1bcb906c.js";import"./MaterialKey.8df623c8.js";import"./pixelUtils.5eddfa69.js";class I extends R{constructor(e,t,s,i,r){super(e,t,s),this._memCache=i,this._loader=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}destroy(){this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(h,c,d,p){const u=new s(h,c,d,0);let g=this._memCache.get(u.id);if(i(g))return g.retain(),g;const y=await this._getVectorTileData(u);if(r(p),!this._vectorTileLayer)return null;if(g=this._memCache.get(u.id),i(g))return g.retain(),g;const m=this._vectorTileLayer.tileInfo.getTileBounds(a(),u);return g=new l(u,m[0],m[3],512,512,this._styleRepository,this._memCache),i(y)&&y.tileData?(g.setData(y.tileData),g.retain(),this._memCache.put(u.id,g,g.memoryUsage*g.referenced,n)):g.setData(null),g.neededForCoverage=!0,g.transforms.tileUnitsToPixels=o(1/8,0,0,0,1/8,0,0,0,1),function(s,i){const r=[],a=new T(4096,r,(()=>{const t=new e;return t.show=!1,t.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),t.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),t})),l=new v(r,a,((e,t,i)=>new w(e,t,i,s.styleRepository,s.key.level,0)),((e,s)=>{t(e,s,!1)}),(()=>0),(e=>{const t=i.getStyleLayerByUID(e).getLayoutProperty("visibility");return!t||1!==t.getValue()}));r.push(s),a.add(s),l.setScreenSize(512,512),l.continue(1/0)}(g,this._styleRepository),g}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,i={signal:s.signal},r=this._getParsedVectorTileData(e,i).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,r),this._ongoingRequestToController.set(t,s),r}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((s=>this.parseTileData({key:e,data:s},t)))}request(e,t){return this._loader.request(e,"binary",t)}}const L=1e-6;class j{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new M}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=h(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,s){const{context:i}=e,r=s.layers;s.backgroundBucketIds.length>0&&(e.renderPass="background",s.backgroundBucketIds.forEach((i=>this._renderStyleLayer(s.getLayerById(i),e,t,!0)))),i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(515),e.renderPass="opaque";for(let a=r.length-1;a>=0;a--)this._renderStyleLayer(r[a],e,t,!1);i.setDepthWriteEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let a=0;a<r.length;a++)this._renderStyleLayer(r[a],e,t,!1);i.setDepthTestEnabled(!1),e.renderPass="symbol";for(let a=0;a<r.length;a++)this._renderStyleLayer(r[a],e,t,!1);i.bindVAO()}_renderStyleLayer(e,t,s,i=!1){if(!(i||e&&s.layerData.has(e.uid)))return;const r=e.getLayoutProperty("visibility");if(r&&1===r.getValue())return;const{renderPass:a}=t;let l;switch(e.type){case 0:if("background"!==a)return;l="vtlBackground";break;case 1:if("opaque"!==a&&"translucent"!==t.renderPass)return;l="vtlFill";break;case 2:if("translucent"!==a)return;l="vtlLine";break;case 4:if("symbol"!==a)return;l="vtlCircle";break;case 3:if("symbol"!==a)return;l="vtlSymbol"}const n=t.displayLevel;void 0!==e.minzoom&&e.minzoom>n+L||void 0!==e.maxzoom&&e.maxzoom<=n-L||(t.styleLayerUID=e.uid,t.styleLayer=e,this.drawWithBrush(t,s,l))}drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const e=H[s];this._brushCache.set(s,new e)}this._brushCache.get(s).drawMany(e,[t])}}let D=class extends(c(d(p))){constructor(e){super(e),this.type="vector-tile-3d"}initialize(){const e=this.layer.compatibleTileInfo256,t=this._getTileInfoSupportError(e,this.layer.fullExtent);if(t)return void this.addResolvingPromise(Promise.reject(t));const{basemapTerrain:s,spatialReference:i,pixelRatio:r}=this.view,a=u(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=s.tilingScheme,t=e.pixelSize;let r;this.schemaHelper=new C(t,i.isGeographic),r=256===t?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;const a=this._getTileInfoCompatibilityError(r,e);if(a)throw a;this._set("tileInfo",r)}));this._tileHandlerController=g();const l=this.view.resourceController;this._memCache=l.memoryController.getMemCache(this.layer.uid,(e=>e.release()));const{style:n,spriteUrl:o,glyphsUrl:h}=this.layer.currentStyleInfo,c=new S(n,{spriteUrl:o,glyphsUrl:h}),d=s.mapTileRequester;this._tileHandler=new I(this.layer,c,r,this._memCache,d);const p=this._tileHandlerController.signal,m=e=>l.schedule(e),_=this._tileHandler.start({signal:p,schedule:m}),f=this._tileHandler.spriteMosaic;f.then((e=>{!y(p)&&this._tileHandler&&(this.painter=new j(e,this._tileHandler.glyphMosaic))})),_.then((()=>this._tileHandlerController=null));const b=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=g(),this._memCache.clear();const{style:e,spriteUrl:t,glyphsUrl:s}=this.layer.currentStyleInfo,i=new S(e,{spriteUrl:t,glyphsUrl:s}),a=new I(this.layer,i,r,this._memCache,d),l=a.start({signal:this._tileHandlerController.signal,schedule:m}),n=a.spriteMosaic;l.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([l,n]).then((([,e])=>{const t=this._tileHandler,s=this.painter;this.painter=new j(e,a.glyphMosaic),this._tileHandler=a,this.emit("data-changed"),t.destroy(),s&&s.dispose()})))};this.updatingHandles.add(this,"layer.currentStyleInfo",b),this.updatingHandles.add(this,"view.pixelRatio",b);const T=Promise.all([a,_,f]);this.addResolvingPromise(T)}destroy(){this.painter=h(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),m(this._tileHandler),this._memCache=m(this._memCache),this._tileHandler=null}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,s=e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,s);return 1===i.minLevel&&256===this.tileInfo.size[0]&&(i.minLevel=0),i}async fetchTile(e,t,s,i){return this._tileHandler.getVectorTile(e,t,s,i)}};_([f({aliasOf:"layer.fullExtent"})],D.prototype,"fullExtent",void 0),_([f()],D.prototype,"layer",void 0),_([f()],D.prototype,"tileInfo",void 0),_([f()],D.prototype,"dataLevelRange",null),_([f()],D.prototype,"updatingProgressValue",void 0),D=_([b("esri.views.3d.layers.VectorTileLayerView3D")],D);var q=D;export{q as default};
//# sourceMappingURL=VectorTileLayerView3D.0924c67d.js.map
