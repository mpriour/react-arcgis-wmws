{"version":3,"file":"ExportStrategy.b9685efa.js","sources":["../../node_modules/@arcgis/core/views/2d/viewStateUtils.js","../../node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,n,o){const{resolution:r,size:u}=o;return t[0]=r*(Math.round(n[0]/r)+u[0]%2*.5),t[1]=r*(Math.round(n[1]/r)+u[1]%2*.5),t}function r(t,o){const r=n(o.rotation),u=Math.abs(Math.cos(r)),a=Math.abs(Math.sin(r)),[s,c]=o.size;return t[0]=Math.round(c*a+s*u),t[1]=Math.round(c*u+s*a),t}function u(t,n,o,r){const[u,a]=n,[s,c]=r,i=.5*o;return t[0]=u-i*s,t[1]=a-i*c,t[2]=u+i*s,t[3]=a+i*c,t}function a(t,n){const[o,r,u,a]=t,[s,c,i,e]=n;return!(o>i||u<s||r>e||a<c)}export{a as bboxIntersects,u as getBBox,r as getOuterSize,o as snapToPixel};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import{debounce as i}from\"../../../../core/promiseUtils.js\";import{property as o}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/has.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/Logger.js\";import{subclass as r}from\"../../../../core/accessorSupport/decorators/subclass.js\";import s from\"../../../../geometry/Extent.js\";import{create as a}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as p}from\"../../../../geometry/support/spatialReferenceUtils.js\";import n from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as m,getBBox as l}from\"../../viewStateUtils.js\";import{Bitmap as d}from\"../../engine/Bitmap.js\";import h from\"../../tiling/TileInfoView.js\";import c from\"../../tiling/TileKey.js\";const u=a(),g=[0,0],f=new c(0,0,0,0),x={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let y=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=x.hidpi,this.imageMaxWidth=x.imageMaxWidth,this.imageMaxHeight=x.imageMaxHeight,this.imageRotationSupported=x.imageRotationSupported,this.imageNormalizationSupported=x.imageNormalizationSupported,this.update=i((async(t,e)=>{if(!t.stationary||this.destroyed)return null;const i=t.state,o=p(i.spatialReference),r=this.hidpi?t.pixelRatio:1,s=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0];s?(g[0]=i.worldScreenWidth,g[1]=i.size[1]):this.imageRotationSupported?(g[0]=i.size[0],g[1]=i.size[1]):m(g,i);const a=Math.floor(g[0]*r)>this.imageMaxWidth||Math.floor(g[1]*r)>this.imageMaxHeight,n=o&&(i.extent.xmin<o.valid[0]||i.extent.xmax>o.valid[1]),l=!this.imageNormalizationSupported&&n,d=!a&&!l,h=this.imageRotationSupported?i.rotation:0;if(d){const t=s?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,g,t,i.resolution,h,r,e)}else{let t=Math.min(this.imageMaxWidth,this.imageMaxHeight);l&&(t=Math.min(i.worldScreenWidth,t)),this._imagePromise=this._tiledExport(i,t,h,r,e)}return this._imagePromise.then((async t=>{if(this._imagePromise=null,!this.destroyed){this.bitmaps=null!=t?t:[];for(const e of this.container.children)t.includes(e)||e.fadeOut().then((()=>{e.remove()}));for(const e of t)this.container.addChild(e),e.fadeIn()}})).catch((t=>{throw this._imagePromise=null,t}))}),5e3)}destroy(){this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}updateExports(t){for(const e of this.container.children){if(!e.visible||!e.stage)return;t(e),e.invalidateTexture(),e.requestRender()}}async _export(t,e,i,o,r,s){const a=await this.fetchSource(t,Math.floor(e*r),Math.floor(i*r),{rotation:o,pixelRatio:r,signal:s}),p=new d(a,\"additive\");return p.x=t.xmin,p.y=t.ymax,p.resolution=t.width/e,p.rotation=o,p.pixelRatio=r,p}async _singleExport(t,e,i,o,r,a,p){l(u,i,o,e);const n=new s(u[0],u[1],u[2],u[3],t.spatialReference);return[await this._export(n,e[0],e[1],r,a,p)]}_tiledExport(t,e,i,o,r){const a=n.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),p=new h(a),m=p.getTileCoverage(t);if(!m)return null;const l=[];return m.forEach(((a,n,m,d)=>{f.set(a,n,m,d),p.getTileBounds(u,f);const h=new s(u[0],u[1],u[2],u[3],t.spatialReference);l.push(this._export(h,e,e,i,o,r))})),Promise.all(l)}};t([o()],y.prototype,\"_imagePromise\",void 0),t([o()],y.prototype,\"bitmaps\",void 0),t([o()],y.prototype,\"container\",void 0),t([o()],y.prototype,\"fetchSource\",void 0),t([o()],y.prototype,\"hidpi\",void 0),t([o()],y.prototype,\"imageMaxWidth\",void 0),t([o()],y.prototype,\"imageMaxHeight\",void 0),t([o()],y.prototype,\"imageRotationSupported\",void 0),t([o()],y.prototype,\"imageNormalizationSupported\",void 0),t([o()],y.prototype,\"requestUpdate\",void 0),t([o()],y.prototype,\"updating\",null),y=t([r(\"esri.views.2d.layers.support.ExportStrategy\")],y);var S=y;export{S as default};\n"],"names":["t","Math","PI","t2","o","r2","rotation","u2","abs","cos","a","sin","s","c","size","round","u","g","f","x","y","e","constructor","this","_imagePromise","bitmaps","hidpi","imageMaxWidth","imageMaxHeight","imageRotationSupported","imageNormalizationSupported","update","i","async","t3","e2","stationary","destroyed","state","p","spatialReference","r","pixelRatio","worldScreenWidth","m","floor","n2","extent","xmin","valid","xmax","l","d","h2","t4","paddedViewState","center","_singleExport","resolution","min","_tiledExport","then","e3","container","children","includes","fadeOut","remove","addChild","fadeIn","catch","destroy","updateExports","visible","stage","invalidateTexture","requestRender","fetchSource","signal","p2","ymax","width","_export","n","create","scales","scale","h","getTileCoverage","forEach","a2","m2","set","getTileBounds","push","Promise","all","prototype","S"],"mappings":"8JAIA,MAAMA,EAAEC,KAAKC,GAAG,IAAiK,WAAWC,EAAEC,SAASC,EAAID,EAAEE,SAAlKN,EAA4KO,EAAEN,KAAKO,IAAIP,KAAKQ,IAAIJ,IAAIK,EAAET,KAAKO,IAAIP,KAAKU,IAAIN,KAAKO,EAAEC,GAAGT,EAAEU,YAAYX,EAAE,GAAGF,KAAKc,MAAMF,EAAEH,EAAEE,EAAEL,GAAGJ,EAAE,GAAGF,KAAKc,MAAMF,EAAEN,EAAEK,EAAEF,GAAGP,ECAkjB,MAAMa,EAAEN,IAAIO,EAAE,CAAC,EAAE,GAAGC,EAAE,IAAIL,EAAE,EAAE,EAAE,EAAE,GAAGM,EAAoE,KAApEA,EAAwF,KAAxFA,GAAoH,EAApHA,GAAmJ,EAAnJA,GAA4J,EAAI,IAAIC,EAAE,cAAcC,EAAEC,YAAYnB,SAASA,GAAGoB,KAAKC,cAAc,KAAKD,KAAKE,QAAQ,GAAGF,KAAKG,MAAMP,EAAQI,KAAKI,cAAcR,EAAgBI,KAAKK,eAAeT,EAAiBI,KAAKM,uBAAuBV,EAAyBI,KAAKO,4BAA4BX,EAA8BI,KAAKQ,OAAOC,GAAGC,MAAMC,EAAEC,SAASD,EAAEE,YAAYb,KAAKc,iBAAiB,WAAWL,EAAEE,EAAEI,MAAMlC,EAAEmC,EAAEP,EAAEQ,kBAAkBC,EAAElB,KAAKG,MAAMQ,EAAEQ,WAAW,EAAE9B,EAAEW,KAAKO,6BAA6BE,EAAEW,kBAAkBX,EAAEW,iBAAiBX,EAAElB,KAAK,QAAQ,GAAGkB,EAAEW,iBAAiB1B,EAAE,GAAGe,EAAElB,KAAK,IAAIS,KAAKM,0BAA0B,GAAGG,EAAElB,KAAK,GAAGG,EAAE,GAAGe,EAAElB,KAAK,IAAI8B,EAAE3B,EAAEe,SAAStB,EAAET,KAAK4C,MAAM5B,EAAE,GAAGwB,GAAGlB,KAAKI,eAAe1B,KAAK4C,MAAM5B,EAAE,GAAGwB,GAAGlB,KAAKK,eAAekB,EAAE1C,MAAM2C,OAAOC,KAAK5C,EAAE6C,MAAM,IAAIjB,EAAEe,OAAOG,KAAK9C,EAAE6C,MAAM,IAAIE,GAAG5B,KAAKO,6BAA6BgB,EAAEM,GAAG1C,IAAIyC,EAAEE,EAAE9B,KAAKM,uBAAuBG,EAAE1B,SAAS,KAAK8C,EAAE,OAAOE,EAAE1C,EAAEoB,EAAEuB,gBAAgBC,OAAOxB,EAAEwB,YAAYhC,cAAcD,KAAKkC,cAAczB,EAAEf,EAAEqC,EAAEtB,EAAE0B,WAAWL,EAAEZ,EAAEN,OAAO,KAAKmB,EAAErD,KAAK0D,IAAIpC,KAAKI,cAAcJ,KAAKK,sBAAsB3B,KAAK0D,IAAI3B,EAAEW,iBAAiBW,IAAI/B,KAAKC,cAAcD,KAAKqC,aAAa5B,EAAEsB,EAAED,EAAEZ,EAAEN,UAAUZ,KAAKC,cAAcqC,MAAM5B,MAAMqB,OAAO/B,KAAKC,cAAc,MAAMD,KAAKc,UAAU,MAAMZ,QAAQ,MAAM6B,EAAEA,EAAE,aAAaQ,KAAKvC,KAAKwC,UAAUC,WAAWC,SAASH,IAAIA,EAAEI,UAAUL,MAAM,OAAOM,sBAAsBL,KAAKR,OAAOS,UAAUK,SAASN,GAAGA,EAAEO,aAAaC,iBAAiB/C,KAAKC,cAAc,KAAK8B,OAAO,KAAKiB,eAAe9C,QAAQ,yBAAyBF,KAAKc,WAAW,OAAOd,KAAKC,cAAcgD,cAAcrE,aAAagC,KAAKZ,KAAKwC,UAAUC,SAAS,KAAK7B,EAAEsC,UAAUtC,EAAEuC,eAAevC,GAAGA,EAAEwC,oBAAoBxC,EAAEyC,+BAA+BzE,EAAEgC,EAAEH,EAAE5B,EAAEC,EAAEO,SAASF,QAAQa,KAAKsD,YAAY1E,EAAEF,KAAK4C,MAAMV,EAAE9B,GAAGJ,KAAK4C,MAAMb,EAAE3B,GAAG,CAACC,SAASF,EAAEsC,WAAWrC,EAAEyE,OAAOlE,IAAImE,EAAE,IAAI3B,EAAE1C,EAAE,mBAAmBqE,EAAE5D,EAAEhB,EAAE6C,KAAK+B,EAAE3D,EAAEjB,EAAE6E,KAAKD,EAAErB,WAAWvD,EAAE8E,MAAM9C,EAAE4C,EAAEzE,SAASF,EAAE2E,EAAErC,WAAWrC,EAAE0E,sBAAsB5E,EAAEgC,EAAEH,EAAE5B,EAAEC,EAAEK,EAAEqE,IDA5nF,SAAW5E,EAAE2C,EAAE1C,EAAEC,SAASE,EAAEG,GAAGoC,GAAGlC,EAAEC,GAAGR,EAAE2B,EAAE,GAAG5B,EAASD,EAAE,GAAGI,EAAEyB,EAAEpB,EAAET,EAAE,GAAGO,EAAEsB,EAAEnB,EAAEV,EAAE,GAAGI,EAAEyB,EAAEpB,EAAET,EAAE,GAAGO,EAAEsB,EAAEnB,GCAgiFG,EAAEgB,EAAE5B,EAAE+B,SAASW,EAAE,IAAIlC,EAAEI,EAAE,GAAGA,EAAE,GAAGA,EAAE,GAAGA,EAAE,GAAGb,EAAEqC,wBAAwB,OAAOjB,KAAK2D,QAAQpC,EAAEX,EAAE,GAAGA,EAAE,GAAG9B,EAAEK,EAAEqE,IAAInB,aAAazD,EAAEgC,EAAEH,EAAE5B,EAAEC,SAASK,EAAEyE,EAAEC,OAAO,CAACtE,KAAKqB,EAAEK,iBAAiBrC,EAAEqC,iBAAiB6C,OAAO,CAAClF,EAAEmF,SAASP,EAAE,IAAIQ,EAAE7E,GAAGkC,EAAEmC,EAAES,gBAAgBrF,OAAOyC,SAAS,WAAWO,EAAE,UAAUP,EAAE6C,SAAS,CAACC,EAAE5C,EAAE6C,EAAEvC,OAAOwC,IAAIF,EAAE5C,EAAE6C,EAAEvC,GAAG2B,EAAEc,cAAc7E,EAAEE,SAASmC,EAAE,IAAIzC,EAAEI,EAAE,GAAGA,EAAE,GAAGA,EAAE,GAAGA,EAAE,GAAGb,EAAEqC,oBAAoBsD,KAAKvE,KAAK2D,QAAQ7B,EAAElB,EAAEA,EAAEH,EAAE5B,EAAEC,OAAO0F,QAAQC,IAAI7C,KAAKnD,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,qBAAgB,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,eAAU,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,iBAAY,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,mBAAc,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,aAAQ,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,qBAAgB,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,sBAAiB,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,8BAAyB,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,mCAA8B,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,qBAAgB,GAAQjG,EAAE,CAACI,KAAKgB,EAAE6E,UAAU,WAAW,MAAM7E,EAAEpB,EAAE,CAACyC,EAAE,gDAAgDrB,GAAM,IAAC8E,EAAE9E"}