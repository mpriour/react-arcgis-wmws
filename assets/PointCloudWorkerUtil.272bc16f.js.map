{"version":3,"file":"PointCloudWorkerUtil.272bc16f.js","sources":["../../node_modules/@arcgis/core/views/3d/layers/i3s/PointCloudWorkerUtil.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{isNone as e,isSome as o}from\"../../../../core/maybe.js\";import r from\"../../../../renderers/PointCloudClassBreaksRenderer.js\";import t from\"../../../../renderers/PointCloudStretchRenderer.js\";import n from\"../../../../renderers/PointCloudUniqueValueRenderer.js\";import{createGeometryIndexFromSchema as l,createTypedView as i,readBinaryAttribute as s}from\"./I3SBinaryReader.js\";import{decodeXYZ as f}from\"./LEPCC.js\";function u(e,o,l,i){const{rendererJSON:s,isRGBRenderer:f}=e;let u=null,c=null;if(o&&f)u=o;else if(o&&\"pointCloudUniqueValueRenderer\"===s.type){c=n.fromJSON(s);const e=c.colorUniqueValueInfos;u=new Uint8Array(3*i);const r=p(c.fieldTransformType);for(let t=0;t<i;t++){const n=(r?r(o[t]):o[t])+\"\";for(let o=0;o<e.length;o++)if(e[o].values.indexOf(n)>=0){u[3*t]=e[o].color.r,u[3*t+1]=e[o].color.g,u[3*t+2]=e[o].color.b;break}}}else if(o&&\"pointCloudStretchRenderer\"===s.type){c=t.fromJSON(s);const e=c.stops;u=new Uint8Array(3*i);const r=p(c.fieldTransformType);for(let t=0;t<i;t++){const n=r?r(o[t]):o[t],l=e.length-1;if(n<e[0].value)u[3*t]=e[0].color.r,u[3*t+1]=e[0].color.g,u[3*t+2]=e[0].color.b;else if(n>=e[l].value)u[3*t]=e[l].color.r,u[3*t+1]=e[l].color.g,u[3*t+2]=e[l].color.b;else for(let o=1;o<e.length;o++)if(n<e[o].value){const r=(n-e[o-1].value)/(e[o].value-e[o-1].value);u[3*t]=e[o].color.r*r+e[o-1].color.r*(1-r),u[3*t+1]=e[o].color.g*r+e[o-1].color.g*(1-r),u[3*t+2]=e[o].color.b*r+e[o-1].color.b*(1-r);break}}}else if(o&&\"pointCloudClassBreaksRenderer\"===s.type){c=r.fromJSON(s);const e=c.colorClassBreakInfos;u=new Uint8Array(3*i);const t=p(c.fieldTransformType);for(let r=0;r<i;r++){const n=t?t(o[r]):o[r];for(let o=0;o<e.length;o++)if(n>=e[o].minValue&&n<=e[o].maxValue){u[3*r]=e[o].color.r,u[3*r+1]=e[o].color.g,u[3*r+2]=e[o].color.b;break}}}else{u=new Uint8Array(3*i);for(let e=0;e<u.length;e++)u[e]=255}if(l&&c&&c.colorModulation){const e=c.colorModulation.minValue,o=c.colorModulation.maxValue,r=.3;for(let t=0;t<i;t++){const n=l[t],i=n>=o?1:n<=e?r:r+(1-r)*(n-e)/(o-e);u[3*t]=i*u[3*t],u[3*t+1]=i*u[3*t+1],u[3*t+2]=i*u[3*t+2]}}return u}function c(o,r){if(null==o.encoding||\"\"===o.encoding){const t=l(r,o);if(e(t.vertexAttributes.position))return;const n=i(r,t.vertexAttributes.position),s=t.header.fields,f=[s.offsetX,s.offsetY,s.offsetZ],u=[s.scaleX,s.scaleY,s.scaleZ],c=n.length/3,a=new Float64Array(3*c);for(let e=0;e<c;e++)a[3*e]=n[3*e]*u[0]+f[0],a[3*e+1]=n[3*e+1]*u[1]+f[1],a[3*e+2]=n[3*e+2]*u[2]+f[2];return a}if(\"lepcc-xyz\"===o.encoding)return f(r).result}function a(e,r,t){return o(e)&&e.attributeInfo.useElevation?d(r,t):o(e)?s(e.attributeInfo.storageInfo,e.buffer,t):null}function d(e,o){const r=new Float64Array(o);for(let t=0;t<o;t++)r[t]=e[3*t+2];return r}function m(e,o,r,t,n){const l=e.length/3;let i=0;for(let s=0;s<l;s++){let l=!0;for(let e=0;e<t.length&&l;e++){const{filterJSON:o}=t[e],r=n[e].values[s];switch(o.type){case\"pointCloudValueFilter\":{const e=\"exclude\"===o.mode;-1!==o.values.indexOf(r)===e&&(l=!1);break}case\"pointCloudBitfieldFilter\":{const e=b(o.requiredSetBits),t=b(o.requiredClearBits);(r&e)===e&&0==(r&t)||(l=!1);break}case\"pointCloudReturnFilter\":{const e=15&r,t=r>>>4&15,n=t>1,i=1===e,s=e===t;let f=!1;for(const r of o.includedReturns)if(\"last\"===r&&s||\"firstOfMany\"===r&&i&&n||\"lastOfMany\"===r&&s&&n||\"single\"===r&&!n){f=!0;break}f||(l=!1);break}}}l&&(r[i]=s,e[3*i]=e[3*s],e[3*i+1]=e[3*s+1],e[3*i+2]=e[3*s+2],o[3*i]=o[3*s],o[3*i+1]=o[3*s+1],o[3*i+2]=o[3*s+2],i++)}return i}function p(e){return null==e||\"none\"===e?null:\"low-four-bit\"===e?e=>15&e:\"high-four-bit\"===e?e=>(240&e)>>4:\"absolute-value\"===e?e=>Math.abs(e):\"modulo-ten\"===e?e=>e%10:null}function b(e){let o=0;for(const r of e||[])o|=1<<r;return o}export{d as elevationFromPositions,u as evaluateRenderer,m as filterInPlace,a as getAttributeValues,c as readGeometry};\n"],"names":["e","o","l","i","rendererJSON","s","isRGBRenderer","f","u2","c2","type","n","fromJSON","e2","colorUniqueValueInfos","Uint8Array","r2","p","fieldTransformType","t2","o2","length","values","indexOf","color","r","g","b","t","stops","l2","value","r3","colorClassBreakInfos","minValue","maxValue","colorModulation","i2","encoding","vertexAttributes","position","header","fields","offsetX","offsetY","offsetZ","scaleX","scaleY","scaleZ","a2","Float64Array","result","attributeInfo","useElevation","d","storageInfo","buffer","filterJSON","e3","mode","requiredSetBits","t3","requiredClearBits","n2","s2","r4","includedReturns","Math","abs"],"mappings":"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"}