{"version":3,"file":"RawBlockCache.4c21cd41.js","sources":["../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js","../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import{isSome as e}from\"../../../core/maybe.js\";import t from\"./EphemeralBlockCache.js\";import{projectExtent as n,projectResolution as o,snapPyramid as r}from\"../rasterFunctions/rasterProjectionHelper.js\";import l from\"../../../geometry/Point.js\";const c=new Map,a=new t;function i(e,t){return null==t?e:`${e}?sliceId=${t}`}function s(e,t){const n={extent:null,rasterInfo:t,cache:new Map};if(c.has(e)){const t=c.get(e);return t.push(n),t.length-1}return c.set(e,[n]),0}function u(e,t){if(c.has(e)){const n=c.get(e);n[t]=null,n.some((e=>null!=e))||c.delete(e)}}function f(e){c.delete(e)}function h(e,t,n){if(!c.has(e))return null==t?a.decreaseRefCount(e,n):0;const o=c.get(e);if(null==o[t])return a.decreaseRefCount(e,n);const r=o[t].cache;if(r.has(n)){const e=r.get(n);if(e.refCount--,0===e.refCount){r.delete(n);for(let e=0;e<o.length;e++)o[e]&&o[e].cache.has(n)&&o[e].cache.delete(n);e.controller&&e.controller.abort()}return e.refCount}return 0}function m(e,t,n){if(!c.has(e))return null==t?a.getBlock(e,n):null;const o=c.get(e);if(null==o[t]){for(let e=0;e<o.length;e++)if(o[e]&&o[e].cache.has(n)){const t=o[e].cache.get(n);return t.refCount++,t.block}return a.getBlock(e,n)}const r=o[t].cache;if(r.has(n)){const e=r.get(n);return e.refCount++,e.block}for(let l=0;l<o.length;l++)if(l!==t&&o[l]&&o[l]&&o[l].cache.has(n)){const e=o[l].cache.get(n);return e.refCount++,r.set(n,e),e.block}return null}function x(e,t,n,o,r=null){if(!c.has(e))return void(null==t&&a.putBlock(e,n,o,r));const l=c.get(e);if(null==l[t])return void a.putBlock(e,n,o,r);const i={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:r};o.then((()=>i.isResolved=!0)).catch((()=>i.isRejected=!0)),l[t].cache.set(n,i)}function d(e,t,n){if(!c.has(e))return void(null==t&&a.deleteBlock(e,n));const o=c.get(e);null!=o[t]?o[t].cache.delete(n):a.deleteBlock(e,n)}function y(e,t){if(!c.has(e))return null;const n=c.get(e);return null==n[t]?null:n[t]}function g(t,c,a,i,s,u,f=null){const h=y(t,c),m=h.extent,{cache:x,rasterInfo:d}=h;if(m&&m.xmin===a.xmin&&m.xmax===a.xmax&&m.ymin===a.ymin&&m.ymax===a.ymax)return;const g=a.clone().normalize(),{spatialReference:p,transform:k}=d,M=new Set;for(let y=0;y<g.length;y++){const t=g[y];if(t.xmax-t.xmin<=i||t.ymax-t.ymin<=i)continue;let c=n(t,p,f);e(k)&&(c=k.inverseTransform(c));const a=new l({x:i,y:i,spatialReference:t.spatialReference});if(null==s&&!(s=o(a,p,t,f)))return;const{pyramidLevel:h,pyramidResolution:m,excessiveReading:x}=r(s,d,u||\"closest\");if(x)return;const{storageInfo:R}=d,{origin:C}=R,j={x:Math.max(0,Math.floor((c.xmin-C.x)/m.x)),y:Math.max(0,Math.floor((C.y-c.ymax)/m.y))},v=Math.ceil((c.xmax-c.xmin)/m.x-.1),B=Math.ceil((c.ymax-c.ymin)/m.y-.1),b=h>0?R.pyramidBlockWidth:R.blockWidth,w=h>0?R.pyramidBlockHeight:R.blockHeight,$=1,I=Math.max(0,Math.floor(j.x/b)-$),H=Math.max(0,Math.floor(j.y/w)-$),E=Math.floor((j.x+v-1)/b)+$,P=Math.floor((j.y+B-1)/w)+$;for(let e=H;e<=P;e++)for(let t=I;t<=E;t++)M.add(`${h}/${e}/${t}`)}x.forEach(((e,t)=>{if(!M.has(t)){const e=x.get(t);(null==e||e.isResolved||e.isRejected)&&x.delete(t)}})),h.extent={xmin:a.xmin,ymin:a.ymin,xmax:a.xmax,ymax:a.ymax}}export{h as decreaseRefCount,d as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,x as putBlock,s as register,u as unregister,g as update};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r=null){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this.trim(),this.updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this.trim()}empty(){this._cachedBlocks.clear(),this.clearTimer()}getCurrentSize(){return this._cachedBlocks.size}updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this.clearTimer()}),this._interval)}trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n"],"names":["c","Map","a","constructor","t2","e","_timer","this","_cachedBlocks","_size","_duration","_interval","Math","min","decreaseRefCount","s2","r2","has","t3","get","refCount","delete","controller","abort","getBlock","ts","Date","now","set","block","putBlock","i2","c2","trim","updateTimer","deleteBlock","updateMaxSize","empty","clear","clearTimer","getCurrentSize","size","setInterval","Array","from","length","n","extent","rasterInfo","cache","push","some","e2","o","e3","l","isResolved","isRejected","then","catch","a2","u2","f","h2","y","m2","x2","d2","xmin","xmax","ymin","ymax","g2","clone","normalize","spatialReference","p","transform","k","M","Set","y2","c3","inverseTransform","a3","x","pyramidLevel","h3","pyramidResolution","m3","excessiveReading","x3","r","storageInfo","R","origin","C","j","max","floor","v","ceil","B","b","pyramidBlockWidth","blockWidth","w","pyramidBlockHeight","blockHeight","$","I","H","E","P","t4","add","forEach"],"mappings":"wHAIoR,MAAMA,EAAE,IAAIC,IAAIC,EAAE,ICAtS,MAAQC,YAAYC,EAAE,KAAKC,EAAE,UAAUC,OAAO,KAAKC,KAAKC,cAAc,IAAIP,IAAIM,KAAKE,SAASF,KAAKG,UAAUN,EAAEG,KAAKI,UAAUC,KAAKC,IAAIT,EAAEC,GAAGS,iBAAiBV,EAAEC,SAASU,EAAEX,EAAE,IAAIC,EAAEW,EAAET,KAAKC,iBAAiBQ,EAAEC,IAAIF,GAAG,OAAOG,EAAEF,EAAEG,IAAIJ,UAAUG,EAAEE,WAAWF,EAAEE,UAAU,MAAMC,OAAON,GAAGG,EAAEI,YAAYJ,EAAEI,WAAWC,SAASL,EAAEE,gBAAgB,EAAEI,SAASpB,EAAEC,SAASU,EAAEX,EAAE,IAAIC,EAAEW,EAAET,KAAKC,iBAAiBQ,EAAEC,IAAIF,GAAG,OAAOG,EAAEF,EAAEG,IAAIJ,UAAUG,EAAEO,GAAGC,KAAKC,MAAMT,EAAEE,WAAWJ,EAAEK,OAAON,GAAGC,EAAEY,IAAIb,EAAEG,GAAGA,EAAEW,aAAa,KAAKC,SAAS1B,EAAEC,EAAEU,EAAEC,EAAE,YAAYe,EAAExB,KAAKC,cAAcwB,EAAE5B,EAAE,IAAIC,KAAK0B,EAAEd,IAAIe,GAAG,OAAOd,EAAEa,EAAEZ,IAAIa,KAAKP,GAAGC,KAAKC,MAAMT,EAAEE,kBAAkBQ,IAAII,EAAE,CAACH,MAAMd,EAAEU,GAAGC,KAAKC,MAAMP,SAAS,EAAEE,WAAWN,SAASiB,OAAO1B,KAAK2B,cAAcC,YAAY/B,EAAEC,SAASU,EAAER,KAAKC,cAAcQ,EAAEZ,EAAE,IAAIC,IAAIY,IAAID,IAAID,EAAEM,OAAOL,GAAGoB,cAAchC,QAAQK,MAAML,EAAEG,KAAK0B,OAAOI,aAAa7B,cAAc8B,QAAQ/B,KAAKgC,aAAaC,wBAAwBjC,KAAKC,cAAciC,KAAKP,iBAAiB,MAAM3B,KAAKD,oBAAoBF,EAAEG,KAAKC,mBAAmBF,OAAOoC,aAAa,WAAWrC,EAAEsC,MAAMC,KAAKxC,GAAGW,EAAEW,KAAKC,cAAcX,EAAE,EAAEA,EAAEX,EAAEwC,QAAQxC,EAAEW,GAAG,GAAGS,IAAIV,EAAER,KAAKG,UAAUM,MAAMK,OAAOhB,EAAEW,GAAG,IAAI,IAAIZ,EAAEqC,MAAMlC,KAAKgC,eAAehC,KAAKI,WAAWsB,aAAa7B,EAAEG,KAAKC,sBAAiBD,KAAUE,OAAOF,KAAKE,OAAOL,EAAEqC,kBAAkBpC,EAAEsC,MAAMC,KAAKxC,WAAWW,EAAE,EAAEA,EAAEV,EAAEwC,OAAOtC,KAAKE,MAAMM,MAAMM,OAAOhB,EAAEU,GAAG,IAAIwB,aAAa,MAAMhC,KAAKD,uBAAuBC,KAAKD,QAAQC,KAAKD,OAAO,QDArlC,WAAWD,EAAED,UAAU,MAAAA,EAAQC,EAAE,GAAGA,aAAaD,IAAI,WAAWC,EAAED,SAAS0C,EAAE,CAACC,OAAO,KAAKC,WAAW5C,EAAE6C,MAAM,IAAIhD,QAAQD,EAAEiB,IAAIZ,GAAG,OAAOa,EAAElB,EAAEmB,IAAId,UAAUa,EAAEgC,KAAKJ,GAAG5B,EAAE2B,OAAO,SAAS7C,EAAE4B,IAAIvB,EAAE,CAACyC,IAAI,EAAE,WAAWzC,EAAED,MAAMJ,EAAEiB,IAAIZ,GAAG,OAAOyC,EAAE9C,EAAEmB,IAAId,KAAKD,GAAG,KAAK0C,EAAEK,SAAS,MAAAC,KAAWpD,EAAEqB,OAAOhB,IAA8B,WAAWA,EAAED,EAAE0C,OAAO9C,EAAEiB,IAAIZ,UAAU,MAAAD,EAAQF,EAAEY,iBAAiBT,EAAEyC,GAAG,QAAQO,EAAErD,EAAEmB,IAAId,MAAM,MAAMgD,EAAEjD,UAAUF,EAAEY,iBAAiBT,EAAEyC,SAAS9B,EAAEqC,EAAEjD,GAAG6C,SAASjC,EAAEC,IAAI6B,GAAG,OAAOM,EAAEpC,EAAEG,IAAI2B,MAAMM,EAAEhC,WAAW,IAAAgC,EAAMhC,SAAS,GAAGC,OAAOyB,WAAWQ,EAAE,EAAEA,EAAED,EAAER,OAAOS,MAAMA,IAAID,EAAEC,GAAGL,MAAMhC,IAAI6B,IAAIO,EAAEC,GAAGL,MAAM5B,OAAOyB,KAAKxB,YAAY8B,EAAE9B,WAAWC,eAAe6B,EAAEhC,gBAAgB,EAAE,WAAWf,EAAED,EAAE0C,OAAO9C,EAAEiB,IAAIZ,UAAU,MAAAD,EAAQF,EAAEsB,SAASnB,EAAEyC,GAAG,WAAWO,EAAErD,EAAEmB,IAAId,MAAM,MAAMgD,EAAEjD,GAAG,SAASgD,EAAE,EAAEA,EAAEC,EAAER,OAAOO,OAAOC,EAAED,IAAIC,EAAED,GAAGH,MAAMhC,IAAI6B,GAAG,OAAO5B,EAAEmC,EAAED,GAAGH,MAAM9B,IAAI2B,UAAU5B,EAAEE,WAAWF,EAAEW,aAAa3B,EAAEsB,SAASnB,EAAEyC,SAAS9B,EAAEqC,EAAEjD,GAAG6C,SAASjC,EAAEC,IAAI6B,GAAG,OAAOM,EAAEpC,EAAEG,IAAI2B,UAAUM,EAAEhC,WAAWgC,EAAEvB,cAAc0B,EAAE,EAAEA,EAAEF,EAAER,OAAOU,OAAOA,IAAInD,GAAGiD,EAAEE,IAAIF,EAAEE,IAAIF,EAAEE,GAAGN,MAAMhC,IAAI6B,GAAG,OAAOM,EAAEC,EAAEE,GAAGN,MAAM9B,IAAI2B,UAAUM,EAAEhC,WAAWJ,EAAEY,IAAIkB,EAAEM,GAAGA,EAAEvB,aAAa,KAAK,WAAWxB,EAAED,EAAE0C,EAAEO,EAAErC,EAAE,UAAUhB,EAAEiB,IAAIZ,eAAe,MAAMD,GAAGF,EAAE4B,SAASzB,EAAEyC,EAAEO,EAAErC,UAAUuC,EAAEvD,EAAEmB,IAAId,MAAM,MAAMkD,EAAEnD,eAAeF,EAAE4B,SAASzB,EAAEyC,EAAEO,EAAErC,SAASe,EAAE,CAACX,SAAS,EAAES,MAAMwB,EAAEG,YAAW,EAAGC,YAAW,EAAGnC,WAAWN,KAAK0C,MAAM,IAAI3B,EAAEyB,YAAW,IAAKG,OAAO,IAAI5B,EAAE0B,YAAW,IAAKF,EAAEnD,GAAG6C,MAAMrB,IAAIkB,EAAEf,GAAG,WAAW1B,EAAED,EAAE0C,OAAO9C,EAAEiB,IAAIZ,eAAe,MAAMD,GAAGF,EAAEiC,YAAY9B,EAAEyC,UAAUO,EAAErD,EAAEmB,IAAId,GAAG,MAAMgD,EAAEjD,GAAGiD,EAAEjD,GAAG6C,MAAM5B,OAAOyB,GAAG5C,EAAEiC,YAAY9B,EAAEyC,GAAyF,WAAW1C,EAAE4B,EAAE4B,EAAE7B,EAAEhB,EAAE8C,EAAEC,EAAE,YAAYC,EAA3H,SAAW1D,EAAED,OAAOJ,EAAEiB,IAAIZ,UAAU,WAAWyC,EAAE9C,EAAEmB,IAAId,UAAU,MAAAyC,EAAQ1C,GAAG,KAAK0C,EAAE1C,GAA0C4D,CAAE5D,EAAE4B,GAAGiC,EAAEF,EAAEhB,QAAQE,MAAMiB,EAAElB,WAAWmB,GAAGJ,KAAKE,GAAGA,EAAEG,OAAOR,EAAEQ,MAAMH,EAAEI,OAAOT,EAAES,MAAMJ,EAAEK,OAAOV,EAAEU,MAAML,EAAEM,OAAOX,EAAEW,kBAAkBC,EAAEZ,EAAEa,QAAQC,aAAaC,iBAAiBC,EAAEC,UAAUC,GAAGX,EAAEY,EAAE,IAAIC,YAAYC,EAAE,EAAEA,EAAET,EAAE3B,OAAOoC,IAAI,OAAO/D,EAAEsD,EAAES,MAAM/D,EAAEmD,KAAKnD,EAAEkD,MAAMrC,GAAGb,EAAEqD,KAAKrD,EAAEoD,MAAMvC,eAAemD,EAAEpC,EAAE5B,EAAE0D,EAAEd,KAAKgB,OAAOA,EAAEK,iBAAiBD,UAAUE,EAAE,IAAI7B,EAAE,CAAC8B,EAAEtD,EAAEiC,EAAEjC,EAAE4C,iBAAiBzD,EAAEyD,sBAAsB,MAAM5D,OAAOsC,EAAE+B,EAAER,EAAE1D,EAAE4C,iBAAiBwB,aAAaC,EAAEC,kBAAkBC,EAAEC,iBAAiBC,GAAGC,EAAE7E,EAAEoD,EAAEN,GAAG,cAAc8B,eAAeE,YAAYC,GAAG3B,GAAG4B,OAAOC,GAAGF,EAAEG,EAAE,CAACZ,EAAEzE,KAAKsF,IAAI,EAAEtF,KAAKuF,SAAS/B,KAAK4B,EAAEX,GAAGI,EAAEJ,IAAIrB,EAAEpD,KAAKsF,IAAI,EAAEtF,KAAKuF,SAASnC,EAAEkB,EAAEX,MAAMkB,EAAEzB,KAAKoC,EAAExF,KAAKyF,QAAQhC,KAAKa,EAAEd,MAAMqB,EAAEJ,EAAE,IAAIiB,EAAE1F,KAAKyF,QAAQ9B,KAAKW,EAAEZ,MAAMmB,EAAEzB,EAAE,IAAIuC,EAAEhB,EAAE,EAAEO,EAAEU,kBAAkBV,EAAEW,WAAWC,EAAEnB,EAAE,EAAEO,EAAEa,mBAAmBb,EAAEc,YAAYC,EAAE,EAAEC,EAAElG,KAAKsF,IAAI,EAAEtF,KAAKuF,MAAMF,EAAEZ,EAAEkB,GAAGM,GAAGE,EAAEnG,KAAKsF,IAAI,EAAEtF,KAAKuF,MAAMF,EAAEjC,EAAE0C,GAAGG,GAAGG,EAAEpG,KAAKuF,SAASd,EAAEe,EAAE,GAAGG,GAAGM,EAAEI,EAAErG,KAAKuF,SAASnC,EAAEsC,EAAE,GAAGI,GAAGG,UAAUxG,EAAE0G,EAAE1G,GAAG4G,EAAE5G,YAAY6G,EAAEJ,EAAEI,GAAGF,EAAEE,MAAMC,IAAI,GAAG5B,KAAKlF,KAAK6G,OAAOE,SAAS,CAAC/G,EAAEa,SAAS6D,EAAE9D,IAAIC,GAAG,OAAOkC,EAAEc,EAAE/C,IAAID,IAAI,MAAMkC,GAAGA,EAAEI,YAAYJ,EAAEK,aAAaS,EAAE7C,OAAOH,OAAO6C,EAAEhB,OAAO,CAACqB,KAAKR,EAAEQ,KAAKE,KAAKV,EAAEU,KAAKD,KAAKT,EAAES,KAAKE,KAAKX,EAAEW"}