import{bb as e,F as t,G as r,H as n,fg as s,bq as i,fC as a,M as o,B as l,je as c,gk as u,hS as d,X as p,j$ as y,i7 as f,d8 as h,k0 as g,g5 as m,f$ as b,g3 as S,jD as w,fF as E,fE as I,fD as x,br as F,eQ as O,P as j,z as R,b4 as Q,b2 as v,cI as _,ab as M,d9 as C,fc as G,jr as J}from"./vendor.7103ff48.js";import{WhereClause as N}from"./WhereClause.fd3015dd.js";import{t as V,e as k,d as A}from"./I3SUtil.fa3bb0fc.js";import{y as W}from"./FeatureFilter.92b7d1aa.js";import{H as B}from"./QueryEngine.e60e2d2b.js";import{e as L}from"./centroid.f07ef5b9.js";const T=e.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let q,D=class extends i{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){a(this,"filter.geometry").then((()=>this.loadAsyncModule(async function(){return!!q||(q=await import("./geometryEngine.2f06c96c.js")),q}().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(o(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=l(this.filter)?this.filter.where:null;if(o(e)||!e)return null;try{return N.create(e,this.layerFieldsIndex)}catch(t){T.error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,n){const s=this.sortedObjectIds;l(s)&&e.push((e=>V(s,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const i=this.parsedGeometry;if(l(i)){const s=this.spatialRelationship;e.push(((e,a)=>function(e,t,r,n,s,i,a){const o=i[0].spatialReference||n.spatialReference;if(!c(t.node.mbs,s,z,o))return void T.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const l=H(z,o),u=function(e,t,r,n,s){const i=t.renderSpatialReference,a=new Map,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};o.rings[0][3]=o.rings[0][0];const l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let c,u;switch(e){case"intersects":c=(e,t)=>q.intersects(e,t)?0:2,u=U;break;case"contains":c=(e,t)=>q.contains(e,t)?2:1,u=U;break;default:c=(e,t)=>q.disjoint(e,t)?2:1,u=X}return{collection:n,object:s,type:e,maskSR:r,renderSR:i,aabbCache:a,triangle:o,positions:l,triangleTest:c,geometryTest:u}}(a,n,o,r,t.objectHandle);for(const c of i){if(0===e.length)return;switch(P(c,l,a)){case 1:return void(e.length=0);case 0:continue}k(e,t.featureIds,(e=>K(c,e,u)))}}(e,a,n,t,r,i,s)))}}isMBSGeoemtryVisible(e,t,r){const n=this.parsedGeometry;if(l(n)){const s=this.spatialRelationship,i=n[0].spatialReference||t;return c(e,r,z,i)?function(e,t,r,n){const s=H(e,r);return t.every((e=>1!==P(e,s,n)))}(z,n,i,s):(T.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){if(o(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(o(e))return null;const{distance:t,units:r}=this.filter,n=this.spatialRelationship,s="mesh"===e.type?e.extent:e;if(o(t)||0===t)return $(s,n);const i=r||u(s.spatialReference);if(s.spatialReference.isWGS84)return $(this._geometryEngine.geodesicBuffer(s,t,i),n);const a=d(s,p.WGS84);if(l(a))return $(d(this._geometryEngine.geodesicBuffer(a,t,i),s.spatialReference),n);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let c=null;try{c=f(s,p.WGS84)}catch(h){}if(c)try{c=f(this._geometryEngine.geodesicBuffer(c,t,i),s.spatialReference)}catch(h){c=null}return c||T.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${s.spatialReference.wkid}) to WGS84.`),$(c,n)}get spatialRelationship(){return l(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(T.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&Z.indexOf(e)>=0}(e.spatialRelationship)||(T.warn(`Filters with spatialRelationship other than ${Z.join(", ")} are not supported for mesh scene layers`),!1)}};t([r({type:W})],D.prototype,"filter",void 0),t([r()],D.prototype,"layerFieldsIndex",void 0),t([r()],D.prototype,"loadAsyncModule",void 0),t([r()],D.prototype,"applyFilters",void 0),t([r()],D.prototype,"addSqlFilter",void 0),t([r({readOnly:!0})],D.prototype,"sortedObjectIds",null),t([r({readOnly:!0})],D.prototype,"parsedWhereClause",null),t([r({readOnly:!0})],D.prototype,"parsedGeometry",null),t([r({readOnly:!0})],D.prototype,"spatialRelationship",null),t([r()],D.prototype,"_projectionEngineLoaded",void 0),t([r()],D.prototype,"_geometryEngine",void 0),D=t([n("esri.views.3d.layers.i3s.I3SMeshViewFilter")],D);const Z=["contains","intersects","disjoint"];function $(e,t){if(o(e))return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let s=0;s<e.rings.length;++s){const r=h(1/0,1/0,-1/0,-1/0);g(r,e.rings[s]),t[s]={type:"polygon",rings:[e.rings[s]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,n=new m;for(let e=0;e<t.length;++e){const s=t[e];for(let n=e+1;n<t.length;++n){const e=t[n];if(e.aabr[0]>=s.aabr[2])break;r.add(e)}r.forEach((e=>{if(s!==e)if(e.aabr[2]<=s.aabr[0])r.delete(e);else if(q.intersects(s,e)){s.rings=s.rings.concat(e.rings),b(s.aabr,e.aabr,s.aabr),delete s._geVersion,r.delete(e);const i=S(t,e,t.length,n);t.splice(i,1)}})),r.add(s)}for(const e of t)delete e.aabr;return t}return[e]}const z=[0,0,0,0];function H(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=t.isWGS84||t.isWebMercator?q.geodesicBuffer(r,e[3],1):q.buffer(r,e[3],1);return n.type="polygon",n}function P(e,t,r){switch(r){case"intersects":case"contains":return U(e,t);case"disjoint":return X(e,t)}}function U(e,t){return q.intersects(e,t)?q.contains(e,t)?0:2:1}function X(e,t){return q.intersects(e,t)?q.contains(e,t)?1:2:0}function K(e,t,r){const{collection:n,object:s,renderSR:i,maskSR:a,geometryTest:o,aabbCache:l}=r;let c=l.get(t);if(!c){const e=n.getObjectTransform(s);n.getComponentAabb(s,t,Y);const r=[[Y[0],Y[1],0],[Y[0],Y[4],0],[Y[3],Y[4],0],[Y[3],Y[1],0]];for(let t=0;t<4;++t)w(r[t],r[t],e.rotationScale),E(r[t],r[t],e.position),I(r[t],i,r[t],a);c={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a},c.rings[0][4]=c.rings[0][0],l.set(t,c)}switch(o(e,c)){case 1:return!1;case 0:return!0}const{triangle:u,triangleTest:d,positions:p}=r,y=u.rings[0][0],f=u.rings[0][1],h=u.rings[0][2],g=n.getObjectTransform(s);n.getComponentPositions(s,t,p);const{indices:m,data:b,stride:S,startIndex:F,endIndex:O}=p;for(let j=F;j<O;j+=3){const t=S*m[j+0],r=S*m[j+1],n=S*m[j+2];x(y,b[t+0],b[t+1],b[t+2]),x(f,b[r+0],b[r+1],b[r+2]),x(h,b[n+0],b[n+1],b[n+2]),w(y,y,g.rotationScale),w(f,f,g.rotationScale),w(h,h,g.rotationScale),E(y,y,g.position),E(f,f,g.position),E(h,h,g.position),I(y,i,y,a),I(f,i,f,a),I(h,i,h,a);const s=f[0]-y[0],o=f[1]-y[1],l=h[0]-y[0],c=h[1]-y[1];if(!(Math.abs(s*c-o*l)<2.3283064365386963e-10))switch(delete u._geVersion,d(e,u)){case 1:return!1;case 0:return!0}}return"intersects"!==r.type}const Y=s(),ee=B;let te=class extends i{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new F}get defaultQueryJSON(){return new O({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:n}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:j.fromJSON(n)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new R("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(r.returnCentroid)throw new R("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const n=await this.dataQueryEngine.executeQuery(r,t),s=Q.fromJSON(n);return s.features.forEach((e=>{e.geometry=null})),s}_ensureQueryJSON(e){if(o(e))return this.defaultQueryJSON;const t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),r=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),s=this.priority,i=this.spatialIndex;return this._dataQueryEngineInstance=new ee({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:i,scheduler:r,priority:s}),this._dataQueryEngineInstance}};t([r({constructOnly:!0})],te.prototype,"layerView",void 0),t([r({constructOnly:!0})],te.prototype,"priority",void 0),t([r({constructOnly:!0})],te.prototype,"spatialIndex",void 0),t([r({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],te.prototype,"spatialReference",void 0),t([r({readOnly:!0,aliasOf:"layerView.i3slayer"})],te.prototype,"layer",void 0),t([r({readOnly:!0})],te.prototype,"defaultQueryJSON",null),te=t([n("esri.views.3d.layers.i3s.I3SQueryEngine")],te);var re=te;class ne{constructor(e){this.objectIdField=e.objectIdField,this.getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:r}=e,n={};this.objectIdField&&(n[this.objectIdField]=e.id);const s=l(t.attributeInfo)&&t.attributeInfo.attributeData;if(l(s))for(const i of Object.keys(s))n[i]=A(s[i],r);return n}getAttribute(e,t){if(t===this.objectIdField)return e.id;const{meta:r,index:n}=e,s=l(r.attributeInfo)&&r.attributeInfo.attributeData;return l(s)?A(s[t],n):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,r,n,s,i]=this.getFeatureExtent(e,se);return new v([5],[t,r,n,s,r,n,s,i,n,t,i,n,t,r,n])}getCentroid(e,t){if(e.geometry)return L(new v,e.geometry,t.hasZ,t.hasM);const[r,n,s,i,a,o]=this.getFeatureExtent(e,se);return new v([0],[(r+i)/2,(n+a)/2,(s+o)/2])}cloneWithGeometry(e,t){const{id:r,index:n,meta:s}=e;return{id:r,index:n,meta:s,geometry:t}}}const se=s();let ie=class extends i{constructor(e){super(e),this.events=new M}forEach(e){this.forAllFeatures((t=>(e(t),1)))}forEachBounds(e,t,r){const n=this.getFeatureExtent;for(const s of e)t(n(s,r))}forEachInBounds(e,t){this.forAllFeatures((r=>{const n=this.getFeatureExtent(r,oe);return C(e,G(n,le))&&t(r),1}),(t=>{if(c(t.node.mbs,this.sourceSpatialReference,ae,this.viewSpatialReference),ae[0]>=e[0]&&ae[2]<=e[2]&&ae[1]>=e[1]&&ae[3]<=e[3])return 1;const r=Math.max(e[0],Math.min(ae[0],e[2])),n=Math.max(e[1],Math.min(ae[1],e[3])),s=ae[0]-r,i=ae[1]-n;return s*s+i*i<=ae[3]*ae[3]?1:2}))}};t([r({constructOnly:!0})],ie.prototype,"featureAdapter",void 0),t([r({constructOnly:!0})],ie.prototype,"forAllFeatures",void 0),t([r({constructOnly:!0})],ie.prototype,"getFeatureExtent",void 0),t([r({constructOnly:!0})],ie.prototype,"sourceSpatialReference",void 0),t([r({constructOnly:!0})],ie.prototype,"viewSpatialReference",void 0),ie=t([n("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],ie);const ae=J(),oe=s(),le=_();var ce=ie;export{D as O,re as d,ce as h,ne as n};
//# sourceMappingURL=I3SQueryFeatureStore.8e7d7921.js.map
