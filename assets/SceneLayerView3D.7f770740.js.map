{"version":3,"file":"SceneLayerView3D.7f770740.js","sources":["../../node_modules/@arcgis/core/views/3d/layers/SceneLayerView3D.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../Graphic.js\";import r from\"../../../core/Logger.js\";import{isSome as i,isNone as s,destroyMaybe as o}from\"../../../core/maybe.js\";import{property as n}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import{subclass as l}from\"../../../core/accessorSupport/decorators/subclass.js\";import{WhereClause as a}from\"../../../core/sql/WhereClause.js\";import u from\"../../../rest/support/Query.js\";import{I3SMeshView3D as d}from\"./I3SMeshView3D.js\";import{LayerView3D as h}from\"./LayerView3D.js\";import{createInteractiveEditSession as p,processAttributeEdits as c}from\"./i3s/attributeEditing.js\";import{createGetFeatureExtent as y}from\"./i3s/I3SGeometryUtil.js\";import{I3SMeshViewFilter as f}from\"./i3s/I3SMeshViewFilter.js\";import g from\"./i3s/I3SQueryEngine.js\";import{I3SQueryFeatureAdapter as m}from\"./i3s/I3SQueryFeatureAdapter.js\";import F from\"./i3s/I3SQueryFeatureStore.js\";import{getIndexCrs as v}from\"./i3s/I3SUtil.js\";import{DefinitionExpressionSceneLayerView as w}from\"./support/DefinitionExpressionSceneLayerView.js\";import{defineFieldProperties as _}from\"./support/fieldProperties.js\";import{PopupSceneLayerView as S}from\"./support/PopupSceneLayerView.js\";import{SceneLayerViewRequiredFields as j}from\"./support/SceneLayerViewRequiredFields.js\";import{updatingProgress as E}from\"../support/updatingProperties.js\";import I from\"../../layers/SceneLayerView.js\";import b from\"../../layers/support/FeatureFilter.js\";import{getFloorFilterClause as x}from\"../../support/floorFilterUtils.js\";import{TaskPriority as C}from\"../../support/Scheduler.js\";const Q=r.getLogger(\"esri.views.3d.layers.SceneLayerView3D\"),q=_();let D=class extends(d(w(S(h(I))))){constructor(){super(...arguments),this.type=\"scene-layer-3d\",this.lodFactor=1,this.progressiveLoadFactor=1,this._elevationContext=\"scene\",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._interactiveEditingSessions=new Map,this._queryEngine=null}get filter(){return i(this.viewFilter)?this.viewFilter.filter:null}set filter(e){!s(e)&&f.checkSupport(e)?i(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new f({filter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,t)=>this.addSqlFilter(e,t,this.logError)}):this.viewFilter=null}get requiredFields(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}get floorFilterClause(){const e=x(this);return i(e)?a.create(e,this.layer.fieldsIndex):null}get lodCrossfadeinDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeinDuration)?e:0}get lodCrossfadeoutDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeoutDuration)?e:0}get lodCrossfadeUncoveredDuration(){var e,t;return null!=(e=null==(t=this.view)?void 0:t.qualitySettings.sceneService[\"3dObject\"].lodCrossfadeUncoveredDuration)?e:0}initialize(){this.fieldsHelper=new j({layerView:this}),this.updatingHandles.add(this.layer,\"rangeInfos\",(e=>this._rangeInfosChanged(e)),2),this.updatingHandles.add(this.layer,\"renderer\",(e=>this.updatingHandles.addPromise(this._rendererChange(e))),2);for(const e of[\"parsedDefinitionExpression\",\"filter\",\"viewFilter.parsedWhereClause\",\"viewFilter.parsedGeometry\",\"viewFilter.sortedObjectIds\",\"floorFilterClause\"])this.updatingHandles.add(this,e,(()=>this._filterChange()));for(const e of[\"filter\",\"viewFilter.parsedGeometry\"])this.updatingHandles.add(this,e,(()=>this._geometryFilterChange()));this.handles.add(this.layer.on(\"apply-edits\",(e=>this.updatingHandles.addPromise(e.result)))),this.handles.add(this.layer.on(\"edits\",(e=>this._handleEdits(e))))}destroy(){this.fieldsHelper=o(this.fieldsHelper)}_rangeInfosChanged(e){null!=e&&e.length>0&&Q.warn(\"Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.\")}createQuery(){const e={outFields:[\"*\"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return i(this.filter)?this.filter.createQuery(e):new u(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((e=>{if(null==e||!e.features)return e;const t=this.layer;for(const r of e.features)r.layer=t,r.sourceLayer=t;return e}))}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=y(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new g({layerView:this,priority:C.FEATURE_QUERY_ENGINE,spatialIndex:new F({featureAdapter:new m({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,t)=>this._forAllFeatures(((t,r,i)=>e({id:t,index:r,meta:i})),t,2),getFeatureExtent:e,sourceSpatialReference:v(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e){const t=this._highlights;if(e instanceof u){const{set:r,handle:i}=t.acquireSet();return this.queryObjectIds(e).then((e=>t.setFeatureIds(r,e))),i}return super.highlight(e)}createInteractiveEditSession(e){return p(this.attributeEditingContext,e)}_createLayerGraphic(e){const r=new t(null,null,e);return r.layer=this.layer,r.sourceLayer=this.layer,r}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}getFilters(){const e=super.getFilters();return this.floorFilterClause&&this.addSqlFilter(e,this.floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),i(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}_ensureQuery(e){return this._addDefinitionExpressionToQuery(s(e)?this.createQuery():u.from(e))}get attributeEditingContext(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:e=>this._forAllNodes((t=>i(t)?e(t.node,t.featureIds):null)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(e,t)=>this.setAttributeData(e,t),clearMemCache:()=>this.clearMemCache()}}_handleEdits(e){c(this.attributeEditingContext,e)}get hasGeometryFilter(){const e=this.viewFilter;return i(e)&&i(e.parsedGeometry)}computeNodeFiltering(e){const t=this.viewFilter;return s(t)||t.isMBSGeoemtryVisible(e,this.view.spatialReference,this._controller.crsIndex)?0:1}};e([n({aliasOf:\"layer\"})],D.prototype,\"i3slayer\",void 0),e([n()],D.prototype,\"suspended\",void 0),e([n(E)],D.prototype,\"updatingProgress\",void 0),e([n({type:b})],D.prototype,\"filter\",null),e([n()],D.prototype,\"viewFilter\",void 0),e([n(q.requiredFields)],D.prototype,\"requiredFields\",null),e([n(q.availableFields)],D.prototype,\"availableFields\",void 0),e([n()],D.prototype,\"fieldsHelper\",void 0),e([n()],D.prototype,\"floorFilterClause\",null),e([n({readOnly:!0,aliasOf:\"view.qualitySettings.sceneService.3dObject.lodFactor\"})],D.prototype,\"lodFactor\",void 0),e([n({readOnly:!0,aliasOf:\"_controller.updatingProgress\"})],D.prototype,\"updatingProgressValue\",void 0),D=e([l(\"esri.views.3d.layers.SceneLayerView3D\")],D);var O=D;export{O as default};\n"],"names":["Q","r","getLogger","q","_","D","d","w","S","h","I","constructor","arguments","this","type","lodFactor","progressiveLoadFactor","_elevationContext","_isIntegratedMesh","_supportsLabeling","_interactiveEditingSessions","Map","_queryEngine","i","viewFilter","filter","e2","s","f","checkSupport","layerFieldsIndex","layer","fieldsIndex","loadAsyncModule","_loadAsyncModule","e3","applyFilters","_applyFilters","addSqlFilter","t2","logError","fieldsHelper","requiredFields","x","a","create","view","qualitySettings","sceneService","lodCrossfadeinDuration","lodCrossfadeoutDuration","lodCrossfadeUncoveredDuration","initialize","j","layerView","updatingHandles","add","_rangeInfosChanged","addPromise","_rendererChange","_filterChange","_geometryFilterChange","handles","on","result","_handleEdits","destroy","o","length","warn","createQuery","outFields","returnGeometry","outSpatialReference","spatialReference","u","queryExtent","_ensureQueryEngine","executeQueryForExtent","_ensureQuery","signal","queryFeatureCount","executeQueryForCount","queryFeatures","executeQuery","then","features","t3","r2","sourceLayer","queryObjectIds","executeQueryForIds","_createQueryEngine","y","renderSpatialReference","_collection","g","priority","C","FEATURE_QUERY_ENGINE","spatialIndex","F","featureAdapter","m","objectIdField","attributeStorageInfo","getFeatureExtent","forAllFeatures","_forAllFeatures","i2","id","index","meta","sourceSpatialReference","v","viewSpatialReference","highlight","_highlights","set","handle","acquireSet","setFeatureIds","super","createInteractiveEditSession","p","attributeEditingContext","_createLayerGraphic","t","canResume","_controller","rootNodeVisible","getFilters","floorFilterClause","parsedDefinitionExpression","addFilters","crsIndex","_addDefinitionExpressionToQuery","from","sessions","_getObjectIdField","forEachNode","_forAllNodes","node","featureIds","i3slayer","attributeOverrides","getAttributeData","setAttributeData","clearMemCache","parsedGeometry","computeNodeFiltering","isMBSGeoemtryVisible","e","n","aliasOf","prototype","E","b","availableFields","readOnly","l","O"],"mappings":"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"}