import{x as e,B as t,M as r,j5 as n,j6 as s,F as i,H as a,bb as o,n3 as l,n4 as u,bq as d,b1 as c,G as f,h7 as p,k$ as y,l1 as h,ih as m}from"./vendor.7103ff48.js";import{n as b}from"./attributeUtils.808b8273.js";const w={setAttribute(){},rollback(){},commit(){}};function F(t,n){const s=n.attributes[t.objectIdField],i=t.sessions.get(s);if(i)return i;const a=e(n.attributes),o=new Set;if(null==s)return w;const l=t.attributeOverrides.createInteractiveEditSession(s),u=new Map;let d=0;const c={setAttribute(e,i){if(0!==d)return;const a=t.fieldsIndex.get(e);if(r(a))return;const c=t.attributeStorageInfo.findIndex((e=>e.name===a.name));if(c<0)return;l.set(c,i);const f=t.attributeStorageInfo[c];let p=!1;o.add(e),t.forEachNode(((e,r)=>{const a=((e,t)=>{const r=u.get(e);if(null==r){const r=t.indexOf(s);return u.set(e,r),r}return r})(e,r);if(-1===a)return;const o=t.getAttributeData(e.index);if(o){const r=o[f.name];r&&(r[a]=i,t.setAttributeData(e.index,o,n),p=!0)}})),p&&t.clearMemCache()},rollback(){if(0===d){for(const e of o)this.setAttribute(e,a[e]);l.rollback(),d=1,t.sessions.delete(s)}},commit(){0===d&&(l.commit(),d=2,t.sessions.delete(s))}};return t.sessions.set(s,c),c}function g(e,r){const n=function(e,t){const r=t.edits.updateFeatures;if(!r||0===r.length)return new A;const n=function(e){const t=new Set;if(!e.updatedFeatures)return t;for(const r of e.updatedFeatures)null!=r.objectId&&null==r.error&&t.add(r.objectId);return t}(t),s=new A,i=new Map;for(let u=0;u<e.attributeStorageInfo.length;u++)i.set(e.attributeStorageInfo[u].name,u);const a=e.fieldsIndex,o=e.objectIdField,l=r.filter((e=>{const t=b(a,e.attributes,o);return n.has(t)}));return e.forEachNode(((t,r)=>{const n=new Set(r);for(const i of l){const l=b(a,i.attributes,o);if(!n.has(l))continue;const u=r.indexOf(l);for(const r in i.attributes){const n=e.fieldsIndex.normalizeFieldName(r),a=x(s,t.index,n),o=i.attributes[r];a.push({featureIndex:u,featureId:l,value:o})}}})),s}(e,r);if(0===n.size)return;const s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);let i=!1;n.forEach(((r,n)=>{const a=e.getAttributeData(n);let o=!1;r.forEach(((r,n)=>{const l=t(a)?a[n]:null,u=s.get(n);for(const{featureIndex:t,value:s,featureId:a}of r)l&&(l[t]=s,o=!0,i=!0),e.attributeOverrides.updateValue(a,u,s)})),o&&e.setAttributeData(n,a,null)})),i&&e.clearMemCache()}function x(e,t,r){const n=function(e,t){const r=e.get(t);if(r)return r;const n=new v;return e.set(t,n),n}(e,t),s=n.get(r);if(s)return s;const i=new Array;return n.set(r,i),i}const v=Map,A=Map;function I(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return e.outFields?n(t,[...s(t,e.outFields),...r]):n(t,r)}}}}const S=e=>{let t=class extends e{constructor(){super(...arguments),this.asyncUpdateState=new Map}autoUpdateAsync(e,t){return function(e,t){const r=()=>{i&&!a&&e(n)},n=()=>{if(!i||a)return t();i.clear(),a=!0;const e=l(i,t);return a=!1,e},s=()=>{i&&(i.destroy(),i=null)};let i=new u(r),a=!1;return e(n),{remove:s}}((t=>this.updateAsync(e,t)),t)}async updateAsync(e,t){if(!this.startAsyncUpdate(e)){try{const r=await t();this._set(e,r)}catch(r){o.getLogger(this.declaredClass).warn(`Async update of "${e}" failed. Async update functions should not throw exceptions.`)}this.endAsyncUpdate(e)&&this.updateAsync(e,t)}}startAsyncUpdate(e){var t;const r=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&r?(this.asyncUpdateState.set(e,2|r),!0):(this.asyncUpdateState.set(e,1|r),!1)}endAsyncUpdate(e){var t;const r=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&r?(this.asyncUpdateState.set(e,-3&r),!0):(this.asyncUpdateState.set(e,r),!1)}};return t=i([a("esri.core.AsyncUpdate")],t),t};let U=class extends(S(d)){};U=i([a("esri.core.AsyncUpdate")],U);const E=o.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields");let N=class extends(S(p)){constructor(e){super(e)}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:s,viewFilterFields:i}=this;return n(e,[...c(t,[]),...c(r,[]),...c(s,[]),...c(i,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",(()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?O((r=>t.collectRequiredFields(r,e))):null})),this.autoUpdateAsync("labelingFields",(()=>{const{layer:e}=this;return e.labelsVisible?O((t=>y(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:t}=this.layerView;return O((r=>h(r,e,t)))}))])}};async function O(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(r){return E.error(r),null}}i([f()],N.prototype,"layerView",void 0),i([f()],N.prototype,"layer",void 0),i([f()],N.prototype,"requiredFields",null),i([f()],N.prototype,"rendererFields",void 0),i([f()],N.prototype,"labelingFields",void 0),i([f()],N.prototype,"viewFilterFields",void 0),N=i([a("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],N);class q extends m{constructor(){super(...arguments),this.layer=null,this.filter=null}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}}i([f()],q.prototype,"layer",void 0),i([f()],q.prototype,"availableFields",null),i([f()],q.prototype,"maximumNumberOfFeatures",null),i([f({readOnly:!0})],q.prototype,"maximumNumberOfFeaturesExceeded",null),i([f()],q.prototype,"filter",void 0);export{I as a,N as c,g as i,q as o,F as s};
//# sourceMappingURL=SceneLayerView.8746491d.js.map
