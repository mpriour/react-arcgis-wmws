import{ie as e,ig as t,ih as i,kY as s,a1 as r,M as a,n6 as n,dc as l,F as o,G as d,H as h}from"./vendor.7103ff48.js";import{u as m}from"./ImageryTileLayerView.2c066d1b.js";import{a as y}from"./RefreshableLayerView.7b9ab281.js";import{a as p}from"./drapedUtils.fabca730.js";import"./rasterProjectionHelper.d2fb66f4.js";import"./popupUtils.99eeb504.js";let g=class extends(m(y(e(t(i))))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage();const e=this.updateFullExtent();this.addResolvingPromise(e);const t=s(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,{tileInfo:t}=this.layer,i=["png","png24","png32","jpg","mixed"].indexOf(t.format)>-1&&e.compatibleWith(t);this.isAlignedMapTile=i;const s=i?t:e.toTileInfo();this._set("tileInfo",s),this.updatingHandles.add(this,"layer.renderer",(()=>this.refresh())),this.updatingHandles.add(this,"layer.interpolation",(()=>this.refresh())),this.updatingHandles.add(this,"layer.bandIds",(()=>this.refresh())),this.updatingHandles.add(this,"layer.multidimensionalDefinition",(()=>this.refresh()))}));this.addResolvingPromise(t)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[i,s]=this.tileInfo.size;return e.width=i,e.height=s,t.clearRect(0,0,i,s),t.getImageData(0,0,i,s)}get imageFormatIsOpaque(){return"jpg"===this.layer.tileInfo.format}get hasMixedImageFormats(){return"mixed"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.tileInfo.lods,t=this.layer.tileInfo.lods,i=e[0].scale,s=t[t.length-1].scale;return this.levelRangeFromScaleRange(i,s)}async fetchTile(e,t,i,s){const l=this.tileInfo,o=this._canSymbolizeInWebGL(),d={tileInfo:l,requestRawData:o,signal:r(s.signal),requestAsImageElement:this.isAlignedMapTile},h=await this.layer.fetchTile(e,t,i,d);if(h instanceof HTMLImageElement)return h;let m=h&&h.pixelBlock;if(a(m))return this._blankTile;if(!o&&(m=await this.layer.applyRenderer(h),a(m)))return this._blankTile;const y=new n([e,t,i],m,l.size[0],l.size[1]);return o?(y.symbolizerRenderer=this.layer.symbolizer.rendererJSON,y.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),y.transformGrid=h.transformGrid):y.isRendereredSource=!0,y.interpolation=this.layer.interpolation,y.bandIds=this.layer.bandIds,y}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return p(e,t,this.view)}refresh(){this.emit("data-changed")}async doRefresh(e){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){return l().supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};o([d({readOnly:!0})],g.prototype,"_blankTile",null),o([d({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),o([d({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),o([d({readOnly:!0})],g.prototype,"dataLevelRange",null),g=o([h("esri.views.3d.layers.ImageryTileLayerView3D")],g);var c=g;export{c as default};
//# sourceMappingURL=ImageryTileLayerView3D.e3f9a981.js.map
