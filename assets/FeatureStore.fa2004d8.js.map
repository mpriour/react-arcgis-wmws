{"version":3,"file":"FeatureStore.fa2004d8.js","sources":["../../node_modules/@arcgis/core/layers/graphics/data/BoundsStore.js","../../node_modules/@arcgis/core/layers/graphics/data/FeatureStore.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport i from\"../../../core/has.js\";import{PooledRBush as s}from\"../../../core/libs/rbush/PooledRBush.js\";const d=5e4,n={minX:0,minY:0,maxX:0,maxY:0};function t(i,s,d){n.minX=s[0],n.minY=s[1],n.maxX=s[2],n.maxY=s[3],i.search(n,d)}class e{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new s(9,i(\"csp-restrictions\")?i=>({minX:i[0],minY:i[1],maxX:i[2],maxY:i[3]}):[\"[0]\",\"[1]\",\"[2]\",\"[3]\"]),this._loadIndex=()=>{if(this._indexInvalid){const i=new Array(this._idByBounds.size);let s=0;this._idByBounds.forEach(((d,n)=>{i[s++]=n})),this._indexInvalid=!1,this._index.clear(),this._index.load(i)}else this._boundsToLoad.length&&(this._index.load(this._boundsToLoad.filter((i=>this._idByBounds.has(i)))),this._boundsToLoad.length=0)}}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(i){const s=this._boundsById.get(i);this._boundsById.delete(i),s&&(this._idByBounds.delete(s),this._indexInvalid||this._index.remove(s))}forEachInBounds(i,s){this._loadIndex(),t(this._index,i,(i=>s(this._idByBounds.get(i))))}get(i){return this._boundsById.get(i)}has(i){return this._boundsById.has(i)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(i,s){if(!this._indexInvalid){const s=this._boundsById.get(i);s&&(this._index.remove(s),this._idByBounds.delete(s))}this._boundsById.set(i,s),s&&(this._idByBounds.set(s,i),this._indexInvalid||(this._boundsToLoad.push(s),this._boundsToLoad.length>d&&this._loadIndex()))}}export{e as BoundsStore};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport e from\"../../../core/Error.js\";import t from\"../../../core/Evented.js\";import r from\"../../../core/Logger.js\";import{isSome as s,isNone as o}from\"../../../core/maybe.js\";import{fromRect as i}from\"../../../geometry/support/aaBoundingBox.js\";import{create as a,NEGATIVE_INFINITY as d}from\"../../../geometry/support/aaBoundingRect.js\";import{getBoundsOptimizedGeometry as n}from\"../featureConversionUtils.js\";import{BoundsStore as h}from\"./BoundsStore.js\";import{optimizedFeatureQueryEngineAdapter as u}from\"./optimizedFeatureQueryEngineAdapter.js\";class m{constructor(e){this.geometryInfo=e,this._boundsStore=new h,this._featuresById=new Map,this._markedIds=new Set,this.events=new t,this.featureAdapter=u}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){if(!this.numFeatures)return null;const e=a(d);return this._featuresById.forEach((t=>{const r=this._boundsStore.get(t.objectId);r&&(e[0]=Math.min(r[0],e[0]),e[1]=Math.min(r[1],e[1]),e[2]=Math.max(r[2],e[2]),e[3]=Math.max(r[3],e[3]))})),e}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{s(t.geometry)&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t,r){for(const s of e){const e=this._boundsStore.get(s.objectId);e&&t(i(r,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,r)=>{this._markedIds.has(r)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit(\"changed\",void 0)}_add(t){if(!t)return;const i=t.objectId;if(null==i)return void r.getLogger(\"esri.layers.graphics.data.FeatureStore\").error(new e(\"featurestore:invalid-feature\",\"feature id is missing\",{feature:t}));const d=this._featuresById.get(i);let h;if(this._markedIds.add(i),d?(t.displayId=d.displayId,h=this._boundsStore.get(i),this._boundsStore.delete(i)):s(this.onFeatureAdd)&&this.onFeatureAdd(t),o(t.geometry)||!t.geometry.coords||!t.geometry.coords.length)return this._boundsStore.set(i,null),void this._featuresById.set(i,t);h=n(s(h)?h:a(),t.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),s(h)&&this._boundsStore.set(i,h),this._featuresById.set(i,t)}_remove(e){return s(this.onFeatureRemove)&&this.onFeatureRemove(e),this._markedIds.delete(e.objectId),this._boundsStore.delete(e.objectId),this._featuresById.delete(e.objectId),e}}export{m as default};\n"],"names":["n","minX","minY","maxX","maxY","constructor","_indexInvalid","this","_boundsToLoad","_boundsById","Map","_idByBounds","_index","s","i","_loadIndex","Array","size","s2","forEach","d2","n2","clear","load","length","filter","has","delete","get","remove","forEachInBounds","search","t","i2","invalidateIndex","set","s3","push","e","geometryInfo","_boundsStore","h","_featuresById","_markedIds","Set","events","featureAdapter","u","geometryType","hasM","hasZ","numFeatures","e2","a","d","r2","t2","objectId","Math","min","max","geometry","coords","featureCount","vertexCount","add","_add","_emitChanged","addMany","removeById","_remove","removeManyById","e3","forEachBounds","getFeature","startMarkingUsedFeatures","sweep","emit","r","getLogger","error","feature","h2","displayId","onFeatureAdd","o","onFeatureRemove"],"mappings":"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"}