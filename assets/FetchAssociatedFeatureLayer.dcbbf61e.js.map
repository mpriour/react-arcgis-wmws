{"version":3,"file":"FetchAssociatedFeatureLayer.dcbbf61e.js","sources":["../../node_modules/@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{isNone as e,isSome as a}from\"../../core/maybe.js\";import{throwIfAbortError as i}from\"../../core/promiseUtils.js\";import s from\"../FeatureLayer.js\";import n from\"../../portal/Portal.js\";import o from\"../../portal/PortalItem.js\";class l{constructor(t,r,e,a){this.parsedUrl=t,this.portalItem=r,this.apiKey=e,this.signal=a,this.rootDocument=null;const i=this.parsedUrl.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);i&&(this.urlParts={root:i[1],layerId:parseInt(i[2],10)})}async fetch(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();if(e(r))return this.loadFromUrl();const a=await this.findAndLoadRelatedPortalItem(r);return e(a)?null:this.loadFeatureLayerFromPortalItem(a)}async fetchPortalItem(){var t;if(!this.urlParts)return null;const r=null!=(t=this.portalItem)?t:await this.portalItemFromServiceItemId();return e(r)?null:this.findAndLoadRelatedPortalItem(r)}async fetchRootDocument(){if(a(this.rootDocument))return this.rootDocument;if(e(this.urlParts))return this.rootDocument={},{};const t={query:{f:\"json\",token:this.apiKey},responseType:\"json\",signal:this.signal},i=`${this.urlParts.root}/SceneServer`;try{const e=await r(i,t);this.rootDocument=e.data}catch{this.rootDocument={}}return this.rootDocument}async fetchServiceOwningPortalUrl(){var e;const a=null==(e=t)?void 0:e.findServerInfo(this.parsedUrl.path);if(null!=a&&a.owningSystemUrl)return a.owningSystemUrl;const s=this.parsedUrl.path.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const t=(await r(s,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(n){i(n)}return null}async findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return i(r),null}}async loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this.findMatchingAssociatedSublayerUrl(t.url);return new s({url:r,portalItem:t}).load({signal:this.signal})}async loadFromUrl(){const t=await this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return new s({url:t}).load({signal:this.signal})}async findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a={query:{f:\"json\"},responseType:\"json\",authMode:\"no-prompt\",signal:this.signal},i=this.urlParts.layerId,s=this.fetchRootDocument(),n=r(e,a),[o,l]=await Promise.all([n,s]),c=l&&l.layers,h=o.data&&o.data.layers;if(!Array.isArray(h))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,h.length);r++){if(c[r].id===i)return`${e}/${h[r].id}`}else if(i<h.length)return`${e}/${h[i].id}`;throw new Error(\"could not find matching associated sublayer\")}async portalItemFromServiceItemId(){const t=(await this.fetchRootDocument()).serviceItemId;if(!t)return null;const r=new o({id:t,apiKey:this.apiKey}),e=await this.fetchServiceOwningPortalUrl();a(e)&&(r.portal=new n({url:e}));try{return r.load({signal:this.signal})}catch(s){return i(s),null}}}export{l as FetchAssociatedFeatureLayer};\n"],"names":["constructor","t2","r2","e","a","parsedUrl","this","portalItem","apiKey","signal","rootDocument","i","path","match","urlParts","root","layerId","parseInt","t","portalItemFromServiceItemId","loadFromUrl","findAndLoadRelatedPortalItem","loadFeatureLayerFromPortalItem","query","f","token","responseType","r","data","findServerInfo","owningSystemUrl","s","replace","n2","fetchRelatedItems","relationshipType","direction","find","t3","type","load","findMatchingAssociatedSublayerUrl","url","authMode","fetchRootDocument","o","l2","Promise","all","c","layers","h","Array","isArray","Error","Math","min","length","id","serviceItemId","fetchServiceOwningPortalUrl","portal","n"],"mappings":"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"}