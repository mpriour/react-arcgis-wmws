{"version":3,"file":"ImageryTileLayerView3D.e3f9a981.js","sources":["../../node_modules/@arcgis/core/views/3d/layers/ImageryTileLayerView3D.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{unwrap as r,isNone as t}from\"../../../core/maybe.js\";import{whenTrueOnce as i}from\"../../../core/watchUtils.js\";import{property as s}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as a}from\"../../../core/accessorSupport/decorators/subclass.js\";import{LayerView3D as o}from\"./LayerView3D.js\";import{TiledLayerView3D as l}from\"./TiledLayerView3D.js\";import n from\"../terrain/RasterTile.js\";import{ImageryTileLayerView as m}from\"../../layers/ImageryTileLayerView.js\";import d from\"../../layers/LayerView.js\";import{RefreshableLayerView as h}from\"../../layers/RefreshableLayerView.js\";import{createQueryGeometry as p}from\"../../support/drapedUtils.js\";import y from\"../../webgl/capabilities.js\";let c=class extends(m(h(l(o(d))))){constructor(){super(...arguments),this.type=\"imagery-tile-3d\",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage();const e=this.updateFullExtent();this.addResolvingPromise(e);const r=i(this.view,\"basemapTerrain.tilingSchemeLocked\").then((()=>{const e=this.view.basemapTerrain.tilingScheme,{tileInfo:r}=this.layer,t=[\"png\",\"png24\",\"png32\",\"jpg\",\"mixed\"].indexOf(r.format)>-1&&e.compatibleWith(r);this.isAlignedMapTile=t;const i=t?r:e.toTileInfo();this._set(\"tileInfo\",i),this.updatingHandles.add(this,\"layer.renderer\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.interpolation\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.bandIds\",(()=>this.refresh())),this.updatingHandles.add(this,\"layer.multidimensionalDefinition\",(()=>this.refresh()))}));this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement(\"canvas\"),r=e.getContext(\"2d\"),[t,i]=this.tileInfo.size;return e.width=t,e.height=i,r.clearRect(0,0,t,i),r.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return\"jpg\"===this.layer.tileInfo.format}get hasMixedImageFormats(){return\"mixed\"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.tileInfo.lods,r=this.layer.tileInfo.lods,t=e[0].scale,i=r[r.length-1].scale;return this.levelRangeFromScaleRange(t,i)}async fetchTile(e,i,s,a){const o=this.tileInfo,l=this._canSymbolizeInWebGL(),m={tileInfo:o,requestRawData:l,signal:r(a.signal),requestAsImageElement:this.isAlignedMapTile},d=await this.layer.fetchTile(e,i,s,m);if(d instanceof HTMLImageElement)return d;let h=d&&d.pixelBlock;if(t(h))return this._blankTile;if(!l&&(h=await this.layer.applyRenderer(d),t(h)))return this._blankTile;const p=new n([e,i,s],h,o.size[0],o.size[1]);return l?(p.symbolizerRenderer=this.layer.symbolizer.rendererJSON,p.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),p.transformGrid=d.transformGrid):p.isRendereredSource=!0,p.interpolation=this.layer.interpolation,p.bandIds=this.layer.bandIds,p}_getSymbolizerOptions(e){const r=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,r){return p(e,r,this.view)}refresh(){this.emit(\"data-changed\")}async doRefresh(e){this.suspended||this.emit(\"data-changed\")}_canSymbolizeInWebGL(){return y().supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};e([s({readOnly:!0})],c.prototype,\"_blankTile\",null),e([s({readOnly:!0})],c.prototype,\"imageFormatIsOpaque\",null),e([s({readOnly:!0})],c.prototype,\"hasMixedImageFormats\",null),e([s({readOnly:!0})],c.prototype,\"dataLevelRange\",null),c=e([a(\"esri.views.3d.layers.ImageryTileLayerView3D\")],c);var g=c;export{g as default};\n"],"names":["c","m","h","l","o","d","constructor","arguments","this","type","isAlignedMapTile","initialize","layer","increaseRasterJobHandlerUsage","e2","updateFullExtent","addResolvingPromise","r","i","view","then","e3","basemapTerrain","tilingScheme","tileInfo","r2","t2","indexOf","format","compatibleWith","toTileInfo","_set","updatingHandles","add","refresh","destroy","decreaseRasterJobHandlerUsage","document","createElement","getContext","size","width","height","clearRect","getImageData","lods","scale","length","levelRangeFromScaleRange","e","s","a2","o2","_canSymbolizeInWebGL","requestRawData","signal","requestAsImageElement","d2","fetchTile","HTMLImageElement","pixelBlock","t","_blankTile","applyRenderer","p2","n","symbolizerRenderer","symbolizer","rendererJSON","symbolizerParameters","generateWebGLParameters","_getSymbolizerOptions","transformGrid","isRendereredSource","interpolation","bandIds","lodAt","resolution","isGCS","spatialReference","isGeographic","x","y","ensureSymbolizerParameters","JSON","stringify","lij","createFetchPopupFeaturesQueryGeometry","p","emit","suspended","supportsTextureFloat","canRenderInWebGL","readOnly","prototype","a","g"],"mappings":"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"}