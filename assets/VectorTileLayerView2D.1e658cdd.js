var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,a=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,o=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&a(e,s,t[s]);if(i)for(var s of i(t))l.call(t,s)&&a(e,s,t[s]);return e},n=(e,i)=>t(e,s(i));import{bs as h,dB as c,nR as d,M as u,B as y,ab as _,na as p,nb as f,nY as m,ea as g,ex as v,c7 as b,a1 as T,ah as C,cI as w,hP as S,bm as R,bb as D,ih as I,br as P,z as x,bt as H,D as L,e3 as z,hE as k,bv as M,nO as U,x as B,ag as F,nc as q,F as Q,G as V,H as j}from"./vendor.7103ff48.js";import{r as O,i as E,a as A,f as N,o as W}from"./SymbolRepository.47a0aef4.js";import{I as $}from"./Utils.8f00ae04.js";import{o as G}from"./TileContainer.555234dd.js";import{g as Z}from"./StyleRepository.d0853bab.js";import{l as K}from"./LayerView2D.3bec42c6.js";import{x as Y}from"./Bitmap.8c3290a1.js";import{t as J}from"./BitmapContainer.f66ff0c9.js";import"./Rect.db562a93.js";import"./CIMSymbolHelper.da5834c9.js";import"./TileIndex.3ffc9499.js";import"./TilemapCache.59c5ee62.js";import"./WGLContainer.6f073475.js";import"./brushes.b64b90a9.js";import"./definitions.e5e12ce7.js";import"./ShaderCompiler.6905b522.js";import"./GeometryUtils.1bcb906c.js";import"./MaterialKey.8df623c8.js";import"./pixelUtils.5eddfa69.js";import"./Container.f525a10f.js";const X=(e,t)=>e+1/(1<<2*t);class ee{constructor(e,t){this._tiles=new Map,this._tileCache=new h(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,s=t.getTileCoverage(e.state,0,"smallest"),{spans:i,lodInfo:r}=s,{level:l}=r,a=this._tiles,o=new Set,n=new Set;for(const{row:d,colFrom:u,colTo:y}of i)for(let e=u;e<=y;e++){const t=c.getId(l,d,r.normalizeCol(e),r.getWorldForColumn(e)),s=this._getOrAcquireTile(t);o.add(t),s.processed()?this._addToContainer(s):n.add(new c(t))}for(const[c,d]of a)d.isCoverage=o.has(c);for(const c of n)this._findPlaceholdersForMissingTiles(c,o);let h=!1;for(const[c,d]of a)d.neededForCoverage=o.has(c),d.neededForCoverage||d.isHoldingForFade&&t.intersects(s,d.key)&&o.add(c),d.isFading&&(h=!0);for(const[c,d]of this._tiles)o.has(c)||this._releaseTile(c);return d.pool.release(s),!h}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,t){const s=[];for(const[r,l]of this._tiles)this._addPlaceholderChild(s,l,e,t);const i=s.reduce(X,0);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,s,i){t.key.level<=s.level||!t.hasData()||function(e,t){const s=t.level-e.level;return e.row===t.row>>s&&e.col===t.col>>s&&e.world===t.world}(s,t.key)&&(this._addToContainer(t),i.add(t.id),e.push(t.key.level-s.level))}_addPlaceholderParent(e,t){const s=this._tiles;let i=e;for(;;){if(i=te(i),!i||t.has(i))return;const e=s.get(i);if(e&&e.hasData())return this._addToContainer(e),void t.add(e.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new c(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const s=[],i=this._container;if(i.contains(e))return;const r=this._visibleTiles;for(const[l,a]of r)this._canConnectDirectly(e,a)&&s.push(a),u(t)&&this._canConnectDirectly(a,e)&&(t=a);if(y(t)){for(const i of s)t.childrenTiles.delete(i),e.childrenTiles.add(i),i.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const l of s)e.childrenTiles.add(l),l.parentTile=e;r.set(e.id,e),i.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),y(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)y(e.parentTile)&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const s=e.key;let{level:i,row:r,col:l,world:a}=t.key;const o=this._visibleTiles;for(;i>0;){if(i--,r>>=1,l>>=1,s.level===i&&s.row===r&&s.col===l&&s.world===a)return!0;if(o.has(`${i}/${r}/${l}/${a}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const s=Math.ceil(t[0]/512)+1,i=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*s*i}}function te(e){const[t,s,i,r]=e.split("/"),l=parseInt(t,10);return 0===l?null:`${l-1}/${parseInt(s,10)>>1}/${parseInt(i,10)>>1}/${parseInt(r,10)}`}class se extends _{constructor(e,t){super(),this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new O(4096,t,(()=>new p)),this._symbolDeclutterer=new E(t,this._symbolRepository,((e,t,s)=>new A(e,t,s,this.styleRepository,this._zoom,this._viewState.rotation)),((e,t)=>{e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,f(e,t,!0),e.decluttered=!0,e.requestRender()}),((e,t)=>this.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z),(e=>{const t=this.styleRepository.getStyleLayerByUID(e);if(this._zoom<t.minzoom||this._zoom>t.maxzoom)return!1;const s=t.getLayoutProperty("visibility");return!s||1!==s.getValue()}))}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",(()=>{this._symbolRepository.add(e),this.restartDeclutter()}))),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((e=>e.remove())),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(m),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){y(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((()=>{this._stableNotificationHandle=null,this.emit("fade-complete")}),1.5*g)}_notifyUnstable(){y(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class ie extends v{_createTransforms(){return{dvs:b(),tileMat3:b()}}}const re=1e-6;function le(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||1!==s.getValue()&&(void 0===e.minzoom||e.minzoom<t+re)&&(void 0===e.maxzoom||e.maxzoom>=t-re))return!0}return!1}class ae extends G{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),y(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(e,t,s){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,u(this._symbolFader)){const e=new se(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=e}T(this._symbolFader).styleRepository=s}deleteStyleLayers(e){y(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}async hitTest(e,t){const s=[e,t],i=C();return this._pointToCallbacks.set(s,i),this.requestRender(),i.promise}enterTileInvalidation(){for(const e of this.children)e.invalidating=!0}createRenderParams(e){return n(o({},super.createRenderParams(e)),{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}doRender(e){!this.visible||e.drawPhase!==$.MAP&&e.drawPhase!==$.DEBUG||void 0===this._spriteMosaic||super.doRender(e)}addChild(e){return super.addChild(e),y(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return y(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){if(e.drawPhase!==$.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){const{context:t}=e,s=t.getBoundFramebufferObject();e.drawPhase=$.HITTEST;const i=e.painter.effects.hittest;i.bind(e),this._doRender(e),i.draw(e,this._pointToCallbacks),t.bindFramebuffer(s)}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];y(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))}restartDeclutter(){y(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const i=s.layers;let r=!0;e.drawPhase===$.HITTEST&&(r=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===$.MAP&&this._fade(e.displayLevel,e.state);const l=this.children.filter((e=>e.visible&&e.hasData()));if(l&&0!==l.length){for(const e of l)e.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(7680,7680,7681),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(515),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let t=i.length-1;t>=0;t--)this._renderStyleLayer(i[t],e,l);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(r),t.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let t=0;t<i.length;t++)this._renderStyleLayer(i[t],e,l);t.setDepthTestEnabled(!1),e.renderPass="symbol";for(let t=0;t<i.length;t++)this._renderStyleLayer(i[t],e,l);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}}_fade(e,t){y(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{painter:i,renderPass:r}=t;if(void 0===e)return;const l=e.getLayoutProperty("visibility");if(l&&1===l.getValue())return;let a;switch(e.type){case 0:return;case 1:if("opaque"!==r&&"translucent"!==t.renderPass)return;a="vtlFill";break;case 2:if("translucent"!==r)return;a="vtlLine";break;case 4:if("symbol"!==r)return;a="vtlCircle";break;case 3:if("symbol"!==r)return;a="vtlSymbol"}if(s=3===e.type?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==a){const i=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=i+re||void 0!==e.maxzoom&&e.maxzoom<i-re)return}const o=e.uid;t.styleLayerUID=o,t.styleLayer=e;for(const n of s)if(n.layerData.has(o)){i.renderObjects(t,s,a);break}}_renderBackgroundLayers(e,t){const{context:s,displayLevel:i,painter:r,state:l}=e,a=this._styleRepository;let o=!1;for(const c of t)if(le(a.getLayerById(c),i)){o=!0;break}if(!o)return;const n=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:h,lodInfo:u}=n,{level:_}=u,p=w(),f=[];if(this._renderPasses){const t=this._renderPasses[0];y(this._clippingInfos)&&(t.brushes[0].prepareState(e,this._clippingInfos[0]),t.brushes[0].drawMany(e,this._clippingInfos))}const m=this._backgroundTiles;let g,v=0;for(const{row:d,colFrom:y,colTo:T}of h)for(let e=y;e<=T;e++){if(v<m.length)g=m[v],g.key.set(_,d,u.normalizeCol(e),u.getWorldForColumn(e)),this._tileInfoView.getTileBounds(p,g.key,!1),g.x=p[0],g.y=p[3];else{const t=new c(_,d,u.normalizeCol(e),u.getWorldForColumn(e)),s=this._tileInfoView.getTileBounds(w(),t);g=new ie(t,s[0],s[3],512,512,4096,4096),m.push(g)}g.setTransform(l,this._tileInfoView.getTileResolution(g.key)),f.push(g),v++}s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(7680,7680,7681),s.setStencilFunction(514,0,255);let b=!0;e.drawPhase===$.HITTEST&&(b=!1),s.setStencilTestEnabled(b);for(const c of t){const t=a.getLayerById(c);le(t,i)&&(e.styleLayerUID=t.uid,e.styleLayer=t,r.renderObjects(e,f,"vtlBackground"))}d.pool.release(n)}}class oe extends J{constructor(e){super(),this.requestRender=this.requestRender.bind(this),this._layerView=e,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._bitmap=new Y(null,"standard",!1),this.addChild(this._bitmap)}doRender(e){const t=e.state,s=this._createCustomRenderParams(e),i=s.pixelRatio,r=this._canvas,l=this._bitmap;r.width=t.size[0]*i,r.height=t.size[1]*i,l.resolution=t.resolution,l.pixelRatio=i,l.x=t.viewpoint.targetGeometry.x-Math.abs(t.extent.xmax-t.extent.xmin)/2,l.y=t.viewpoint.targetGeometry.y+Math.abs(t.extent.ymax-t.extent.ymin)/2,this._layerView.render(s),l.source=r,l.rotation=t.rotation,super.doRender(e)}_createCustomRenderParams(e){const t=window.devicePixelRatio,s=n(o({},e.state),{pixelRatio:t});return n(o({},e),{pixelRatio:t,context:this._context,state:s})}}class ne extends S{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){const t=c.pool.acquire(e),s=0===t.level?null:c.getId(t.level-1,t.row>>1,t.col>>1,t.world);return c.pool.release(t),s}getTileCoverage(e,t,s){const i=super.getTileCoverage(e,t,s);if(!i)return i;const r=1<<i.lodInfo.level;return i.spans=i.spans.filter((e=>e.row>=0&&e.row<r)),i}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let s,i;for(let r=0;r<t.length-1;r++)if(i=t[r+1],e>i.scale)return s=t[r],s.level+(s.scale-e)/(s.scale-i.scale);return t[t.length-1].level}}_initializeFullCacheLODs(e){let t;if(0===e[0].level)t=e.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));else{const e=this.tileInfo.size[0],s=this.tileInfo.spatialReference;t=R.create({size:e,spatialReference:s}).lods.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})))}for(let s=0;s<t.length;s++)this._levelByScale[t[s].scale]=t[s].level;this._fullCacheLodInfos=t}}const he=D.getLogger("esri.views.2d.layers.VectorTileLayerView2D");let ce=class extends(K(I)){constructor(){super(...arguments),this._styleChanges=[],this._handles=new P,this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1}initialize(){const e=this.layer.tileInfo;if(!(e&&e.spatialReference).equals(this.view.spatialReference))return void this.addResolvingPromise(Promise.reject(new x("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})));const{style:t,spriteUrl:s,glyphsUrl:i}=this.layer.currentStyleInfo;this._styleRepository=new Z(t,{spriteUrl:s,glyphsUrl:i}),this._tileInfoView=new ne(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new ae(this._tileInfoView),this._tileHandler=new N(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",(()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(()=>{this._collisionBoxesDisplay&&this._collisionBoxesDisplay.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()})),H(this.layer,"symbolCollisionBoxesVisible",(e=>{e?(this._collisionBoxesDisplay=new oe({render:e=>this._renderCollisionBoxes(e.context)}),this.container.addChild(this._collisionBoxesDisplay)):(this.container.removeChild(this._collisionBoxesDisplay),this._collisionBoxesDisplay=null)}))])}destroy(){var e;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),null==(e=this._tileHandler)||e.destroy(),this._tileHandler=null}async hitTest(e,t){if(this.suspended||!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const s=await this._vectorTileContainer.hitTest(e,t);if(!s||0===s.length)return null;const i=s[0]-1,r=this._styleRepository,l=r.getStyleLayerByUID(i);if(!l)return null;const a=r.getStyleLayerIndex(l.id),o=new L({attributes:{layerId:a,layerName:l.id,layerUID:i}});return o.layer=this.layer,o.sourceLayer=this.layer,o}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){this._start(),this._handles.add([this.layer.on("paint-change",(e=>{if(e.isDataDriven)this._styleChanges.push({type:0,data:e}),this.notifyChange("updating"),this.requestUpdate();else{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const i=3===s.type;t.setPaintProperties(e.layer,e.paint),i&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const i=z(s.layout,e.layout);if(!u(i)){if(k(i,"visibility")&&1===function(e){if(u(e))return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(i))return t.setLayoutProperties(e.layer,e.layout),3===s.type&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:1,data:e}),this.notifyChange("updating"),this.requestUpdate()}})),this.layer.on("style-layer-visibility-change",(e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);s&&(t.setStyleLayerVisibility(e.layer,e.visibility),3===s.type&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(e=>{this._styleChanges.push({type:2,data:e}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("delete-style-layer",(e=>{this._styleChanges.push({type:3,data:e}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("load-style",(()=>this._loadStyle()))])}detach(){this._stop(),this._handles.removeAll()}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionBoxesDisplay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}canResume(){let e=super.canResume();const t=this.layer;if(e&&t.currentStyleInfo){const s=this.view.scale,i=t.currentStyleInfo;if(i&&i.layerDefinition){const t=i.layerDefinition;t.minScale&&t.minScale<s&&(e=!1),t.maxScale&&t.maxScale>s&&(e=!1)}}return e}isUpdating(){const e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.filter((e=>e.invalidating)).length>0||this.fading}acquireTile(e){const t=this._createVectorTile(e);return this._tileHandlerPromise.then((()=>{this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e}))).then((e=>{t.once("attach",(()=>this.requestUpdate())),e&&(t.setData(e.tileData),this.requestUpdate(),this.notifyChange("updating"))})).catch((e=>{this.notifyChange("updating"),M(e)||he.error(e)}))})),t}releaseTile(e){const t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new ee({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then((()=>{this._fetchQueue=new U({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15}),this._parseQueue=new U({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()})),this._tileHandlerAbortController=e,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(e,t){const s=await this._tileHandler.fetchTileData(e,t);return this.notifyChange("updating"),s}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const e=this._styleChanges;try{await this._tileHandler.updateStyle(e)}catch(a){he.error("error applying vector-tiles style update",a.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const t=this._styleRepository,s=[];e.forEach((e=>{if(3!==e.type)return;const i=e.data,r=t.getLayerById(i.layer);r&&s.push(r.uid)}));const i=[];let r;e.forEach((e=>{const s=e.type,l=e.data;switch(s){case 0:t.setPaintProperties(l.layer,l.paint),r=l.layer;break;case 1:t.setLayoutProperties(l.layer,l.layout),r=l.layer;break;case 3:return void t.deleteStyleLayer(l.layer);case 2:t.setStyleLayer(l.layer,l.index),r=l.layer.id}const a=t.getLayerById(r);a&&i.push(a.uid)}));const l=this._vectorTileContainer.children;if(s.length>0){this._vectorTileContainer.deleteStyleLayers(s);for(const e of l)e.deleteLayerData(s)}if(this._fetchQueue.resume(),this._parseQueue.resume(),i.length>0){const e=[];for(const t of l){const s=this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e,styleLayerUIDs:i}))).then((e=>t.setData(e.tileData)));e.push(s)}await Promise.all(e)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:e,spriteUrl:t,glyphsUrl:s}=this.layer.currentStyleInfo,i=B(e);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new Z(i,{spriteUrl:t,glyphsUrl:s}),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=F();const{signal:r}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i),await this._tileHandlerPromise}catch(a){if(!M(a))throw a}if(r.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const l=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(l,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(e){const t=this._tileInfoView.getTileBounds(w(),e);return new q(e,t[0],t[3],512,512,this._styleRepository)}_renderCollisionBoxes(e){for(const t of this._vectorTileContainer.children)if(t.symbols){const s=[];for(const[e,i]of t.symbols)s.push(...i);W(e,s)}}};Q([V()],ce.prototype,"_fetchQueue",void 0),Q([V()],ce.prototype,"_parseQueue",void 0),Q([V()],ce.prototype,"_isTileHandlerReady",void 0),Q([V()],ce.prototype,"suspended",void 0),Q([V()],ce.prototype,"fading",void 0),Q([V()],ce.prototype,"updating",void 0),ce=Q([j("esri.views.2d.layers.VectorTileLayerView2D")],ce);var de=ce;export{de as default};
//# sourceMappingURL=VectorTileLayerView2D.1e658cdd.js.map
