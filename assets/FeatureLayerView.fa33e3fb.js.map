{"version":3,"file":"FeatureLayerView.fa33e3fb.js","sources":["../../node_modules/@arcgis/core/views/layers/support/FeatureEffect.js","../../node_modules/@arcgis/core/views/layers/FeatureLayerView.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import{JSONSupport as t}from\"../../../core/JSONSupport.js\";import{property as r}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/has.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/Logger.js\";import{subclass as o}from\"../../../core/accessorSupport/decorators/subclass.js\";import s from\"./FeatureFilter.js\";var i;let c=i=class extends t{constructor(){super(...arguments),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}clone(){return new i({filter:this.filter&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};e([r({type:s,json:{write:!0}})],c.prototype,\"filter\",void 0),e([r({json:{write:!0}})],c.prototype,\"includedEffect\",void 0),e([r({json:{write:!0}})],c.prototype,\"excludedEffect\",void 0),e([r({type:Boolean,json:{write:!0}})],c.prototype,\"excludedLabelsVisible\",void 0),c=i=e([o(\"esri.views.layers.support.FeatureEffect\")],c);var l=c;export{l as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.21/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../chunks/tslib.es6.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{isSome as i,isNone as s}from\"../../core/maybe.js\";import{eachAlways as o}from\"../../core/promiseUtils.js\";import{init as n,on as l}from\"../../core/watchUtils.js\";import{property as a}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/accessorSupport/ensureType.js\";import{subclass as u}from\"../../core/accessorSupport/decorators/subclass.js\";import{combinedViewLayerTimeExtentProperty as p}from\"../../layers/support/commonProperties.js\";import{fixFields as d,unpackFieldNames as m,collectLabelingFields as c,collectElevationFields as f,collectFilterFields as y,collectFeatureReductionFields as h,collectOrderByInfos as F,collectFields as w,collectField as g,featureHasFields as x}from\"../../layers/support/fieldUtils.js\";import b from\"../../rest/support/Query.js\";import{loadArcade as E}from\"../../support/arcadeOnDemand.js\";import v from\"./support/FeatureEffect.js\";import j from\"./support/FeatureFilter.js\";import{getFetchPopupTemplate as q,getRequiredFields as I}from\"./support/popupUtils.js\";import{getFloorFilterClause as R}from\"../support/floorFilterUtils.js\";const _=r.getLogger(\"esri.views.layers.FeatureLayerView\"),P=r=>{let P=class extends r{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){n(this,[\"layer.renderer\",\"layer.labelingInfo\",\"layer.elevationInfo.featureExpressionInfo\",\"layer.displayField\",\"filter\",\"effect\",\"layer.timeInfo\",\"layer.floorInfo\",\"timeExtent\"],(()=>this._handleRequiredFieldsChange()),!0),l(this,\"view.floors\",\"change\",(()=>this._handleRequiredFieldsChange())),l(this,\"layer.sublayer\",\"change\",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return\"outFields\"in e&&e.outFields?d(t,[...m(t,e.outFields),...r]):d(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){_.error(\"#maximumNumberOfFeatures=\",\"Setting maximum number of features is not supported\")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error(\"missing implementation\")}createQuery(){const e={outFields:[\"*\"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=i(this.filter)?this.filter.createQuery(e):new b(e);if(\"feature\"===this.layer.type){const e=R(this);i(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return i(this.timeExtent)&&(t.timeExtent=i(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error(\"missing implementation\")}queryObjectIds(e,t){throw new Error(\"missing implementation\")}queryFeatureCount(e,t){throw new Error(\"missing implementation\")}queryExtent(e,t){throw new Error(\"missing implementation\")}_loadArcadeModules(e){if(e.get(\"expressionInfos.length\"))return E()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set(\"_updatingRequiredFieldsPromise\",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set(\"_updatingRequiredFieldsPromise\",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=\"3d\"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:s}}=this,n=\"renderer\"in t&&t.renderer,l=\"orderBy\"in t&&t.orderBy,a=t.featureReduction,u=new Set,p=await o([n?n.collectRequiredFields(u,r):null,c(u,t),e?f(u,t):null,i(this.filter)?y(u,t,this.filter):null,this.effect?y(u,t,this.effect.filter):null,a?h(u,t,a):null,l?F(u,t,l):null]);if(t.timeInfo&&this.timeExtent&&w(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),\"feature\"===t.type&&t.floorInfo&&w(u,t.fieldsIndex,[t.floorInfo.floorField]),\"subtype-group\"===t.type){g(u,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(u,r),c(u,e)])}));await o(e)}for(const i of p)i.error&&_.error(i.error);g(u,r,s),e&&\"displayField\"in t&&t.displayField&&g(u,r,t.displayField);const d=Array.from(u).sort();this._set(\"requiredFields\",d)}validateFetchPopupFeatures(e){if(s(e))return null;for(const r of e.clientGraphics){const i=r.layer;if(\"popupEnabled\"in i&&!i.popupEnabled)return new t(\"featurelayerview:fetchPopupFeatures\",\"Popups are disabled\",{layer:i});if(\"popupTemplate\"in i){if(!q(i,e))return new t(\"featurelayerview:fetchPopupFeatures\",\"Layer does not define a popup template\",{layer:i})}}}async fetchClientPopupFeatures(e){const t=i(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],s=[],o=await this.createPopupQuery(e);for(const n of t){const{layer:t}=n;if(!(\"popupEnabled\"in t))continue;const l=m(this.layer.fieldsIndex,o.outFields),a=q(t,e);if(!i(a))continue;const u=await this._loadArcadeModules(a);u&&u.arcadeUtils.hasGeometryOperations(a)||!x(l,n)?s.push(n):r.push(n)}return\"stream\"===this.layer.type||0===s.length?Promise.resolve(r):(o.objectIds=s.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let s=!1;const o=i(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const n of o){if(!(\"popupEnabled\"in n))continue;const t=q(n,e);if(!i(t))continue;const o=await this._loadArcadeModules(t),l=o&&o.arcadeUtils.hasGeometryOperations(t);s=!(\"point\"!==this.layer.geometryType&&!l);const a=await I(this.layer,t);for(const e of a)r.add(e)}if(t.returnGeometry=s,t.returnZ=s,t.returnM=s,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,\"feature\"===this.layer.type){const e=R(this);i(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}canResume(){return!!super.canResume()&&(!i(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([a()],P.prototype,\"_updatingRequiredFieldsPromise\",void 0),e([a({readOnly:!0})],P.prototype,\"availableFields\",null),e([a({type:v})],P.prototype,\"effect\",void 0),e([a({type:j})],P.prototype,\"filter\",void 0),e([a(p)],P.prototype,\"timeExtent\",void 0),e([a()],P.prototype,\"layer\",void 0),e([a({type:Number})],P.prototype,\"maximumNumberOfFeatures\",null),e([a({readOnly:!0,type:Boolean})],P.prototype,\"maximumNumberOfFeaturesExceeded\",null),e([a({readOnly:!0})],P.prototype,\"requiredFields\",void 0),e([a()],P.prototype,\"suspended\",void 0),e([a()],P.prototype,\"view\",void 0),P=e([u(\"esri.views.layers.FeatureLayerView\")],P),P};export{P as FeatureLayerView,P as default};\n"],"names":["i","c","t","constructor","arguments","this","filter","includedEffect","excludedEffect","excludedLabelsVisible","clone","e","r","type","s","json","write","prototype","Boolean","o","l","_","getLogger","P","P2","e2","_updatingRequiredFieldsPromise","effect","timeExtent","layer","requiredFields","view","initialize","_handleRequiredFieldsChange","fieldsIndex","t2","r2","outFields","d","m","error","highlight","Error","createQuery","returnGeometry","outSpatialReference","spatialReference","b","e3","R","where","intersection","queryFeatures","queryObjectIds","queryFeatureCount","queryExtent","_loadArcadeModules","get","E","_updateRequiredFields","_set","then","objectIdField","s2","n2","renderer","l2","orderBy","a2","featureReduction","u","Set","p","collectRequiredFields","f","y","h","F","timeInfo","w","startField","endField","floorInfo","floorField","subtypeField","sublayers","map","t3","Promise","all","e4","i2","displayField","g","d2","Array","from","sort","validateFetchPopupFeatures","clientGraphics","popupEnabled","q","length","resolve","o2","createPopupQuery","arcadeUtils","hasGeometryOperations","x","push","objectIds","attributes","concat","features","catch","geometryType","I","add","returnZ","returnM","canResume","super","isEmpty","a","readOnly","v","j","Number"],"mappings":"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"}