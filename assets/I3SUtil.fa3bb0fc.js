import{gJ as e,gE as t,cn as n,gI as a,fg as r,jc as o,hU as s,cI as i,jd as l,K as c,je as u,B as f,M as h,z as p,bN as d,N as m,jf as y,jg as g,eQ as b,jh as w,ji as M,X as S,fN as x,gY as v,jj as j,jk as q,j3 as R,jl as T,fX as F,fD as k,jm as z,fd as I,jn as A,jo as W,g_ as C,jp as G,gw as K,hX as L,jq as E,hY as O,cq as P,fF as B,gD as U,jr as N,ff as X,fE as $,gF as D,js as Q,d9 as Y}from"./vendor.7103ff48.js";import{C as J}from"./I3SBinaryReader.da331753.js";function Z(n,a,r,o){const s=_(n,a,r),i=t();return e(r,s,i,o),i}function _(e,t,r){const o=n(),s=e[3],i=2**(4*Math.ceil(Math.log(s)*Math.LOG2E/4)+1);if(r.isGeographic){const t=i/a(r).radius*180/Math.PI,n=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,n*t)),l=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),c=Math.round(e[0]/l)*l;o[0]=c,o[1]=s}else{const t=Math.round(e[0]/i),n=Math.round(e[1]/i);o[0]=t*i,o[1]=n*i}const l=e[2]+t,c=Math.round(l/i);return o[2]=c*i,o}function H(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function V(e){if(c("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes.encoding)return!0;return!1}function ee(e,t,n,a,r,o){r.traverse(n,(n=>{let r=n.mbs;t!==a&&(r=oe,u(n.mbs,a,r,t));const s=function(e,t){const n=t[0],a=t[1],r=t[3],o=e[0]-n,s=n-e[2],i=e[1]-a,l=a-e[3],c=Math.max(o,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>r*r?0:f>0?1:-Math.max(o,s,i,l)>r?3:2}(e,r);return 0!==s&&(o(n,s),!0)}))}function te(e,t,n){let a=0,r=0;for(let o=0;o<t.length&&a<e.length;o++)e[a]===t[o]&&(n(o)&&(e[r]=e[a],r++),a++);e.length=r}function ne(e,t,n){let a=0,r=0;for(;a<n.length;)j(e,n[a])>=0===t&&(n[r]=n[a],r++),a++;n.length=r}const ae=r();function re(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return ae[0]=(e[0]-t.position[0])/t.rotationScale[0],ae[1]=(e[1]-t.position[1])/t.rotationScale[4],ae[2]=(e[2]-t.position[2])/t.rotationScale[8],ae[3]=(e[3]-t.position[0])/t.rotationScale[0],ae[4]=(e[4]-t.position[1])/t.rotationScale[4],ae[5]=(e[5]-t.position[2])/t.rotationScale[8],ae}const oe=N();function se(e,t){const n=t[0],a=t[1],r=t[2],o=t[3],s=e[0]-n,i=n-e[3],l=e[1]-a,c=a-e[4],u=e[2]-r,f=r-e[5],h=Math.max(s,i,0),p=Math.max(l,c,0),d=Math.max(u,f,0),m=h*h+p*p+d*d;return m>o*o?0:m>0?1:-Math.max(s,i,l,c,u,f)>o?3:2}function ie(e,t,n){const a=[],r=n&&n.missingFields,o=n&&n.originalFields;for(const s of e){const e=s.toLowerCase();let n=!1;for(const r of t)if(e===r.name.toLowerCase()){a.push(r.name),n=!0,o&&o.push(s);break}!n&&r&&r.push(s)}return a}async function le(e,t,n,a,r){if(0===t.length)return[];const o=e.attributeStorageInfo;if(f(e.associatedLayer))try{return await async function(e,t,n,a){t.sort(((e,t)=>e.attributes[n]-t.attributes[n]));const r=t.map((e=>e.attributes[n])),o=[],s=ie(a,e.fields,{originalFields:o}),i=await ce(e,r,s);for(let l=0;l<t.length;l++){const e=t[l],n=i[l],a={};if(e.attributes)for(const t in e.attributes)a[t]=e.attributes[t];for(let t=0;t<o.length;t++)a[o[t]]=n[s[t]];e.attributes=a}return t}(e.associatedLayer,t,n,a)}catch(s){if(e.associatedLayer.loaded)throw s}if(o){const s=function(e,t,n){const a=new Map,r=[],o=n();for(const s of e){const e=s.attributes[t];for(let t=0;t<o.length;t++){const n=o[t],i=n.featureIds.indexOf(e);if(i>=0){let e=a.get(n.node);e||(e={node:n.node,indices:[],graphics:[]},r.push(e),a.set(n.node,e)),e.indices.push(i),e.graphics.push(s);for(let n=t;n>0;n--)o[n]=o[n-1];o[0]=n;break}}}return r}(t,n,r);if(h(s))throw new p("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const i=e.parsedUrl.path,l=await Promise.all(s.map((e=>function(e,t,n,a,r){const o=[];for(const s of t)if(s&&-1!==r.indexOf(s.name)){const t=`${e}/nodes/${n.resources.attributes}/attributes/${s.key}/0`;o.push({url:t,storageInfo:s})}return d(o.map((e=>m(e.url,{responseType:"array-buffer"}).then((t=>J(e.storageInfo,t.data)))))).then((e=>{const t=[];for(const n of a){const a={};for(let t=0;t<e.length;t++)null!=e[t].value&&(a[o[t].storageInfo.name]=ue(e[t].value,n));t.push(a)}return t}))}(i,o,e.node,e.indices,a).then((t=>{for(let n=0;n<e.graphics.length;n++){const a=e.graphics[n],r=t[n];if(a.attributes)for(const e in a.attributes)e in r||(r[e]=a.attributes[e]);a.attributes=r}return e.graphics})))));return y(l)}throw new p("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function ce(e,t,n){const a=e.capabilities.query.maxRecordCount;if(null!=a&&t.length>a){const r=g(t,a);return Promise.all(r.map((t=>ce(e,t,n)))).then(y)}const r=new b({objectIds:t,outFields:n,orderByFields:[e.objectIdField]});return e.queryFeatures(r).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new p("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function ue(e,t){if(!e)return null;const n=e[t];return w(e)?-32768===n?null:n:M(e)?-2147483648===n?null:n:n!=n?null:n}function fe(e){const t=e.store.indexCRS||e.store.geographicCRS,n=void 0===t?e.store.indexWKT:void 0;if(n){if(!e.spatialReference)throw new p("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new p("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new S(H(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function he(e){const t=e.store.vertexCRS||e.store.projectedCRS,n=void 0===t?e.store.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new p("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new p("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new S(H(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function pe(e,t){return h(t)?"@null":t===v(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function de(e,t,n){if(!x(e,t))throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===n&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator}(e,t))throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function me(e,t,n){const a=fe(e),r=he(e);de(a,t,n),de(r,t,n)}function ye(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null!=e.geometryType&&"triangles"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new p("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function ge(e,t){me(e,t.spatialReference,t.viewingMode)}function be(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null==e.geometryType||"points"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new p("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function we(e,t){de(e.spatialReference,t.spatialReference,t.viewingMode)}function Me(e){return"mesh-3d"===e.type}function Se(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const n of t){if(!Me(n)||0===n.symbolLayers.length)return!0;for(const e of n.symbolLayers.items)if("fill"!==e.type||h(e.material)||h(e.material.color)||"replace"!==e.material.colorMixMode)return!0}return!1}const xe=o({color:[0,0,0,0],opacity:0});class ve{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function je(e){const t=new ve;let n=!1,a=!1;for(const r of e.symbolLayers.items)if("fill"===r.type&&r.enabled){const e=r.material,o=r.edges;if(f(e)&&!n){const a=e.color,o=q(e.colorMixMode);f(a)?t.material={color:[a.r/255,a.g/255,a.b/255],alpha:a.a,colorMixMode:o}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=r.castShadows,n=!0}f(o)&&!a&&(t.edgeMaterial=R(o,{}),a=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function qe(e,t){return(0|e)+(0|t)|0}function Re(t,n,r,o,s=0){o===v(o)?n.isGeographic?function(e,t,n,r){const o=a(n),s=1+Math.max(0,r)/(o.radius+e.center[2]);k(t.center,e.center[0],e.center[1],e.center[2]+r),F(t.center,n,0,t.center,v(n),0,1),z(t.quaternion,e.quaternion),L(Ce,e.quaternion),k(Oe,0,0,1),O(Oe,Oe,Ce),k(Oe,e.halfSize[0]*Math.abs(Oe[0]),e.halfSize[1]*Math.abs(Oe[1]),e.halfSize[2]*Math.abs(Oe[2])),P(Oe,Oe,o.inverseFlattening),B(t.halfSize,e.halfSize,Oe),P(t.halfSize,t.halfSize,s)}(t,r,n,s):function(t,n,a,r){G(t,Ge),k(n.center,t.center[0],t.center[1],t.center[2]+r),e(a,n.center,We,v(a)),k(n.center,We[12],We[13],We[14]);const o=2*Math.sqrt(1+We[0]+We[5]+We[10]);Ce[0]=(We[6]-We[9])/o,Ce[1]=(We[8]-We[2])/o,Ce[2]=(We[1]-We[4])/o,Ce[3]=.25*o,K(n.quaternion,Ce,t.quaternion),L(Ce,n.quaternion);let s=0,i=0,l=0;for(const e of Ge)e[2]+=r,F(e,a,0,e,v(a),0,1),E(Oe,e,n.center),O(Oe,Oe,Ce),s=Math.max(s,Math.abs(Oe[0])),i=Math.max(i,Math.abs(Oe[1])),l=Math.max(l,Math.abs(Oe[2]));k(n.halfSize,s,i,l)}(t,r,n,s):n.isWGS84&&(o.isWebMercator||T(o))?function(e,t,n,a,r){const o=A(Ie,t.quaternion);I(ze,t.center),ze[2]+=r;const s=v(n);F(ze,e,0,ze,s,0,1);for(let i=0;i<8;++i){for(let e=0;e<3;++e)ke[e]=t.halfSize[e]*(0!=(i&1<<e)?-1:1);for(let e=0;e<3;++e){let t=ze[e];for(let n=0;n<3;++n)t+=ke[n]*o[3*n+e];Te[3*i+e]=t}}F(Te,s,0,Te,n,0,8),W(Fe,a)}(n,t,o,r,s):t===r?(r.center[2]+=s,F(r.center,n,0,r.center,o,0,1)):(k(r.center,t.center[0],t.center[1],t.center[2]+s),F(r.center,n,0,r.center,o,0,1),z(r.quaternion,t.quaternion),I(r.halfSize,t.halfSize))}const Te=new Float64Array(24),Fe={data:Te,size:3},ke=n(),ze=n(),Ie=C();function Ae(e,t,n,a,r,o){if(!o||0===o.length||h(t))return null;const s=Z(e.mbs,r,n,t);let i;U(Be,s);let l=1/0,c=-1/0;const u=o=>{if("replace"!==o.type)return;const s=o.geometry;if(!s.hasZ)return;X(Ke);const u=s.spatialReference||a,h=s.rings.reduce(((e,n)=>n.reduce(((e,n)=>($(n,u,Oe,t),D(Oe,Oe,Be),Q(Ke,Oe),Math.min(Oe[2],e))),e)),1/0);(()=>{if(!i)if(i=Ge,X(Le),f(e.serviceObb)){Re(e.serviceObb,n,Ee,t,r),G(Ee,i);for(const e of i)D(e,e,Be),Q(Le,e)}else{const a=e.mbs,o=a[3];$(a,n,Oe,t),D(Oe,Oe,Be),Oe[2]+=r;for(let e=0;e<8;++e){const t=1&e?o:-o,n=2&e?o:-o,a=4&e?o:-o,r=i[e];I(r,[Oe[0]+t,Oe[1]+n,Oe[2]+a]),Q(Le,r)}}})(),Y(Le,Ke)&&(l=Math.min(l,h),c=Math.max(c,h))};if(o.forEach((e=>u(e))),l===1/0)return null;for(let f=0;f<8;++f)p=Pe.data,d=3*f,m=i[f],D(Oe,m,s),p[d+0]=Oe[0],p[d+1]=Oe[1],p[d+2]=Oe[2],d+=24,m[2]=l,D(Oe,m,s),p[d+0]=Oe[0],p[d+1]=Oe[1],p[d+2]=Oe[2],d+=24,m[2]=c,D(Oe,m,s),p[d+0]=Oe[0],p[d+1]=Oe[1],p[d+2]=Oe[2];var p,d,m;return W(Pe)}const We=t(),Ce=s(),Ge=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Ke=i(),Le=i(),Ee=l(),Oe=[0,0,0],Pe={data:new Array(72),size:3},Be=t();export{xe as A,qe as C,Se as F,je as I,Ae as Q,be as R,Re as U,V as Y,ee as _,Z as a,pe as b,le as c,ue as d,te as e,he as g,_ as h,ie as i,ge as j,we as k,re as o,se as s,ne as t,ye as v,de as w,me as x,fe as y};
//# sourceMappingURL=I3SUtil.fa3bb0fc.js.map
